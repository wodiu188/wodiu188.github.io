

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="安全框架,SpringSecurity">
  
    <meta name="description" content="同样不完整,图片缺失.简单介绍了部分springSecurity的原理">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringSecurity">
<meta property="og:url" content="http://example.com/2022/01/10/SpringSecurity/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="同样不完整,图片缺失.简单介绍了部分springSecurity的原理">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/.com//package_and_data/Book/JdReaderEBooks/jd_4657302ffcbc3/30712708_dir_img/OEBPS/Images/Figure-T21_111015.jpg">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211002195222829.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211002201040742.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211003122105142.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211003122321618.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211008095855652.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211008163428372.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211008170937801.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211009102918119.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211009150724088.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211011093037215.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211011165450240.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211011200219902.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211011200608279.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211012091022619.png">
<meta property="og:image" content="http://example.com/.com//package_and_data/Book/JdReaderEBooks/jd_4657302ffcbc3/30712708_dir_img/OEBPS/Images/Figure-T138_115736.jpg">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211012093313969.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211013152326388.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211013194636900.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211014102143194.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211014102537560.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211014152500985.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211014152627110.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211015151833725.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211015162454709.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211018095056097.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211018113008540.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211019145309554.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211020102553565.png">
<meta property="og:image" content="http://example.com/.com//Users/lll/AppData/Roaming/Typora/typora-user-images/image-20211026151827472.png">
<meta property="article:published_time" content="2022-01-10T06:42:16.000Z">
<meta property="article:modified_time" content="2023-07-31T08:31:57.091Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="SpringSecurity">
<meta property="article:tag" content="安全框架">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/.com//package_and_data/Book/JdReaderEBooks/jd_4657302ffcbc3/30712708_dir_img/OEBPS/Images/Figure-T21_111015.jpg">
  
  
  
  <title>SpringSecurity - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"↙","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":"UA-233159895-1","gtag":"G-XKM51WKGR7","tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"mPhovhHHyKg2LpAcQhS6tjAw-gzGzoHsz","app_key":"6W2dsSWjVfMOOkXrNbFWOSDN","server_url":"https://mphovhhh.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.google-analytics.com/analytics.js', function() {
          window.ga = window.ga || function() { (ga.q = ga.q || []).push(arguments) };
          ga.l = +new Date;
          ga('create', 'UA-233159895-1', 'auto');
          ga('send', 'pageview');
        });
      }
    </script>
  

  
    <!-- Google gtag.js -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.googletagmanager.com/gtag/js?id=G-XKM51WKGR7', function() {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-XKM51WKGR7');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="SpringSecurity"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-01-10 14:42" pubdate>
          2022年1月10日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          122k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          1017 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">SpringSecurity</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="SpringSecurity-learn"><a href="#SpringSecurity-learn" class="headerlink" title="SpringSecurity-learn"></a>SpringSecurity-learn</h1><p>springsecurity深入浅出–王松 2021年出版学习笔记</p>
<h1 id="SpringSecurity啦啦啦"><a href="#SpringSecurity啦啦啦" class="headerlink" title="SpringSecurity啦啦啦"></a>SpringSecurity啦啦啦</h1><h3 id="认证与授权"><a href="#认证与授权" class="headerlink" title="认证与授权"></a>认证与授权</h3><h4 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h4><p>用户的信息主要用Authentication来保存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Authentication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Principal</span>, Serializable &#123;<br>    Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities();<span class="hljs-comment">//获取权限</span><br><br>    Object <span class="hljs-title function_">getCredentials</span><span class="hljs-params">()</span>;<span class="hljs-comment">//获取用户凭证</span><br><br>    Object <span class="hljs-title function_">getDetails</span><span class="hljs-params">()</span>;<span class="hljs-comment">//携带参数</span><br><br>    Object <span class="hljs-title function_">getPrincipal</span><span class="hljs-params">()</span>;<span class="hljs-comment">//获取当前用户</span><br><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAuthenticated</span><span class="hljs-params">()</span>;<span class="hljs-comment">//是否认证成功</span><br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAuthenticated</span><span class="hljs-params">(<span class="hljs-type">boolean</span> var1)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当用户使用用户名／密码登录或使用Remember-me登录时，都会对应一个不同的Authentication实例</p>
<p>Spring Security中的认证工作主要由AuthenticationManager接口来负责</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationManager</span> &#123;<br>    Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication var1)</span> <span class="hljs-keyword">throws</span> AuthenticationException;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果返回Authentication代表认证成功</p>
<p>抛出异常则认证失败</p>
<p>返回null则不能断定</p>
<blockquote>
<p>AuthenticationManager最主要的实现类是ProviderManager,而他用来管理AuthenticationProvider,在这个类中有一个supports方法用来检测是否支持给定的Authentication类型。而Authentication有着众多的实现类，但不是每个项目都支持所以菜肴进行检测，例如有的项目需要短信认证登录认证</p>
</blockquote>
<p>ProviderManager具有一个可选的parent，如果所有的认证都失败就会调用parent进行认证</p>
<h4 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h4><p>认证结束后就进行授权了</p>
<p>两个关键的接口:</p>
<ul>
<li>AccessDecisionManager</li>
<li>AccessDecisionVoter</li>
</ul>
<p>AccessDecisionVoter是个投票器,检查用户是否具有该角色然后进行投票进行赞成,反对或者弃票</p>
<p>AccessDecisionManager则会根据投票结果来判断用户是否有权利访问,会对AccessDecisionVoter进行遍历访问</p>
<p>用户请求的资源所需要的角色会被封装成ConfigAttribute对象,角色名称都带有一个ROLE_前缀，投票器AccessDecisionVoter所做的事情，其实就是比较用户所具备的角色和请求某个资源所需的ConfigAttribute之间的关系。</p>
<h4 id="默认不做配置开启的过滤器"><a href="#默认不做配置开启的过滤器" class="headerlink" title="默认不做配置开启的过滤器"></a>默认不做配置开启的过滤器</h4><p>认证授权都是基于过滤器</p>
<p><img src="/.com//package_and_data\Book\JdReaderEBooks\jd_4657302ffcbc3\30712708_dir_img\OEBPS\Images\Figure-T21_111015.jpg" srcset="/img/loading.gif" lazyload alt="Figure-T21_111015"></p>
<p>@Order注解去调整自定义过滤器在过滤器链中的位置。</p>
<p>默认过滤器并不是直接放在Web项目的原生过滤器链中，而是通过一个FilterChainProxy来统一管理,不仅仅只有一个，可能会有多个,FilterChainProxy通过DelegatingFilterProxy整合到原生过滤器链中</p>
<p>Spring Security会将登录成功的用户信息保存到SecurityContextHolder中</p>
<h3 id="基本的过滤配置"><a href="#基本的过滤配置" class="headerlink" title="基本的过滤配置"></a>基本的过滤配置</h3><p>基本所有的配置类都需要继承WebSecurityConfigurerAdapter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yh.code.springcode.Config;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<br><span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//.anyRequest().authenticated()代表所有请求认证后才能访问</span><br>        http.authorizeRequests().anyRequest().authenticated()<br>                <span class="hljs-comment">//and代表将将原来的http返回</span><br>                .and()<br>                <span class="hljs-comment">//开启表单配置</span><br>                .formLogin()<br>                <span class="hljs-comment">//设置登录页</span><br>                .loginPage(<span class="hljs-string">&quot;/index.html&quot;</span>)<br>                <span class="hljs-comment">//设置认证地址</span><br>                .loginProcessingUrl(<span class="hljs-string">&quot;/doLogin&quot;</span>)<br>                <span class="hljs-comment">//成功跳转</span><br>                .defaultSuccessUrl(<span class="hljs-string">&quot;/index&quot;</span>)<br>                <span class="hljs-comment">//失败跳转</span><br>                .failureUrl(<span class="hljs-string">&quot;/index.html&quot;</span>)<br>                <span class="hljs-comment">//接收前端表单的用户名</span><br>                .usernameParameter(<span class="hljs-string">&quot;uname&quot;</span>)<br>                <span class="hljs-comment">//接收前端表单的密码</span><br>                .passwordParameter(<span class="hljs-string">&quot;passwd&quot;</span>)<br>                <span class="hljs-comment">//代表跟登录相关的接口认证不做拦截</span><br>                .permitAll()<br>                <span class="hljs-comment">//表单配置完毕后进行返回</span><br>                .and()<br>                <span class="hljs-comment">//进行csrf配置</span><br>                .csrf()<br>                <span class="hljs-comment">//关闭csrf防御功能</span><br>                .disable();<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="defaultSuccessUrl与successForwardUrl"><a href="#defaultSuccessUrl与successForwardUrl" class="headerlink" title="defaultSuccessUrl与successForwardUrl"></a>defaultSuccessUrl与successForwardUrl</h4><ul>
<li><p>successForwardUrl:</p>
<ul>
<li><p>用户验证成功后强行跳转到该方法设置的页面</p>
</li>
<li><blockquote>
<p>例如请求&#x2F;user,successForwardUrl设置为&#x2F;index</p>
<p>用户验证成功后跳向&#x2F;index</p>
</blockquote>
</li>
</ul>
</li>
<li><p>defaultSuccessUrl:</p>
<ul>
<li><p>用户验证成功后如果有自己请求的地址则调向请求地址,如果没有则跳向请求地址</p>
</li>
<li><blockquote>
<p>例如请求&#x2F;user,defaultSuccessUrl设置为&#x2F;index</p>
<p>用户验证成功后跳向&#x2F;user</p>
</blockquote>
</li>
<li><p>源码实际就是创建了一个SavedRequestAwareAuthenticationSuccessHandler</p>
</li>
<li><p>&#96;&#96;&#96;java<br>public final T defaultSuccessUrl(String defaultSuccessUrl, boolean alwaysUse) {<br>    SavedRequestAwareAuthenticationSuccessHandler handler &#x3D; new SavedRequestAwareAuthenticationSuccessHandler();<br>    handler.setDefaultTargetUrl(defaultSuccessUrl);<br>    handler.setAlwaysUseDefaultTargetUrl(alwaysUse);<br>    this.defaultSuccessHandler &#x3D; handler;<br>    return this.successHandler(handler);<br>}</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><br><br><br><br><br>这两个配置的都是AuthenticationSuccessHandler接口的实例并且该接口才是security用来处理登录成功的事项<br><br>其中AuthenticationSuccessHandler有两个方法一个是在处理特定的认证请求Authentication Filter中会用到;另一个用来进行处理登录成功的.<br><br>前两个参数很常见,而Authentication则用来传递登陆成功的用户信息<br><br>```java<br>public interface AuthenticationSuccessHandler &#123;<br>    default void on<span class="hljs-constructor">AuthenticationSuccess(HttpServletRequest <span class="hljs-params">request</span>, HttpServletResponse <span class="hljs-params">response</span>, FilterChain <span class="hljs-params">chain</span>, Authentication <span class="hljs-params">authentication</span>)</span> throws IOException, ServletException &#123;<br>        this.on<span class="hljs-constructor">AuthenticationSuccess(<span class="hljs-params">request</span>, <span class="hljs-params">response</span>, <span class="hljs-params">authentication</span>)</span>;<br>        chain.<span class="hljs-keyword">do</span><span class="hljs-constructor">Filter(<span class="hljs-params">request</span>, <span class="hljs-params">response</span>)</span>;<br>    &#125;<br><br>    void on<span class="hljs-constructor">AuthenticationSuccess(HttpServletRequest <span class="hljs-params">var1</span>, HttpServletResponse <span class="hljs-params">var2</span>, Authentication <span class="hljs-params">var3</span>)</span> throws IOException, ServletException;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>AuthenticationSuccessHandler有三个实现类</p>
<ul>
<li>SimpleUrlAuthenticationSuccessHandler:通过handle方法实现请求重定向</li>
<li>SavedRequestAwareAuthenticationSuccessHandler:在SimpleUrlAuthenticationSuccess Handler的基础上增加了请求缓存的功能，可以记录之前请求的地址，进而在登录成功后重定向到一开始访问的地址。</li>
<li>ForwardAuthenticationSuccessHandler:的实现则比较容易，就是一个服务端跳转。</li>
</ul>
<p>请求失败和请求成功差不多</p>
<h4 id="注销"><a href="#注销" class="headerlink" title="注销"></a>注销</h4><p>注销需要使用注销类所以要使用and()进行切换</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>   <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>       <span class="hljs-comment">//.anyRequest().authenticated()代表所有请求认证后才能访问</span><br>       http.authorizeRequests()<br>            <br>               .and()<br>               <span class="hljs-comment">//开启表单配置</span><br>               .formLogin()<br>             <br>               .and()<br>               .logout()<br>               .logoutUrl(<span class="hljs-string">&quot;/logout&quot;</span>)<br>               <span class="hljs-comment">//是否清除认证</span><br>               .clearAuthentication(<span class="hljs-literal">true</span>)<br>               <span class="hljs-comment">//是否注销session</span><br>               .invalidateHttpSession(<span class="hljs-literal">true</span>)<br>               .logoutSuccessUrl(<span class="hljs-string">&quot;/mylogin&quot;</span>)<br>               <span class="hljs-comment">//表单配置完毕后进行返回</span><br>           	.logoutRequestMatcher(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrRequestMatcher</span>(<br>                       <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">&quot;/logout1&quot;</span>,<span class="hljs-string">&quot;GET&quot;</span>),<br>                       <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">&quot;/logout3&quot;</span>,<span class="hljs-string">&quot;POST&quot;</span>)<br>               ))<br>           <br>               .and()<br>               <span class="hljs-comment">//进行csrf配置</span><br>               .csrf()<br>               <span class="hljs-comment">//关闭csrf防御功能</span><br>               .disable();<br><br>   &#125;<br></code></pre></td></tr></table></figure>

<p>可以指定多个登出路径并且可以设置请求方法</p>
<p>如果使用的是前后分离则可以自定义.logoutSuccessHandler()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">.logoutSuccessHandler(( req,resp,auth)-&gt;&#123;<br>             resp.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);<br>             Map&lt;String, Object&gt; respH = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>             respH.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">200</span>);<br>             respH.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;登出成功!&quot;</span>);<br>             <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">om</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>             <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> om.writeValueAsString(resp);<br>             resp.getWriter().write(s);<br>         &#125;)<br>    <br>         .defaultLogoutSuccessHandlerFor(( req,resp,auth)-&gt;&#123;<br>             resp.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);<br>             Map&lt;String, Object&gt; respH = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>             respH.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">200</span>);<br>             respH.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;登出成功!&quot;</span>);<br>             <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">om</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>             <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> om.writeValueAsString(resp);<br>             resp.getWriter().write(s);<br>         &#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">&quot;/logout3&quot;</span>,<span class="hljs-string">&quot;POST&quot;</span>))<br></code></pre></td></tr></table></figure>

<p>有这两个方法进行自定义一个是设置登出地址的另一个是设置默认的</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><blockquote>
<p>用户的登录成功或失败,注销都差不多</p>
<p>都可以设置页面只不过登录的表单与注销的表单之间需要用and来切换</p>
<p>都可以自定义handle(使用lamda表达式更简单)</p>
</blockquote>
<h3 id="登录的用户数据获取"><a href="#登录的用户数据获取" class="headerlink" title="登录的用户数据获取"></a>登录的用户数据获取</h3><h4 id="第一种数据获取方式"><a href="#第一种数据获取方式" class="headerlink" title="第一种数据获取方式"></a>第一种数据获取方式</h4><p>使用了security后会对httpSession数据进行封装所以我们想要获取用户数据可以获取</p>
<ul>
<li>SecurityContextHolder</li>
<li>HttpSession</li>
</ul>
<p>但是这两个方法都要用到<a href="#%E8%AE%A4%E8%AF%81">认证类Authentication</a></p>
<p>该类有四个信息</p>
<blockquote>
<p>（1）principal：定义认证的用户。如果用户使用用户名／密码的方式登录，principal通常就是一个UserDetails对象。<br>（2）credentials：登录凭证，一般就是指密码。当用户登录成功之后，登录凭证会被自动擦除，以防止泄漏。<br>（3）authorities：用户被授予的权限信息。<br>（4）isAuthenticated()：是否认证</p>
</blockquote>
<p>Authentication有很多实现类</p>
<blockquote>
<p>UsernamePasswordAuthenticationToken</p>
<p>JaasAuthenticationToken</p>
<p>TestingAuthenticationToken</p>
<p>PreAuthenticatedAuthenticationToken</p>
<p>RememberMeAuthenticationToken</p>
<p>RunAsUserToken</p>
<p>等认证最常用的是UsernamePasswordAuthenticationToken和RememberMeAuthenticationToken</p>
</blockquote>
<p>emmmm上面这么多认证我们要用的时候要怎么取呢&lt;-_-&gt;:dog:看下面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/hello2&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello2</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">//获取当前用户信息</span><br>    <span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> SecurityContextHolder.getContext().getAuthentication();<br>    <br>    <span class="hljs-comment">//获取角色</span><br>    Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; authorities =<br>            authentication.getAuthorities();<br>    System.out.println(<span class="hljs-string">&quot;authorities&quot;</span> + authorities);<br>    <br>    <span class="hljs-comment">//获取用户名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> authentication.getName();<br>    System.out.println(name);<br>    <span class="hljs-keyword">return</span> name;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>从上面可以看出通过SecurityContextHolder的静态方法就可以获取对象了,那为啥能获取呢?</p>
<h5 id="SecurityContextHolder的三种数据存储模式"><a href="#SecurityContextHolder的三种数据存储模式" class="headerlink" title="SecurityContextHolder的三种数据存储模式"></a>SecurityContextHolder的三种数据存储模式</h5><p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211002195222829.png" srcset="/img/loading.gif" lazyload alt="image-20211002195222829"></p>
<p>根据图可以看出SecurityContextHolder中的内容</p>
<p>SecurityContextHolder的三种数据存储模式:</p>
<ul>
<li>MODE_THREADLOCAL:将SecurityContext存到ThreadLocal(那个线程存进去的那个线程才能取,所以一个请求无论经过多少filter和servlet都是一个线程处理的)这种方法如果用子线程取就会取不到,&#x3D;&#x3D;默认的&#x3D;&#x3D;</li>
<li>MODE_INHERITABLETHREADLOCAL：这种存储模式适用于多线程环境，如果希望在&#x3D;&#x3D;子线程中也能够获取到登录用户数据&#x3D;&#x3D;，那么可以使用这种存储模式。</li>
<li>MODE_GLOBAL：这种存储模式实际上是将数据保存在一个静态变量中，在Java Web开发中，这种模式很少使用到。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecurityContextHolderStrategy</span> &#123;<br>    <span class="hljs-comment">//清理SecurityContext对象。</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearContext</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">//获取SecurityContext对象。</span><br>    SecurityContext <span class="hljs-title function_">getContext</span><span class="hljs-params">()</span>;<br>    <span class="hljs-comment">//设置SecurityContext对象。</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContext</span><span class="hljs-params">(SecurityContext context)</span>;<br>    <span class="hljs-comment">//创建一个空的SecurityContext对象。</span><br>    SecurityContext <span class="hljs-title function_">createEmptyContext</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>莫名奇妙给你个这个接口你一定莫名奇妙:dog:,其实这个接口有三个实现类这三个实现类就对应着上面三种模式</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211002201040742.png" srcset="/img/loading.gif" lazyload alt="image-20211002201040742"></p>
<p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocalSecurityContextHolderStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityContextHolderStrategy</span> &#123;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;SecurityContext&gt; contextHolder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearContext</span><span class="hljs-params">()</span> &#123;<br>		contextHolder.remove();<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> SecurityContext <span class="hljs-title function_">getContext</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-type">SecurityContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> contextHolder.get();<br>		<span class="hljs-keyword">if</span> (ctx == <span class="hljs-literal">null</span>) &#123;<br>			ctx = createEmptyContext();<br>			contextHolder.set(ctx);<br>		&#125;<br>		<span class="hljs-keyword">return</span> ctx;<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContext</span><span class="hljs-params">(SecurityContext context)</span> &#123;<br>		Assert.notNull(context, <span class="hljs-string">&quot;Only non-null SecurityContext instances are permitted&quot;</span>);<br>		contextHolder.set(context);<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> SecurityContext <span class="hljs-title function_">createEmptyContext</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityContextImpl</span>();<br>	&#125;<br><br>&#125;<br><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InheritableThreadLocalSecurityContextHolderStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityContextHolderStrategy</span> &#123;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;SecurityContext&gt; contextHolder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocal</span>&lt;&gt;();<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearContext</span><span class="hljs-params">()</span> &#123;<br>		contextHolder.remove();<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> SecurityContext <span class="hljs-title function_">getContext</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-type">SecurityContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> contextHolder.get();<br>		<span class="hljs-keyword">if</span> (ctx == <span class="hljs-literal">null</span>) &#123;<br>			ctx = createEmptyContext();<br>			contextHolder.set(ctx);<br>		&#125;<br>		<span class="hljs-keyword">return</span> ctx;<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContext</span><span class="hljs-params">(SecurityContext context)</span> &#123;<br>		Assert.notNull(context, <span class="hljs-string">&quot;Only non-null SecurityContext instances are permitted&quot;</span>);<br>		contextHolder.set(context);<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> SecurityContext <span class="hljs-title function_">createEmptyContext</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityContextImpl</span>();<br>	&#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>从ThreadLocalSecurityContextHolderStrategy该源码可知new ThreadLocal&lt;&gt;();</p>
<p>而InheritableThreadLocalSecurityContextHolderStrategy的源码可知 new InheritableThreadLocal&lt;&gt;();</p>
<p>其他基本都是一样的,InheritableThreadLocal对比ThreadLocal的最大特点是&#x3D;&#x3D;子线程创建的时候会将父线程的数据复制到子线程&#x3D;&#x3D;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalSecurityContextHolderStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityContextHolderStrategy</span> &#123;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SecurityContext contextHolder;<br><br></code></pre></td></tr></table></figure>

<p>对于GlobalSecurityContextHolderStrategy只是一个普通的static类</p>
<h5 id="SecurityContextHolder"><a href="#SecurityContextHolder" class="headerlink" title="SecurityContextHolder"></a>SecurityContextHolder</h5><p>聊完了三种模式我们再回头看看SecurityContextHolder这个可以获取用户数据的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityContextHolder</span> &#123;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MODE_THREADLOCAL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MODE_THREADLOCAL&quot;</span>;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MODE_INHERITABLETHREADLOCAL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MODE_INHERITABLETHREADLOCAL&quot;</span>;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MODE_GLOBAL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MODE_GLOBAL&quot;</span>;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SYSTEM_PROPERTY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;spring.security.strategy&quot;</span>;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">strategyName</span> <span class="hljs-operator">=</span> System.getProperty(SYSTEM_PROPERTY);<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SecurityContextHolderStrategy strategy;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">initializeCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">if</span> (!StringUtils.hasText(strategyName)) &#123;<br>			<span class="hljs-comment">// Set default</span><br>			strategyName = MODE_THREADLOCAL;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (strategyName.equals(MODE_THREADLOCAL)) &#123;<br>			strategy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalSecurityContextHolderStrategy</span>();<br>		&#125;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (strategyName.equals(MODE_INHERITABLETHREADLOCAL)) &#123;<br>			strategy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocalSecurityContextHolderStrategy</span>();<br>		&#125;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (strategyName.equals(MODE_GLOBAL)) &#123;<br>			strategy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalSecurityContextHolderStrategy</span>();<br>		&#125;<br>		<span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">// Try to load a custom strategy</span><br>			<span class="hljs-keyword">try</span> &#123;<br>				Class&lt;?&gt; clazz = Class.forName(strategyName);<br>				Constructor&lt;?&gt; customStrategy = clazz.getConstructor();<br>				strategy = (SecurityContextHolderStrategy) customStrategy.newInstance();<br>			&#125;<br>			<span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>				ReflectionUtils.handleReflectionException(ex);<br>			&#125;<br>		&#125;<br>		initializeCount++;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到上面三个常量代表的就是三个模式,第四个变量代表从配置文件如何获取配置</p>
<p>第五个才是确定要用的模式,可以看出默认是从配置文件中获取的</p>
<p>我们不同的请求是通过不同的线程处理的那为啥那为什么每一次请求都还能从SecurityContextHolder中获取到登录用户信息呢？</p>
<p>这就得看:SecurityContextPersistenceFilter的了</p>
<h5 id="SecurityContextPersistenceFilter"><a href="#SecurityContextPersistenceFilter" class="headerlink" title="SecurityContextPersistenceFilter"></a>SecurityContextPersistenceFilter</h5><p>这个实例主要做两个事情:</p>
<blockquote>
<p>（1）当一个请求到来时，从HttpSession中获取SecurityContext并存入SecurityContext Holder中，这样在同一个请求的后续处理过程中，开发者始终可以通过SecurityContextHolder获取到当前登录用户信息。<br>（2）当一个请求处理完毕时，从SecurityContextHolder中获取SecurityContext并存入HttpSession中（主要针对异步Servlet），方便下一个请求到来时，再从HttpSession中拿出来使用，同时擦除SecurityContextHolder中的登录用户信息。</p>
</blockquote>
<p>而上面这两个事情是由SecurityContextPersistence来做的</p>
<p>SecurityContextRepository:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecurityContextRepository</span> &#123;<br>    <span class="hljs-comment">//这个方法用来加载SecurityContext对象出来，对于没有登录的用户，这里会返回一个空的SecurityContext对象，注意空的SecurityContext对象是指SecurityContext中不存在Authentication对象，而不是该方法返回null。</span><br>    SecurityContext <span class="hljs-title function_">loadContext</span><span class="hljs-params">(HttpRequestResponseHolder var1)</span>;<br><br>    <span class="hljs-comment">//该方法用来保存一个SecurityContext对象。</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveContext</span><span class="hljs-params">(SecurityContext var1, HttpServletRequest var2, HttpServletResponse var3)</span>;<br><br>    <span class="hljs-comment">//该方法可以判断SecurityContext对象是否存在。</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsContext</span><span class="hljs-params">(HttpServletRequest var1)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>而该接口有三个实现类:</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211003122105142.png" srcset="/img/loading.gif" lazyload alt="image-20211003122105142"></p>
<p>NullSecurityContextRepository对数据的操作没有任何实现</p>
<p>TestSecurityContextRepository用于单元测试</p>
<p>HttpSeesionSecurityContextRepository默认的其中实现类数据的存储与读取</p>
<p>在HttpSeesionSecurityContextRepository中定义了SaveToSessionRequestWrapper与SaveToSessionResponseWrapper</p>
<h6 id="首先来看SaveToSessionResponseWrapper"><a href="#首先来看SaveToSessionResponseWrapper" class="headerlink" title="首先来看SaveToSessionResponseWrapper:"></a>首先来看SaveToSessionResponseWrapper:</h6><p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211003122321618.png" srcset="/img/loading.gif" lazyload alt="image-20211003122321618"></p>
<p>从上图可知该类实现了HttpServletResponse并且还继承了三个类:</p>
<ul>
<li>HttpServletResponseWrapper:利用该类可以方便地操作参数和输出流等。</li>
<li>OnCommittedResponseWrapper:对上面的类进行了增强,最重要的增强在于可以获取HttpServletResponse的提交行为。不过onResponseCommitted方法只是一个抽象方法</li>
<li>SaveContextOnUpdateOrErrorResponseWrapper:该类实现了onResponseCommitted方法,但是定义了一个saveContext的抽象方法用来获取SecurityContext,只有是否存储成功用声明的contextSaved变量，表示SecuirtyContext是否已经存储成功。</li>
</ul>
<p>回到SaveToSessionResponseWrapper该类继承SaveContextOnUpdateOrErrorResponseWrapper并实现了saveContext这个抽象方法,除了这个还有该类定义的另两个方法,下面呈现主要的三个定义方法:</p>
<ul>
<li>saveContext:&#x3D;&#x3D;该方法主要是用来保存SecurityContext，&#x3D;&#x3D;如果authentication对象为null或者它是一个匿名对象，则不需要保存SecurityContext（参见SEC-776：<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-security/issues/1036%EF%BC%89%EF%BC%9B%E5%90%8C%E6%97%B6%EF%BC%8C%E5%A6%82%E6%9E%9C==httpSession%E4%B8%8D%E4%B8%BAnull%E5%B9%B6%E4%B8%94authBefore">https://github.com/spring-projects/spring-security/issues/1036）；同时，如果==httpSession不为null并且authBefore</a> Execution也不为null，就从httpSession中将保存的登录用户数据移除，这个主要是为了防止开发者在注销成功的回调中继续调用chain.doFilter方法，进而导致原始的登录信息无法清除的问题&#x3D;&#x3D;（参见SEC-1587：<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-security/issues/1826%EF%BC%89%EF%BC%9B%E5%A6%82%E6%9E%9ChttpSession%E4%B8%BAnull%EF%BC%8C%E5%88%99%E5%8E%BB%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAHttpSession%E5%AF%B9%E8%B1%A1%EF%BC%9B%E6%9C%80%E5%90%8E%EF%BC%8C%E5%A6%82%E6%9E%9CSecurityContext%E5%8F%91%E7%94%9F%E4%BA%86%E5%8F%98%E5%8C%96%EF%BC%8C%E6%88%96%E8%80%85httpSession%E4%B8%AD%E6%B2%A1%E6%9C%89%E4%BF%9D%E5%AD%98SecurityContext%EF%BC%8C%E5%88%99%E8%B0%83%E7%94%A8httpSession%E4%B8%AD%E7%9A%84setAttribute%E6%96%B9%E6%B3%95%E5%B0%86SecurityContext%E4%BF%9D%E5%AD%98%E8%B5%B7%E6%9D%A5%E3%80%82">https://github.com/spring-projects/spring-security/issues/1826）；如果httpSession为null，则去创建一个HttpSession对象；最后，如果SecurityContext发生了变化，或者httpSession中没有保存SecurityContext，则调用httpSession中的setAttribute方法将SecurityContext保存起来。</a></li>
<li>contextChanged：该方法主要用来判断SecurityContext是否发生变化</li>
<li>createNewSessionIfAllowed：该方法用来创建一个HttpSession对象。</li>
</ul>
<p>SaveToSessionRequestWrapper类这个可比上面这个简单多了</p>
<h6 id="SaveToSessionRequestWrapper"><a href="#SaveToSessionRequestWrapper" class="headerlink" title="SaveToSessionRequestWrapper"></a>SaveToSessionRequestWrapper</h6><p>封装的SaveToSession RequestWrapper类主要作用是禁止在异步Servlet提交时，自动保存SecurityContext。</p>
<p>为啥要禁止呢?还记得前面讲的子线程无法从TreadLocal中获取父线程的SecurityContext吗,所以当异步保存时会报错.</p>
<p>所以SaveToSessionRequestWrapper会将自动保存禁止掉所以这一功能在SecurityContextPersistenceFilter过滤器中完成SecurityContext保存操作。</p>
<h6 id="HttpSeesionSecurityContextRepository"><a href="#HttpSeesionSecurityContextRepository" class="headerlink" title="HttpSeesionSecurityContextRepository"></a>HttpSeesionSecurityContextRepository</h6><p>聊完该类里面定义的两个类来聊聊这个大类</p>
<p>首先时开头几个定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//定义了SecurityContext在HttpSession中存储的key</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SPRING_SECURITY_CONTEXT_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SPRING_SECURITY_CONTEXT&quot;</span>;<br><br>   <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(<span class="hljs-built_in">this</span>.getClass());<br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">contextObject</span> <span class="hljs-operator">=</span> SecurityContextHolder.createEmptyContext();<br><span class="hljs-comment">//allowSessionCreation用来设置是否允许创建HttpSession，默认是true。</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">allowSessionCreation</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br><span class="hljs-comment">//disableUrlRewriting表示是否禁用URL重写，默认是false。</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">disableUrlRewriting</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br><span class="hljs-comment">//springSecurityContextKey可以用来配置HttpSession中存储SecurityContext的key</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">springSecurityContextKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SPRING_SECURITY_CONTEXT&quot;</span>;<br><br><span class="hljs-comment">//用来获取是rememberMe认证还是匿名用户</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">AuthenticationTrustResolver</span> <span class="hljs-variable">trustResolver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthenticationTrustResolverImpl</span>();<br><br><span class="hljs-comment">//获取SecurityContext,如果发现为空则创建一个并保存在HttpRequestResponseHolder对象中</span><br>	<span class="hljs-keyword">public</span> SecurityContext <span class="hljs-title function_">loadContext</span><span class="hljs-params">(HttpRequestResponseHolder requestResponseHolder)</span>&#123;...&#125;;<br><br><span class="hljs-comment">//用来保存SecurityContext,正常情况下在HttpServletResponse提交时就会被保存但是异步就由该方法保存</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveContext</span><span class="hljs-params">(SecurityContext context, HttpServletRequest request, HttpServletResponse response)</span> &#123;...&#125;;<br><span class="hljs-comment">//用来判断当前请求中是否存在SecurityContext</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsContext</span><span class="hljs-params">(HttpServletRequest request)</span>&#123;...&#125;;<br><br><span class="hljs-comment">//实现了如果从HttpSession中读取并存储为SecurityContext后返回,loadContext方法就调用了该方法</span><br>   <span class="hljs-keyword">private</span> SecurityContext <span class="hljs-title function_">readSecurityContextFromSession</span><span class="hljs-params">(HttpSession httpSession)</span>&#123;...&#125;;<br><br><span class="hljs-comment">//该方法用来生成一个不包含Authentication的空的SecurityContext对象,loadContext方法就调用了该方法</span><br><span class="hljs-keyword">protected</span> SecurityContext <span class="hljs-title function_">generateNewContext</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-keyword">return</span> SecurityContextHolder.createEmptyContext();<br>   &#125;<br><br><span class="hljs-comment">//判断当前Authentication是否免于存储。</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTransientAuthentication</span><span class="hljs-params">(Authentication authentication)</span><br>       <br><span class="hljs-comment">//    setTrustResolver方法用来配置身份评估器。</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTrustResolver</span><span class="hljs-params">(AuthenticationTrustResolver trustResolver)</span><br></code></pre></td></tr></table></figure>



<p>解决完HttpSeesionSecurityContextRepository就可以回到主体：</p>
<p>doFilter()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>       <span class="hljs-keyword">if</span> (request.getAttribute(<span class="hljs-string">&quot;__spring_security_scpf_applied&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>           chain.doFilter(request, response);<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           request.setAttribute(<span class="hljs-string">&quot;__spring_security_scpf_applied&quot;</span>, Boolean.TRUE);<br>           <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.forceEagerSessionCreation) &#123;<br>               <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> request.getSession();<br>               <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isDebugEnabled() &amp;&amp; session.isNew()) &#123;<br>                   <span class="hljs-built_in">this</span>.logger.debug(LogMessage.format(<span class="hljs-string">&quot;Created session %s eagerly&quot;</span>, session.getId()));<br>               &#125;<br>           &#125;<br><br>           <span class="hljs-type">HttpRequestResponseHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpRequestResponseHolder</span>(request, response);<br>           <span class="hljs-type">SecurityContext</span> <span class="hljs-variable">contextBeforeChainExecution</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.repo.loadContext(holder);<br>           <span class="hljs-type">boolean</span> <span class="hljs-variable">var10</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>           <span class="hljs-keyword">try</span> &#123;<br>               var10 = <span class="hljs-literal">true</span>;<br>               SecurityContextHolder.setContext(contextBeforeChainExecution);<br>               <span class="hljs-keyword">if</span> (contextBeforeChainExecution.getAuthentication() == <span class="hljs-literal">null</span>) &#123;<br>                   <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Set SecurityContextHolder to empty SecurityContext&quot;</span>);<br>               &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isDebugEnabled()) &#123;<br>                   <span class="hljs-built_in">this</span>.logger.debug(LogMessage.format(<span class="hljs-string">&quot;Set SecurityContextHolder to %s&quot;</span>, contextBeforeChainExecution));<br>               &#125;<br><br>               chain.doFilter(holder.getRequest(), holder.getResponse());<br>               var10 = <span class="hljs-literal">false</span>;<br>           &#125; <span class="hljs-keyword">finally</span> &#123;<br>               <span class="hljs-keyword">if</span> (var10) &#123;<br>                   <span class="hljs-type">SecurityContext</span> <span class="hljs-variable">contextAfterChainExecution</span> <span class="hljs-operator">=</span> SecurityContextHolder.getContext();<br>                   SecurityContextHolder.clearContext();<br>                   <span class="hljs-built_in">this</span>.repo.saveContext(contextAfterChainExecution, holder.getRequest(), holder.getResponse());<br>                   request.removeAttribute(<span class="hljs-string">&quot;__spring_security_scpf_applied&quot;</span>);<br>                   <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Cleared SecurityContextHolder to complete request&quot;</span>);<br>               &#125;<br>           &#125;<br><br>           <span class="hljs-type">SecurityContext</span> <span class="hljs-variable">contextAfterChainExecution</span> <span class="hljs-operator">=</span> SecurityContextHolder.getContext();<br>           SecurityContextHolder.clearContext();<br>           <span class="hljs-built_in">this</span>.repo.saveContext(contextAfterChainExecution, holder.getRequest(), holder.getResponse());<br>           request.removeAttribute(<span class="hljs-string">&quot;__spring_security_scpf_applied&quot;</span>);<br>           <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Cleared SecurityContextHolder to complete request&quot;</span>);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<ol>
<li>首先从request中取出变量如果不是空就继续执行后面的,这里应该是防止异步</li>
<li>接下来对上面提到的那个变量设置为true之后判断forceEagerSessionCreation默认为false如果为true则要进行确会话有效操作,但是比较耗费资源</li>
<li>使用构造方法来构造出<a href="#SecurityContextHolder">HttpRequestResponseHolder</a>并将request和response存进去</li>
<li>然后加载一个SecurityContext并存入刚刚构造的HttpRequestResponseHolder实例里面</li>
<li>判断是否为匿名用户或无效用户</li>
<li>finally的作用是如果没有正常保存则进行保存</li>
<li>最后进行清空操作</li>
</ol>
<h4 id="第二种数据获取方式"><a href="#第二种数据获取方式" class="headerlink" title="第二种数据获取方式"></a>第二种数据获取方式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/authentication&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">authentication</span><span class="hljs-params">(Authentication authentication)</span> &#123;<br>     System.out.println(<span class="hljs-string">&quot;authentication = &quot;</span> + authentication);<br>  &#125;<br>  <span class="hljs-meta">@RequestMapping(&quot;/principal&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">principal</span><span class="hljs-params">(Principal principal)</span> &#123;<br>     System.out.println(<span class="hljs-string">&quot;principal = &quot;</span> + principal);<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>经过验证上面两个的结果一样但是这些数据和springMVC一样都是由HttpServletRequest来提供的</p>
<p>一个普通的web项目不使用任何框架，请求是由tomcat提供RequestFacade来填充HttpServletRequest，由名字可以看出使用的是外观模式（Facade）这样防止使用者直接调用Tomcat的内部方法，但是如果使用了springSecurity则提供SecurityContextHolderAwareRequestWrapper来进行填充</p>
<blockquote>
<p>principal和authentication的数据都是由HttpServletRequest带来的,而在</p>
<p>不用框架则是RequestFacade实现</p>
<p>使用了springsecurity则是由Servlet3SecurityContextHolderAwareRequestWrapper来实现的并且实现类servlet3.0规范</p>
<p>他的上层实现了servlet3.0之前的规范</p>
<p>(讲道理我观察到的HttpServletRequest是SecurityContextHolderAwareRequestWrapper即该层实现了servlet3.0之前的规范)</p>
</blockquote>
<p>并且我们观察SecurityContextHolderAwareRequestWrapper类</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211008095855652.png" srcset="/img/loading.gif" lazyload alt="image-20211008095855652"></p>
<ul>
<li><p>getAuthentication():获取Authentication对象,和SpringContextHolder中获取的一样</p>
</li>
<li><p>getRemoteUser():获取用户名</p>
</li>
<li><p>getUserPrincipal():该方法当前登录用户对象</p>
</li>
<li><p>isGranted():判断用户是否具有具体指定的某一用户</p>
</li>
<li><p>isUserInRole():判断用户是否具有某功能的用户</p>
</li>
</ul>
<p>&#x3D;&#x3D;所以可以看出第一种方法也可以直接使用HttpServletRequest获取&#x3D;&#x3D;</p>
<p>至于如何将请求转化为Servlet3SecurityContextHolderAware RequestWrapper呢,这就是SecurityContextHolderAwareRequestFilter的工作,详细代码如下(只留重点非全部代码)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityContextHolderAwareRequestFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenericFilterBean</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">rolePrefix</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ROLE_&quot;</span>;<br>    <span class="hljs-keyword">private</span> HttpServletRequestFactory requestFactory;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        chain.doFilter(<span class="hljs-built_in">this</span>.requestFactory.create((HttpServletRequest)req, (HttpServletResponse)res), res);<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateFactory</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">rolePrefix</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.rolePrefix;<br>        <span class="hljs-built_in">this</span>.requestFactory = <span class="hljs-built_in">this</span>.createServlet3Factory(rolePrefix);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看出doFilter是直接创建了一个HttpServletRequset并且是通过createServlet3Factory()来创建该方法会创建一个,HttpServlet3RequestFactory而这个方法就是用来创建Servlet3SecurityContextHolderAwareRequestWrapper</p>
<h3 id="用户自定义数据获取"><a href="#用户自定义数据获取" class="headerlink" title="用户自定义数据获取"></a>用户自定义数据获取</h3><p>我们可以重写WebSecurityConfigurerAdapter类的configure(AuthenticationManagerBuilder)方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">   <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>       <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>       manager.createUser(User.withUsername(<span class="hljs-string">&quot;javaboy&quot;</span>)<br>                                 .password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).build());<br>       manager.createUser(User.withUsername(<span class="hljs-string">&quot;sang&quot;</span>)<br>                                  .password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="hljs-string">&quot;user&quot;</span>).build());<br>       auth.userDetailsService(manager);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>{noop}代表不加密</p>
<p>而InMemoryUserDetailsManager内部是使用HashMap来实现的</p>
<h4 id="基于JdbcUserDetailsManager"><a href="#基于JdbcUserDetailsManager" class="headerlink" title="基于JdbcUserDetailsManager"></a>基于JdbcUserDetailsManager</h4><p>JdbcUserDetailsManager提供了数据库脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mysql">create table `users`(<br>	`username` varchar(500) primary key,<br>    `password` varchar(500) not null,<br>    `enabled` boolean not null<br>);<br>create table `authorities` (<br>	`username` varchar(50) not null,<br>    `authority` varchar(50) not null,<br>    constraint fk_authorities_users foreign key(username) references users(username)<br>);<br>create unique index ix_auth_username on authorities (username,authority);<br></code></pre></td></tr></table></figure>



<p>准备依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>数据源配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/security_authority?serverTimezone=UTC</span><br></code></pre></td></tr></table></figure>

<p>然后就可以在前一小节的config方法中进行数据的控制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>    <span class="hljs-type">JdbcUserDetailsManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcUserDetailsManager</span>(dataSource);<br><br>    <span class="hljs-keyword">if</span>(!manager.userExists(<span class="hljs-string">&quot;YH&quot;</span>))&#123;<br>        manager.createUser(User.withUsername(<span class="hljs-string">&quot;YH&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123456&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>).build());<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!manager.userExists(<span class="hljs-string">&quot;ZZ&quot;</span>))&#123;<br>        manager.createUser(User.withUsername(<span class="hljs-string">&quot;ZZ&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123456&quot;</span>).roles(<span class="hljs-string">&quot;user&quot;</span>).build());<br>    &#125;<br><br>    auth.userDetailsService(manager);<br>&#125;<br></code></pre></td></tr></table></figure>



<ul>
<li>创建数据库</li>
<li>导入依赖</li>
<li>配置连接参数</li>
<li>将数据写入获取对象的方法中</li>
</ul>
<p>这里使用的是JdbcUserDetailsManager类,因为该类继承了UserDetailsService,在系统中获取用户数据是调用该接口的loadUserByUsername方法</p>
<blockquote>
<p>JDBC默认调用的是users表和authorities表</p>
<p>JdbcUserDetailsManager则继承自JdbcDaoImpl，同时完善了数据库操作，又封装了用户的增删改查方法。</p>
</blockquote>
<h4 id="基于Mybatis"><a href="#基于Mybatis" class="headerlink" title="基于Mybatis"></a>基于Mybatis</h4><p>首先是三表关系</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211008163428372.png" srcset="/img/loading.gif" lazyload alt="image-20211008163428372"></p>
<p>首先建表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE `role` (<br>    `id` int(11) NOT NULL AUTO_INCREMENT,<br>    `name` varchar(32) DEFAULT NULL,<br>    `nameZh` varchar(32) DEFAULT NULL,<br>    PRIMARY KEY (`id`)<br>   ) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br><br>   CREATE TABLE `user` (<br>    `id` int(11) NOT NULL AUTO_INCREMENT,<br>    `username` varchar(32) DEFAULT NULL,<br>    `password` varchar(255) DEFAULT NULL,<br>    `enabled` tinyint(1) DEFAULT NULL,<br>    `accountNonExpired` tinyint(1) DEFAULT NULL,<br>    `accountNonLocked` tinyint(1) DEFAULT NULL,<br>    `credentialsNonExpired` tinyint(1) DEFAULT NULL,<br>    PRIMARY KEY (`id`)<br>  ) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br><br>   CREATE TABLE `user_role` (<br>    `id` int(11) NOT NULL AUTO_INCREMENT,<br>    `uid` int(11) DEFAULT NULL,<br>    `rid` int(11) DEFAULT NULL,<br>    PRIMARY KEY (`id`),<br>    KEY `uid` (`uid`),<br>    KEY `rid` (`rid`)<br>   ) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br>   <br>   #插入数据<br>    INSERT INTO `role` (`id`, `name`, `nameZh`)<br>   VALUES<br>      (1,&#x27;ROLE_dba&#x27;,&#x27;数据库管理员&#x27;),<br>      (2,&#x27;ROLE_admin&#x27;,&#x27;系统管理员&#x27;),<br>      (3,&#x27;ROLE_user&#x27;,&#x27;用户&#x27;);<br><br>   INSERT INTO `user` (`id`, `username`, `password`, `enabled`,<br>          `accountNonExpired`, `accountNonLocked`, `credentialsNonExpired`)<br>   VALUES<br>      (1,&#x27;root&#x27;,&#x27;&#123;noop&#125;123&#x27;,1,1,1,1),<br>      (2,&#x27;admin&#x27;,&#x27;&#123;noop&#125;123&#x27;,1,1,1,1),<br>      (3,&#x27;sang&#x27;,&#x27;&#123;noop&#125;123&#x27;,1,1,1,1);<br><br>   INSERT INTO `user_role` (`id`, `uid`, `rid`)<br>   VALUES<br>      (1,1,1),<br>      (2,1,2),<br>      (3,2,2),<br>      (4,3,3);<br></code></pre></td></tr></table></figure>

<p>首先导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>数据库连接配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/security_authority?serverTimezone=UTC</span><br></code></pre></td></tr></table></figure>



<p>创建用户类和角色类(角色类需要继承UserDetails)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-comment">//是否可用</span><br>    <span class="hljs-keyword">private</span> Boolean enabled;<br>    <span class="hljs-comment">//是否过期</span><br>    <span class="hljs-keyword">private</span> Boolean accountNonExpired;<br>    <span class="hljs-comment">//是否被锁定</span><br>    <span class="hljs-keyword">private</span> Boolean accountNonLocked;<br>    <span class="hljs-comment">//凭证是否过期</span><br>    <span class="hljs-keyword">private</span> Boolean credentialsNonExpired;<br><br>    <span class="hljs-keyword">private</span> List&lt;Role&gt; roles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-comment">//系统获取用户角色权限</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;<br>        List&lt;SimpleGrantedAuthority&gt; authorities = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (Role role : roles) &#123;<br>            authorities.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleGrantedAuthority</span>(role.getName()));<br>        &#125;<br>        <span class="hljs-keyword">return</span> authorities;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.accountNonExpired;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.accountNonLocked;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.credentialsNonExpired;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.enabled;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Role</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String nameZh;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>创建UserMapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> &#123;<br><br>    List&lt;Role&gt; <span class="hljs-title function_">getRolesByUid</span><span class="hljs-params">(Integer id)</span>;<br><br>    User <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>创建UserMapper.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.yh.code.springcode.Mapper.UserMapper&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;loadUserByUsername&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.yh.code.springcode.Entity.User&quot;</span>&gt;</span><br>           select * from security_authority.user where username=#&#123;username&#125;;<br>       <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;getRolesByUid&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.yh.code.springcode.Entity.Role&quot;</span>&gt;</span><br>           select r.* from security_authority.role r,security_authority.user_role ur where r.`id`=ur.`rid`<br>       <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在pom.xml文件中设置打包不过滤</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>创建服务类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    UserMapper userMapper;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span><br>                                              <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.loadUserByUsername(username);<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(<span class="hljs-string">&quot;用户不存在&quot;</span>);<br>        &#125;<br>        user.setRoles(userMapper.getRolesByUid(user.getId()));<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure>

<p>以上操作都是Mybatis的常规操作</p>
<p>首先在SecurityConfig中的config(上面两节的那个类的相同方法)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>      <span class="hljs-meta">@Autowired</span><br>      MyUserDetailsService myUserDetailsService;<br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span><span class="hljs-keyword">throws</span> Exception &#123;<br>          auth.userDetailsService(myUserDetailsService);<br>      &#125;<br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>          http.authorizeRequests()<br>                  <span class="hljs-comment">//省略</span><br>      &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>建库插入测试数据</li>
<li>导入以来</li>
<li>配置连接数据库参数</li>
<li>根据表创建类(用户类需要实现UserDetails接口)</li>
<li>创建mapper</li>
<li>创建mapper.xml</li>
<li>创建服务类实现UserDetailsService接口(为了让系统调用loadUserByUsername方法)</li>
<li>config方法中传递数据源</li>
</ul>
<h4 id="基于SpringDataJPA"><a href="#基于SpringDataJPA" class="headerlink" title="基于SpringDataJPA"></a>基于SpringDataJPA</h4><p>与mybatis相似但是可见区别在于不用建表不用写sql</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>配置连接数据库</p>
<p>JPA的配置则主要配置了数据库平台，数据表更新方式、是否打印SQL以及对应的数据库方言。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs properties"> <span class="hljs-attr">spring.datasource.username</span>=<span class="hljs-string">root</span><br>    <span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-string">123</span><br>    <span class="hljs-attr">spring.datasource.url</span>=<span class="hljs-string">jdbc:mysql:///security03?useUnicode=true&amp;characterEncod</span><br><span class="hljs-attr">ing</span>=<span class="hljs-string">UTF-8&amp;serverTimezone=Asia/Shanghai</span><br>  <br>    <span class="hljs-attr">spring.jpa.database</span>=<span class="hljs-string">mysql</span><br>    <span class="hljs-attr">spring.jpa.database-platform</span>=<span class="hljs-string">mysql</span><br>    <span class="hljs-attr">spring.jpa.hibernate.ddl-auto</span>=<span class="hljs-string">update</span><br>    <span class="hljs-attr">spring.jpa.show-sql</span>=<span class="hljs-string">true</span><br>    <span class="hljs-attr">spring.jpa.properties.hibernate.dialect</span>=<span class="hljs-string">org.hibernate.dialect.MySQL8D</span><br></code></pre></td></tr></table></figure>



<p>创建实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Entity(name = &quot;t_user&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> &#123;<br>     <span class="hljs-meta">@Id</span><br>     <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span><br>     <span class="hljs-keyword">private</span> Long id;<br>     <span class="hljs-keyword">private</span> String username;<br> <span class="hljs-keyword">private</span> String password;<br>     <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> accountNonExpired;<br>     <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> accountNonLocked;<br>     <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> credentialsNonExpired;<br>     <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> enabled;<br>     <span class="hljs-meta">@ManyToMany(fetch = FetchType.EAGER,cascade = CascadeType.PERSIST)</span><br>     <span class="hljs-keyword">private</span> List&lt;Role&gt; roles;<br>     <span class="hljs-meta">@Override</span><br>     <span class="hljs-keyword">public</span> Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;<br>         List&lt;SimpleGrantedAuthority&gt; authorities = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>         <span class="hljs-keyword">for</span> (Role role : getRoles()) &#123;<br>             authorities.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleGrantedAuthority</span>(role.getName()));<br>         &#125;<br>         <span class="hljs-keyword">return</span> authorities;<br>     &#125;<br>     <span class="hljs-meta">@Override</span><br>     <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> password;<br>     &#125;<br>     <span class="hljs-meta">@Override</span><br>     <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> username;<br>     &#125;<br>     <span class="hljs-meta">@Override</span><br>     <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> accountNonExpired;<br>     &#125;<br>     <span class="hljs-meta">@Override</span><br>     <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> accountNonLocked;<br>     &#125;<br>     <span class="hljs-meta">@Override</span><br>     <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> credentialsNonExpired;<br>     &#125;<br>     <span class="hljs-meta">@Override</span><br>     <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">return</span> enabled;<br>     &#125;<br>     <span class="hljs-comment">//省略getter/setter</span><br>  &#125;<br>  <span class="hljs-meta">@Entity(name = &quot;t_role&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Role</span> &#123;<br>     <span class="hljs-meta">@Id</span><br>     <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span><br>     <span class="hljs-keyword">private</span> Long id;<br>     <span class="hljs-keyword">private</span> String name;<br>     <span class="hljs-keyword">private</span> String nameZh;<br>     <span class="hljs-comment">//省略getter/setter</span><br>  &#125;<br></code></pre></td></tr></table></figure>

<p>配置service</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211008170937801.png" srcset="/img/loading.gif" lazyload alt="image-20211008170937801"></p>
<p>方法config()的配置与mybatis一样</p>
<h3 id="三个基本组件以及登录认证过滤器"><a href="#三个基本组件以及登录认证过滤器" class="headerlink" title="三个基本组件以及登录认证过滤器"></a>三个基本组件以及登录认证过滤器</h3><h5 id="AuthenticationManager"><a href="#AuthenticationManager" class="headerlink" title="AuthenticationManager"></a>AuthenticationManager</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationManager</span> &#123;<br>	Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>定义了security如何去认证,成功后会返回Authentication并将它存到SecurityContextHolder中通过传入用户名和密码的简单信息的Authentication对其进行验证与填充并返回保存</p>
<p>对于该实现类最常见的时ProviderManager</p>
<hr>
<h5 id="ProviderManager"><a href="#ProviderManager" class="headerlink" title="ProviderManager"></a>ProviderManager</h5><p>多个AuthenticationProvider将组成一个列表，这个列表将由ProviderManager代理。而&#x3D;&#x3D;ProviderManager本身也可以再配置一个AuthenticationManager作为parent&#x3D;&#x3D;，这样当ProviderManager认证失败之后，就可以进入到parent中再次进行认证。</p>
<p>理论上来说，ProviderManager的parent可以是任意类型的AuthenticationManager，但是通常都是由ProviderManager来扮演parent的角色，也就是&#x3D;&#x3D;ProviderManager是ProviderManager的parent。&#x3D;&#x3D;<br>ProviderManager本身也可以有多个，&#x3D;&#x3D;多个ProviderManager共用同一个parent&#x3D;&#x3D;，当存在多个过滤器链的时候非常有用。当存在多个过滤器链时，不同的路径可能对应不同的认证方式，但是不同路径可能又会同时存在一些共有的认证方式，这些共有的认证方式可以在parent中统一处理。</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211009102918119.png" srcset="/img/loading.gif" lazyload alt="image-20211009102918119"></p>
<h5 id="AuthenticationProvider"><a href="#AuthenticationProvider" class="headerlink" title="AuthenticationProvider"></a>AuthenticationProvider</h5><p>该方法提供对不同的身份进行具体的身份认证</p>
<blockquote>
<p>例如，常见的DaoAuthenticationProvider用来支持用户名／密码登录认证，RememberMeAuthenticationProvider用来支持“记住我”的认证。</p>
</blockquote>
<p>源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationProvider</span> &#123;<br>	<br>	Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException;<br><br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(Class&lt;?&gt; authentication)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>authenticate()方法用来执行具体的认证方法</li>
<li>supports()用来检测该实例是否支持对应的身份检查</li>
</ul>
<p>举个简单的例子</p>
<p>AbstractUserDetailsAuthenticationProvider该抽象类实现了AuthenticationProvider:部分源代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//首先创建一个空的用户缓存</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">UserCache</span> <span class="hljs-variable">userCache</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullUserCache</span>();<br><span class="hljs-comment">//principal是否从对象转化为字符串</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">forcePrincipalAsString</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><span class="hljs-comment">//是否隐藏用户名查找失败即大部分的异常都会被隐藏起来并且重新抛出BadCredentialsException异常,来方式黑客才猜测攻击</span><br><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hideUserNotFoundExceptions</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><span class="hljs-comment">//用户状态的认证,例如是否被锁定,冻结等</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">UserDetailsChecker</span> <span class="hljs-variable">preAuthenticationChecks</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultPreAuthenticationChecks</span>();<br><span class="hljs-comment">//用于验证密码是否过期</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">UserDetailsChecker</span> <span class="hljs-variable">postAuthenticationChecks</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultPostAuthenticationChecks</span>();<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>	Assert.isInstanceOf(UsernamePasswordAuthenticationToken.class, authentication,<br>			() -&gt; <span class="hljs-built_in">this</span>.messages.getMessage(<span class="hljs-string">&quot;AbstractUserDetailsAuthenticationProvider.onlySupports&quot;</span>,<br>					<span class="hljs-string">&quot;Only UsernamePasswordAuthenticationToken is supported&quot;</span>));<br>	<span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> determineUsername(authentication);<br>       <br>       <span class="hljs-comment">//随用随开</span><br>	<span class="hljs-type">boolean</span> <span class="hljs-variable">cacheWasUsed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>	<span class="hljs-type">UserDetails</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.userCache.getUserFromCache(username);<br>	<span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>           <br>           <span class="hljs-comment">//随用随关</span><br>		cacheWasUsed = <span class="hljs-literal">false</span>;<br>		<span class="hljs-keyword">try</span> &#123;<br>			user = retrieveUser(username, (UsernamePasswordAuthenticationToken) authentication);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (UsernameNotFoundException ex) &#123;<br>			<span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Failed to find user &#x27;&quot;</span> + username + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>			<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.hideUserNotFoundExceptions) &#123;<br>				<span class="hljs-keyword">throw</span> ex;<br>			&#125;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadCredentialsException</span>(<span class="hljs-built_in">this</span>.messages<br>					.getMessage(<span class="hljs-string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span>, <span class="hljs-string">&quot;Bad credentials&quot;</span>));<br>		&#125;<br>		Assert.notNull(user, <span class="hljs-string">&quot;retrieveUser returned null - a violation of the interface contract&quot;</span>);<br>	&#125;<br>	<span class="hljs-keyword">try</span> &#123;<br>		<span class="hljs-built_in">this</span>.preAuthenticationChecks.check(user);<br>		additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken) authentication);<br>	&#125;<br>	<span class="hljs-keyword">catch</span> (AuthenticationException ex) &#123;<br>		<span class="hljs-keyword">if</span> (!cacheWasUsed) &#123;<br>			<span class="hljs-keyword">throw</span> ex;<br>		&#125;<br>		<span class="hljs-comment">// There was a problem, so try again after checking</span><br>		<span class="hljs-comment">// we&#x27;re using latest data (i.e. not from the cache)</span><br>		cacheWasUsed = <span class="hljs-literal">false</span>;<br>		user = retrieveUser(username, (UsernamePasswordAuthenticationToken) authentication);<br>		<span class="hljs-built_in">this</span>.preAuthenticationChecks.check(user);<br>		additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken) authentication);<br>	&#125;<br>	<span class="hljs-built_in">this</span>.postAuthenticationChecks.check(user);<br>	<span class="hljs-keyword">if</span> (!cacheWasUsed) &#123;<br>		<span class="hljs-built_in">this</span>.userCache.putUserInCache(user);<br>	&#125;<br>	<span class="hljs-type">Object</span> <span class="hljs-variable">principalToReturn</span> <span class="hljs-operator">=</span> user;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.forcePrincipalAsString) &#123;<br>		principalToReturn = user.getUsername();<br>	&#125;<br>	<span class="hljs-keyword">return</span> createSuccessAuthentication(principalToReturn, authentication, user);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>authenticate()主要的认证方法:</p>
<blockquote>
<p>首先determineUsername获取用户名,并在缓存中根据用户名进行查找对象如果不存在就使用retrieveUser从数据库中查找</p>
<p>找到之后首先进行用户状态的认证再进行密码的认证,最后认证是否过期</p>
<p>上面都通过会创建一个UsernamePasswordAuthenticationToken对象并返回，认证后的对象中包含了认证主体、凭证以及角色等信息。</p>
</blockquote>
<p>而该抽象方法的实现类DaoAuthenticationProvider,部分源码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//如果认证失败的情况下使用的加密字符串</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">USER_NOT_FOUND_PASSWORD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;userNotFoundPassword&quot;</span>;<br><span class="hljs-comment">//认证的加密方式等</span><br><span class="hljs-keyword">private</span> PasswordEncoder passwordEncoder;<br><span class="hljs-comment">//保存认证失败后USER_NOT_FOUND_PASSWORD的加密字符串</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> String userNotFoundEncodedPassword;<br><span class="hljs-comment">//用于查询用户的类</span><br><span class="hljs-keyword">private</span> UserDetailsService userDetailsService;<br><span class="hljs-comment">//进行密码认证的类</span><br><span class="hljs-keyword">private</span> UserDetailsPasswordService userDetailsPasswordService;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>DaoAuthenticationProvider的构造方法中，默认就会指定PasswordEncoder，当然开发者也可以通过set方法自定义PasswordEncoder。</p>
</li>
<li><p>additionalAuthenticationChecks方法主要进行密码校验，该方法第一个参数userDetails是从数据库中查询出来的用户对象，第二个参数authentication则是登录用户输入的参数。从这两个参数中分别提取出来用户密码，然后调用passwordEncoder.matches方法进行密码比对。</p>
</li>
<li><p>retrieveUser方法则是获取用户对象的方法，具体做法就是调用UserDetailsService#loadUserByUsername方法去数据库中查询。</p>
<ul>
<li><blockquote>
<p>）在retrieveUser方法中，有一个值得关注的地方。在该方法一开始，首先会调用prepareTimingAttackProtection方法，该方法的作用是使用PasswordEncoder对常量USER_NOT_FOUND_PASSWORD进行加密，将加密结果保存在userNotFoundEncoded Password变量中。当根据用户名查找用户时，如果抛出了UsernameNotFoundException异常，则调用mitigateAgainstTimingAttack方法进行密码比对。有读者会说，用户都没查找到，怎么比对密码？需要注意，在调用mitigateAgainstTimingAttack方法进行密码比对时，使用了userNotFoundEncodedPassword变量作为默认密码和登录请求传来的用户密码进行比对。这是一个一开始就注定要失败的密码比对，那么为什么还要进行比对呢？这主要是为了避免旁道攻击（Side-channel attack）。如果根据用户名查找用户失败，就直接抛出异常而不进行密码比对，那么黑客经过大量的测试，就会发现有的请求耗费时间明显小于其他请求，那么进而可以得出该请求的用户名是一个不存在的用户名（因为用户名不存在，所以不需要密码比对，进而节省时间），这样就可以获取到系统信息。为了避免这一问题，所以当用户查找失败时，也会调用mitigateAgainstTimingAttack方法进行密码比对，这样就可以迷惑黑客。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>createSuccessAuthentication方法则是在登录成功后，创建一个全新的UsernamePasswordAuthenticationToken对象，同时会判断是否需要进行密码升级，如果需要进行密码升级，就会在该方法中进行加密方案升级。</p>
</li>
</ul>
<h5 id="ProviderManager和AuthenticationProvider的关系"><a href="#ProviderManager和AuthenticationProvider的关系" class="headerlink" title="ProviderManager和AuthenticationProvider的关系"></a>ProviderManager和AuthenticationProvider的关系</h5><p>在Spring Security中，由于系统可能同时支持多种不同的认证方式，例如同时支持用户名／密码认证、RememberMe认证、手机号码动态认证等，而不同的认证方式对应了不同的AuthenticationProvider，所以一个完整的认证流程可能由多个AuthenticationProvider来提供。<br>多个AuthenticationProvider将组成一个列表，这个列表将由ProviderManager代理。换句话说，在ProviderManager中存在一个AuthenticationProvider列表，在ProviderManager中遍历列表中的每一个AuthenticationProvider去执行身份认证，最终得到认证结果。</p>
<h5 id="AbstractAuthenticationProcessingFilter"><a href="#AbstractAuthenticationProcessingFilter" class="headerlink" title="AbstractAuthenticationProcessingFilter"></a>AbstractAuthenticationProcessingFilter</h5><p>任何登录请求都会经过该过滤链器的实现类为UsernamePasswordAuthenticationFilter</p>
<h3 id="过滤器分析"><a href="#过滤器分析" class="headerlink" title="过滤器分析"></a>过滤器分析</h3><h3 id="配置多数据源"><a href="#配置多数据源" class="headerlink" title="配置多数据源"></a>配置多数据源</h3><p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211009150724088.png" srcset="/img/loading.gif" lazyload alt="image-20211009150724088"></p>
<h3 id="验证码"><a href="#验证码" class="headerlink" title="验证码"></a>验证码</h3><h5 id="通过自定义过滤器"><a href="#通过自定义过滤器" class="headerlink" title="通过自定义过滤器"></a>通过自定义过滤器</h5><p>emmmm…..等着!!!</p>
<h5 id="通过自定义认证逻辑"><a href="#通过自定义认证逻辑" class="headerlink" title="通过自定义认证逻辑"></a>通过自定义认证逻辑</h5><blockquote>
<p>如果通过重写DaoAuthenticationProvider类的additionalAuthenticationChecks方法来完成验证码的校验，这个从技术上来说是没有问题的，但是这会让验证码失去存在的意义，因为当additionalAuthenticationChecks方法被调用时，数据库查询已经做了，仅仅剩下密码没有校验，此时，通过验证码来拦截恶意登录的功能就已经失效了。</p>
</blockquote>
<p>首先导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.penggle<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kaptcha<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>创建配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KaptchaConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    Producer <span class="hljs-title function_">kaptcha</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        properties.setProperty(<span class="hljs-string">&quot;kaptcha.image.width&quot;</span>, <span class="hljs-string">&quot;150&quot;</span>);<br>        properties.setProperty(<span class="hljs-string">&quot;kaptcha.image.height&quot;</span>, <span class="hljs-string">&quot;50&quot;</span>);<br>        properties.setProperty(<span class="hljs-string">&quot;kaptcha.textproducer.char.string&quot;</span>,<br>                <span class="hljs-string">&quot;0123456789&quot;</span>);<br><br>        properties.setProperty(<span class="hljs-string">&quot;kaptcha.textproducer.char.length&quot;</span>, <span class="hljs-string">&quot;4&quot;</span>);<br>        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>(properties);<br>        <span class="hljs-type">DefaultKaptcha</span> <span class="hljs-variable">defaultKaptcha</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultKaptcha</span>();<br>        defaultKaptcha.setConfig(config);<br>        <span class="hljs-keyword">return</span> defaultKaptcha;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>创建一个类继承DaoAuthenticationProvider</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KaptchaAuthenticationProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DaoAuthenticationProvider</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br><br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) RequestContextHolder<br>                .getRequestAttributes()).getRequest();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">image</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;image&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">kaptcha</span> <span class="hljs-operator">=</span> (String) req.getSession().getAttribute(<span class="hljs-string">&quot;kaptcha&quot;</span>);<br><br>        <span class="hljs-keyword">if</span>(kaptcha==<span class="hljs-literal">null</span> &amp;&amp; image==<span class="hljs-literal">null</span> &amp;&amp; kaptcha.equals(image))&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthenticationServiceException</span>(<span class="hljs-string">&quot;验证码输入错误&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticate(authentication);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在SecurityConfig中注册添加到Bean中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>    <span class="hljs-type">KaptchaAuthenticationProvider</span> <span class="hljs-variable">provider</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KaptchaAuthenticationProvider</span>();<br>    provider.setUserDetailsService(service);<br>    <span class="hljs-type">ProviderManager</span> <span class="hljs-variable">providerManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProviderManager</span>(provider);<br>    <span class="hljs-keyword">return</span> providerManager;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>创建Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>Producer producer;<br><br><span class="hljs-meta">@RequestMapping(&quot;/cv.jpg&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pTest</span><span class="hljs-params">(HttpServletResponse resp, HttpSession session)</span>&#123;<br><br>    resp.setContentType(<span class="hljs-string">&quot;image/jpeg&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> producer.createText();<br>    session.setAttribute(<span class="hljs-string">&quot;kaptcha&quot;</span>,text);<br>    <span class="hljs-type">BufferedImage</span> <span class="hljs-variable">image</span> <span class="hljs-operator">=</span> producer.createImage(text);<br>    <span class="hljs-keyword">try</span> (<span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> resp.getOutputStream()) &#123;<br><br>        ImageIO.write(image,<span class="hljs-string">&quot;jpg&quot;</span>,outputStream);<br><br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>在SecurityConfig中不对该请求过滤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//.anyRequest().authenticated()代表所有请求认证后才能访问</span><br>    http.authorizeRequests()<br>            .antMatchers(<span class="hljs-string">&quot;/cv.jpg&quot;</span>)<br>            .permitAll()<br>            .anyRequest()<br>            .authenticated()<br>            <span class="hljs-comment">//and代表将将原来的http返回</span><br>            .and()<br>        <span class="hljs-comment">//......等等</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="基础组件"><a href="#基础组件" class="headerlink" title="基础组件"></a>基础组件</h3><p>由于Spring Security中大量采用了Java配置，许多过滤器都是直接new出来的，这些直接new出来的对象并不会自动注入到Spring容器中。所以第一个组件是用来注册到容器中</p>
<h4 id="ObjectPostProcessor-对一个成功创建的实例使用这个类进行补充"><a href="#ObjectPostProcessor-对一个成功创建的实例使用这个类进行补充" class="headerlink" title="ObjectPostProcessor:对一个成功创建的实例使用这个类进行补充"></a>ObjectPostProcessor:对一个成功创建的实例使用这个类进行补充</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ObjectPostProcessor</span>&lt;T&gt; &#123;<br>	&lt;O <span class="hljs-keyword">extends</span> <span class="hljs-title class_">T</span>&gt; O <span class="hljs-title function_">postProcess</span><span class="hljs-params">(O object)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>该接口有两个实现类:</p>
<ul>
<li>AutowireBeanFactoryObjectPostProcessor:使用该类的postProcess方法将类加载进去</li>
<li>CompositeObjectPostProcessor:是ObjectPostProcessor的集合,里面有一个关于该接口的List对象调用实现方法实际就是遍历List并使用postProcess方法进行处理,Security使用的后置对象就是这个方法,但默认只有一个AutowireBeanFactoryObjectPostProcessor</li>
</ul>
<p>每个过滤器都有一个configurer的配置器,这些过滤器就是在配置器中new出来并使用postProcess进行处理</p>
<h4 id="SecurityFilterChain-过滤器链对象"><a href="#SecurityFilterChain-过滤器链对象" class="headerlink" title="SecurityFilterChain:过滤器链对象"></a>SecurityFilterChain:过滤器链对象</h4><p>该接口的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecurityFilterChain</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(HttpServletRequest var1)</span>;<br><br>    List&lt;Filter&gt; <span class="hljs-title function_">getFilters</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>matches:用来处理是否能够被该过滤器链处理</li>
<li>getFilters:返回所有的过滤器</li>
</ul>
<p>该接口只有一个实现类DefaultSecurityFilterChain</p>
<p>该过滤器链可能会有多个</p>
<h4 id="SecurityBuilder-构建所有需要的对象"><a href="#SecurityBuilder-构建所有需要的对象" class="headerlink" title="SecurityBuilder:构建所有需要的对象"></a>SecurityBuilder:构建所有需要的对象</h4><p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211011093037215.png" srcset="/img/loading.gif" lazyload alt="image-20211011093037215"></p>
<h5 id="HttpSecurityBuilder："><a href="#HttpSecurityBuilder：" class="headerlink" title="HttpSecurityBuilder："></a>HttpSecurityBuilder：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HttpSecurityBuilder</span>&lt;H <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpSecurityBuilder</span>&lt;H&gt;&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityBuilder</span>&lt;DefaultSecurityFilterChain&gt; &#123;<br>    <span class="hljs-comment">//获取配置器</span><br>    &lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;DefaultSecurityFilterChain, H&gt;&gt; C <span class="hljs-title function_">getConfigurer</span><span class="hljs-params">(Class&lt;C&gt; var1)</span>;<br>	<span class="hljs-comment">//移除配置器</span><br>    &lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurer</span>&lt;DefaultSecurityFilterChain, H&gt;&gt; C <span class="hljs-title function_">removeConfigurer</span><span class="hljs-params">(Class&lt;C&gt; var1)</span>;<br>	<span class="hljs-comment">//设置一个可以在各个配置器间共享的对象</span><br>    &lt;C&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSharedObject</span><span class="hljs-params">(Class&lt;C&gt; var1, C var2)</span>;<br>	<span class="hljs-comment">//获取一个可以在各个配置器间共享的对象</span><br>    &lt;C&gt; C <span class="hljs-title function_">getSharedObject</span><span class="hljs-params">(Class&lt;C&gt; var1)</span>;<br>	<span class="hljs-comment">//配置认证器</span><br>    H <span class="hljs-title function_">authenticationProvider</span><span class="hljs-params">(AuthenticationProvider var1)</span>;<br>	<span class="hljs-comment">//配置数据源</span><br>    H <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">(UserDetailsService var1)</span> <span class="hljs-keyword">throws</span> Exception;<br>	<span class="hljs-comment">//之后添加一个过滤器</span><br>    H <span class="hljs-title function_">addFilterAfter</span><span class="hljs-params">(Filter var1, Class&lt;? extends Filter&gt; var2)</span>;<br>	<span class="hljs-comment">//之前添加一个过滤器</span><br>    H <span class="hljs-title function_">addFilterBefore</span><span class="hljs-params">(Filter var1, Class&lt;? extends Filter&gt; var2)</span>;<br>	<span class="hljs-comment">//添加一个过滤器</span><br>    H <span class="hljs-title function_">addFilter</span><span class="hljs-params">(Filter var1)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="AbstractSecurityBuilder"><a href="#AbstractSecurityBuilder" class="headerlink" title="AbstractSecurityBuilder:"></a>AbstractSecurityBuilder:</h5><p>该确保Build方法只Build一次</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> O <span class="hljs-title function_">build</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.building.compareAndSet(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)) &#123;<br>        <span class="hljs-built_in">this</span>.object = <span class="hljs-built_in">this</span>.doBuild();<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.object;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlreadyBuiltException</span>(<span class="hljs-string">&quot;This object has already been built&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>关于方法被设为final<a target="_blank" rel="noopener" href="https://www.cnblogs.com/frankyou/p/6022959.html">https://www.cnblogs.com/frankyou/p/6022959.html</a></p>
<ul>
<li>第一,防止后续的继承修改该方法</li>
<li>第二,对应程序较少的方法提升效率</li>
</ul>
<p>该类虽然实现了只build一次但是没有实现具体的build而是交给他的doBuild抽象方法</p>
<h5 id="AbstractConfiguredSecurityBuilder"><a href="#AbstractConfiguredSecurityBuilder" class="headerlink" title="AbstractConfiguredSecurityBuilder:"></a>AbstractConfiguredSecurityBuilder:</h5><p>首先该类定义了一个枚举类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">BuildState</span> &#123;<br>    UNBUILT(<span class="hljs-number">0</span>),<span class="hljs-comment">//配置前</span><br>    INITIALIZING(<span class="hljs-number">1</span>),<span class="hljs-comment">//初始化中</span><br>    CONFIGURING(<span class="hljs-number">2</span>),<span class="hljs-comment">//配置中</span><br>    BUILDING(<span class="hljs-number">3</span>),<span class="hljs-comment">//构件中</span><br>    BUILT(<span class="hljs-number">4</span>);<span class="hljs-comment">//构建完成</span><br>    <span class="hljs-comment">//....省略</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>首先声明了一个configurers变量用来保存所有的配置类,关于该类的方法:</p>
<ul>
<li>apply:添加配置类(调用add方法实现)</li>
<li>add:方法用来将所有的配置类保存到configurers中，在添加的过程中，如果&#x3D;&#x3D;allowConfigurersOfSameType变量为true，则表示允许相同类型的配置类存在&#x3D;&#x3D;，也就是List集合中可以存在多个相同类型的配置类。默认情况下，如果是普通配置类，allowConfigurersOfSameType是false，所以List集合中的配置类始终只有一个配置类；如果在AuthenticationManagerBuilder中设置allowConfigurersOfSameType为true，此时相同类型的配置类可以有多个</li>
<li>getConfigurers:方法可以从configurers中返回某一个配置类对应的所有实例</li>
<li>removeConfigurers:可以移除某一个配置类的所有实例</li>
<li>getConfigurer方法也是获取配置类实例，但是只获取集合中第一项。</li>
<li>removeConfigurer方法可以从configurers中移除某一个配置类对应的所有配置类实例，并返回被移除掉的配置类实例中的第一项。</li>
</ul>
<p>由于该类继承了AbstractSecurityBuilder所有需要实现onBuild</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> O <span class="hljs-title function_">doBuild</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>.configurers) &#123;<br>        <span class="hljs-built_in">this</span>.buildState = AbstractConfiguredSecurityBuilder.BuildState.INITIALIZING;<br>        <span class="hljs-built_in">this</span>.beforeInit();<br>        <span class="hljs-built_in">this</span>.init();<br>        <span class="hljs-built_in">this</span>.buildState = AbstractConfiguredSecurityBuilder.BuildState.CONFIGURING;<br>        <span class="hljs-built_in">this</span>.beforeConfigure();<br>        <span class="hljs-built_in">this</span>.configure();<br>        <span class="hljs-built_in">this</span>.buildState = AbstractConfiguredSecurityBuilder.BuildState.BUILDING;<br>        <span class="hljs-type">O</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.performBuild();<br>        <span class="hljs-built_in">this</span>.buildState = AbstractConfiguredSecurityBuilder.BuildState.BUILT;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看出这个方法是synchronized并且还是final的</p>
<p>首先init();是遍历所有配置类,并完成初始化</p>
<p>configure();完成所有配置类的配置</p>
<p>performBuild();最终完成构建操作</p>
<h5 id="ProviderManagerBuilder"><a href="#ProviderManagerBuilder" class="headerlink" title="ProviderManagerBuilder"></a>ProviderManagerBuilder</h5><p>该接口是继承SecurityBuilder类并新增了一个Authentication authenticate(Authentication authentication)方法</p>
<h5 id="AuthenticationManagerBuilder"><a href="#AuthenticationManagerBuilder" class="headerlink" title="AuthenticationManagerBuilder"></a>AuthenticationManagerBuilder</h5><p>继承自<a href="#AbstractConfiguredSecurityBuilder">AbstractConfiguredSecurityBuilder</a>并实现了ProviderManagerBuilder接口</p>
<ul>
<li><p>构造方法</p>
<ul>
<li>&#96;&#96;&#96;java<br>public AuthenticationManagerBuilder(ObjectPostProcessor<Object> objectPostProcessor) {<br>    super(objectPostProcessor, true);<br>}<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><br>    可以看出调用了父类的构造方法也就是AbstractConfiguredSecurityBuilder的构造并且传递了<span class="hljs-literal">true</span>(允许相同类型的配置类同时存在)<br><br>- parentAuthenticationManager:给一个AuthenticationManager设置parent在[ProviderManager](<span class="hljs-meta">#ProviderManager)中提到如果认证失败就去父类再次认证</span><br><br>- inMemoryAuthentication、jdbcAuthentication以及userDetailsService:配置数据源<br><br>- authenticationProvider:该方法用来向authenticationProviders集合中添加AuthenticationProvider对象<br><br>- performBuild:执行具体的构建工作<br><br><br><br><span class="hljs-meta">#### HttpSecurity</span><br><br>构建一条过滤器链并反应到代码上,用于构建DefaultSecurityFilterChain<br><br>DefaultSecurityFilterChain包含一个路径匹配器和多个SpringSecurity过滤器,HttpSecurity会收集各种xxxconfigurers并将其放入父类的configurers中,要构建的时候再用这些configurer进行构建同时添加到HttpSecurity的filters<br><br>由于很多重复的源码所以这里以form表单登录配置为例<br><br>```<span class="hljs-function">java</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> FormLoginConfigurer&lt;HttpSecurity&gt; <span class="hljs-title">formLogin</span>() throws Exception</span> &#123;<br>    <span class="hljs-keyword">return</span> (FormLoginConfigurer)<span class="hljs-keyword">this</span>.getOrApply(<span class="hljs-keyword">new</span> FormLoginConfigurer());<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> HttpSecurity <span class="hljs-title">formLogin</span>(<span class="hljs-params">Customizer&lt;FormLoginConfigurer&lt;HttpSecurity&gt;&gt; formLoginCustomizer</span>) throws Exception</span> &#123;<br>    formLoginCustomizer.customize((FormLoginConfigurer)<span class="hljs-keyword">this</span>.getOrApply(<span class="hljs-keyword">new</span> FormLoginConfigurer()));<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>&#125;<br></code></pre></td></tr></table></figure></Object></li>
</ul>
</li>
</ul>
<p>可以看出一个有参一个无参,无参的返回FormLoginConfigurer对象然后可以继续配置,对于有参来说直接传递一个配置类即可完成配置然后返回HttpSecurity来继续进行其他配置,还记得SecurityConfig这个自己的配置文件吗</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211011165450240.png" srcset="/img/loading.gif" lazyload alt="image-20211011165450240"></p>
<p>可以看出and后返回的就是HttpSecurity</p>
<p>并且有参和无参方法都调用了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> &lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SecurityConfigurerAdapter</span>&lt;DefaultSecurityFilterChain, HttpSecurity&gt;&gt; C <span class="hljs-title function_">getOrApply</span><span class="hljs-params">(C configurer)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">C</span> <span class="hljs-variable">existingConfig</span> <span class="hljs-operator">=</span> (SecurityConfigurerAdapter)<span class="hljs-built_in">this</span>.getConfigurer(configurer.getClass());<br>    <span class="hljs-keyword">return</span> existingConfig != <span class="hljs-literal">null</span> ? existingConfig : <span class="hljs-built_in">this</span>.apply(configurer);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>该方法就是调用父类的getConfigurer方法查看是否存在配置类有的话直接返回没有则使用父类的apply调用添加</p>
<p>其他的配置都和这个类似</p>
<ul>
<li><p>每一套过滤器链都会有一个AuthenticationManager对象来进行认证操作（如果认证失败，则会调用AuthenticationManager的parent再次进行认证），主要是通过authentication Provider方法配置执行认证的authenticationProvider对象，通过userDetailsService方法配置UserDetailsService，最后在beforeConfigure方法中触发AuthenticationManager对象的构建。</p>
</li>
<li><p>performBuild方法则是进行DefaultSecurityFilterChain对象的构建，传入请求匹配器和过滤器集合filters，在构建之前，会先按照既定的顺序对filters进行排序。</p>
</li>
<li><p>通过addFilterAfter、addFilterBefore两个方法，我们可以在某一个过滤器之后或者之前添加一个自定义的过滤器（该方法已在HttpSecurityBuilder中声明，此处是具体实现）。</p>
</li>
<li><p>addFilter方法可以向过滤器链中添加一个过滤器，这个过滤器必须是Spring Security框架提供的过滤器的一个实例或者其扩展。实际上，在每一个xxxConfigurer的configure方法中，都会调用addFilter方法将构建好的过滤器添加到HttpSecurity中的filters集合中（addFilter方法已在HttpSecurityBuilder中声明，此处是具体实现）。</p>
</li>
<li><p>addFilterAt方法可以在指定位置添加一个过滤器。需要注意的是，在同一个位置添加多个过滤器并不会覆盖现有的过滤器。</p>
</li>
</ul>
<h4 id="WebSecurity"><a href="#WebSecurity" class="headerlink" title="WebSecurity"></a>WebSecurity</h4><p>HttpSecurity是装配了DefaultSecurityFilterChain,但可能存在多个HttpSecurity也就是存在多个DefaultSecurityFilterChain,这个类的作用是将这些整合成一个FilterChainProxy对象</p>
<ul>
<li>变量ignoredRequests:保存了所有被忽略的请求</li>
<li>变量securityFilterChainBuilders:该集合用来保存所有的HttpSecurity对象</li>
<li>变量httpFirewall:用来配置请求防火墙</li>
<li>performBuild:该方法首先统计过滤总数,创建一个securityFilterChains,遍历被忽略的请求并分别构建成DefaultSecurityFilterChain对象保存到securityFilterChains集合中但是只有请求匹配器没有过滤链,这样就可以不用过滤直接放行了,然后securityFilterChain Builders集合，调用每个对象的build方法构建DefaultSecurityFilterChain并存入securityFilter Chains集合中，然后传入securityFilterChains集合构建FilterChainProxy对象，最后再设置HTTP防火墙。所有设置完成之后，最后返回filterChainProxy对象。</li>
</ul>
<h4 id="FilterChainProxy"><a href="#FilterChainProxy" class="headerlink" title="FilterChainProxy"></a>FilterChainProxy</h4><ul>
<li>变量filterChains:用来保存过滤链</li>
<li>变量filterChainValidator:过滤器配置链完成后的认证器</li>
<li>变量firewall:防火墙</li>
</ul>
<p>主要运行方法doFilter:</p>
<blockquote>
<p>首先该方法会先定义一个变量,检查是否为第一次执行是的话会在过滤链结束后清空SecurityContextHolder,这是防止没有配置SecurityContextPersistenceFilter,关键的过滤处理在doFilterInternal中</p>
</blockquote>
<p>doFilterInternal源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>       <span class="hljs-type">FirewalledRequest</span> <span class="hljs-variable">firewallRequest</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.firewall.getFirewalledRequest((HttpServletRequest)request);<br>       <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">firewallResponse</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.firewall.getFirewalledResponse((HttpServletResponse)response);<br>       List&lt;Filter&gt; filters = <span class="hljs-built_in">this</span>.getFilters((HttpServletRequest)firewallRequest);<br>       <span class="hljs-keyword">if</span> (filters != <span class="hljs-literal">null</span> &amp;&amp; filters.size() != <span class="hljs-number">0</span>) &#123;<br>           <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>               logger.debug(LogMessage.of(() -&gt; &#123;<br>                   <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Securing &quot;</span> + requestLine(firewallRequest);<br>               &#125;));<br>           &#125;<br><br>           FilterChainProxy.<span class="hljs-type">VirtualFilterChain</span> <span class="hljs-variable">virtualFilterChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterChainProxy</span>.VirtualFilterChain(firewallRequest, chain, filters);<br>           virtualFilterChain.doFilter(firewallRequest, firewallResponse);<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>               logger.trace(LogMessage.of(() -&gt; &#123;<br>                   <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;No security for &quot;</span> + requestLine(firewallRequest);<br>               &#125;));<br>           &#125;<br><br>           firewallRequest.reset();<br>           chain.doFilter(firewallRequest, firewallResponse);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>首先会通过防火墙类来创建firewallRequest和firewallResponse</p>
<p>再从getFilters中获取到适合的filters过滤链如果为空就跳回WebFilter(最外层过滤链,相当于过滤结束),否则就根据获得的过滤链进行变量,并且对每个链都创建一个virtualFilterChain然后继续过滤</p>
<p>再来看virtualFilterChain(部分源代码):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualFilterChain</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FilterChain</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> FilterChain originalChain;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Filter&gt; additionalFilters;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> FirewalledRequest firewalledRequest;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> size;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> currentPosition;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.currentPosition == <span class="hljs-built_in">this</span>.size) &#123;<br>                <span class="hljs-keyword">if</span> (FilterChainProxy.logger.isDebugEnabled()) &#123;<br>                    FilterChainProxy.logger.debug(LogMessage.of(() -&gt; &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Secured &quot;</span> + FilterChainProxy.requestLine(<span class="hljs-built_in">this</span>.firewalledRequest);<br>                    &#125;));<br>                &#125;<br><br>                <span class="hljs-built_in">this</span>.firewalledRequest.reset();<br>                <span class="hljs-built_in">this</span>.originalChain.doFilter(request, response);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                ++<span class="hljs-built_in">this</span>.currentPosition;<br>                <span class="hljs-type">Filter</span> <span class="hljs-variable">nextFilter</span> <span class="hljs-operator">=</span> (Filter)<span class="hljs-built_in">this</span>.additionalFilters.get(<span class="hljs-built_in">this</span>.currentPosition - <span class="hljs-number">1</span>);<br>                <span class="hljs-keyword">if</span> (FilterChainProxy.logger.isTraceEnabled()) &#123;<br>                    FilterChainProxy.logger.trace(LogMessage.format(<span class="hljs-string">&quot;Invoking %s (%d/%d)&quot;</span>, nextFilter.getClass().getSimpleName(), <span class="hljs-built_in">this</span>.currentPosition, <span class="hljs-built_in">this</span>.size));<br>                &#125;<br><br>                nextFilter.doFilter(request, response, <span class="hljs-built_in">this</span>);<br>            &#125;<br>        &#125;<br>     &#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>变量originalChain:用来跳回WebFilter</li>
<li>变量additionalFilters:本次要进行过滤的过滤器链</li>
<li>变量firewalledRequest:用户请求</li>
<li>变量size:请求链大小</li>
<li>变量currentPosition:当前请求链位置</li>
</ul>
<p>在doFilter方法中，会首先判断当前执行的下标是否等于过滤器链的大小，如果相等，则说明整个过滤器链中的所有过滤器都已经挨个走一遍了，此时先对Http防火墙中的属性进行重置，然后调用originalChain.doFilter方法跳出Spring Security Filter，回到Web Filter；如果不相等，则currentPosition自增，然后从过滤器链集合中取出一个过滤器去执行，注意执行的时候第三个参数this表示当前对象（即VirtualFilterChain），这样在每一个过滤器执行完之后，最后的chain.doFilter方法又会回到当前doFilter方法中，继续下一个过滤器的调用。</p>
<h4 id="SecurityConfigurer"><a href="#SecurityConfigurer" class="headerlink" title="SecurityConfigurer"></a>SecurityConfigurer</h4><p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211011200219902.png" srcset="/img/loading.gif" lazyload alt="image-20211011200219902"></p>
<p>从名字上面看就大概知道该接口是用来初始化和配置类的配置</p>
<p>因为有很多的过滤器,而每个过滤器都有一个XXXconfigurer所以子类很多</p>
<p>下图为一小部分</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211011200608279.png" srcset="/img/loading.gif" lazyload alt="image-20211011200608279"></p>
<p>首先我们来看最开始配置的,目前位置最熟悉的配置类的父类的兄弟类:dog:</p>
<h5 id="SecurityConfigurerAdapter"><a href="#SecurityConfigurerAdapter" class="headerlink" title="SecurityConfigurerAdapter"></a>SecurityConfigurerAdapter</h5><ul>
<li><p>为每个配置类都提供了一个SecurityBuilder,使用build创建对象使用and返回对象,这里就和前面的一样</p>
</li>
<li><p>定义了内部类CompositeObjectPostProcessor，这是一个复合的对象后置处理器</p>
</li>
<li><p>提供了一个addObjectPostProcessor方法，通过该方法可以向复合的对象后置处理器中添加新的ObjectPostProcessor实例</p>
</li>
</ul>
<h5 id="UserDetailsAwareConfigurer"><a href="#UserDetailsAwareConfigurer" class="headerlink" title="UserDetailsAwareConfigurer"></a>UserDetailsAwareConfigurer</h5><p>他的子类主要用于认证配置的相关组件,例如UserDetailsService,但是获取UserDetailsService的方法为抽象方法需要在子类中实现</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211012091022619.png" srcset="/img/loading.gif" lazyload alt="image-20211012091022619"></p>
<ul>
<li>AbstractDaoAuthenticationConfigurer:完成对DaoAuthenticationProvider的配置</li>
<li>UserDetailsServiceConfigurer:完成对UserDetailsService的配置</li>
<li>UserDetailsManagerConfigurer:使用UserDetailsManager构建用户对象，完成对AuthenticationManagerBuilder的填充</li>
<li>JdbcUserDetailsManagerConfigurer:配置JdbcUserDetailsManager并填充到Authentication ManagerBuilder中</li>
<li>InMemoryUserDetailsManagerConfigurer:配置InMemoryUserDetailsManager</li>
<li>DaoAuthenticationConfigurer:完成对DaoAuthenticationProvider的配置</li>
</ul>
<h5 id="AbstractHttpConfigurer"><a href="#AbstractHttpConfigurer" class="headerlink" title="AbstractHttpConfigurer"></a>AbstractHttpConfigurer</h5><p>主要是为了给在HttpSecurity中使用的配置类添加一个方便的父类，提取出共同的操作</p>
<ul>
<li><p>disable表示禁用某一个配置（第2章中我们配置的.csrf().disable()），本质上就是从构建器的configurers集合中移除某一个配置类，这样在将来构建的时候就不存在该配置类，那么对应的功能也就不存在（被禁用）</p>
</li>
<li><p>withObjectPostProcessor表示给某一个对象添加一个对象后置处理器，由于该方法的返回值是当前对象，所以该方法可以用在链式配置中。</p>
</li>
</ul>
<p>下面是他的子类</p>
<p><img src="/.com//package_and_data\Book\JdReaderEBooks\jd_4657302ffcbc3\30712708_dir_img\OEBPS\Images\Figure-T138_115736.jpg" srcset="/img/loading.gif" lazyload alt="Figure-T138_115736"></p>
<h5 id="GlobalAuthenticationConfigurerAdapter"><a href="#GlobalAuthenticationConfigurerAdapter" class="headerlink" title="GlobalAuthenticationConfigurerAdapter"></a>GlobalAuthenticationConfigurerAdapter</h5><p>用于配置全局AuthenticationManagerBuilder</p>
<p>在介绍ProviderManager时曾经提到过，默认情况下ProviderManager有一个parent，这个parent就是通过这里的全局AuthenticationManagerBuilder来构建的</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211012093313969.png" srcset="/img/loading.gif" lazyload alt="image-20211012093313969"></p>
<p>他的继承关系为上图</p>
<ul>
<li>InitializeAuthenticationProviderBeanManagerConfigurer：初始化全局的AuthenticationProvider对象</li>
<li>InitializeAuthenticationProviderManagerConfigurer：配置全局的AuthenticationProvider对象，配置过程就是从Spring容器中查找AuthenticationProvider并设置给全局的AuthenticationManagerBuilder对象。</li>
<li>InitializeUserDetailsBeanManagerConfigurer：初始化全局的UserDetailsService对象。</li>
<li>InitializeUserDetailsManagerConfigurer：配置全局的UserDetailsService对象，配置过程就是从Spring容器中查找</li>
<li>UserDetailsService，并设置给全局的AuthenticationManagerBuilder对象。</li>
<li>EnableGlobalAuthenticationAutowiredConfigurer：从Spring容器中加载被@EnableGlobal Authentication注解标记的Bean。</li>
</ul>
<h5 id="WebSecurityConfigurer"><a href="#WebSecurityConfigurer" class="headerlink" title="WebSecurityConfigurer"></a>WebSecurityConfigurer</h5><p>空接口</p>
<h5 id="WebSecurityConfigurerAdapter"><a href="#WebSecurityConfigurerAdapter" class="headerlink" title="WebSecurityConfigurerAdapter"></a>WebSecurityConfigurerAdapter</h5><p>大多数情况下我们继承他来创建securityConfig</p>
<p>有两个AuthenticationManagerBuilder对象用来构建AuthenticationManager</p>
<ul>
<li>private AuthenticationManagerBuilder authenticationBuilder<ul>
<li>用于配置局部他和每个HttpSecurity进行绑定</li>
</ul>
</li>
<li>private AuthenticationManagerBuilder localConfigureAuthenticationBldr<ul>
<li>是所有局部AuthenticationManager的parent,但是如果没有重写configure(AuthenticationManagerBuilder)方法全局的AuthenticationManager对象是由AuthenticationConfiguration类中的getAuthenticationManager方法提供的，如果用户重写了configure(AuthenticationManagerBuilder)方法，则全局的AuthenticationManager就由localConfigureAuthenticationBldr负责构建</li>
</ul>
</li>
</ul>
<h4 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h4><h5 id="ObjectPostProcessor"><a href="#ObjectPostProcessor" class="headerlink" title="ObjectPostProcessor"></a>ObjectPostProcessor</h5><p>所有过滤器创建后由ObjectPostProcessor来添加到Bean中一般调用过程为，ObjectPostProcessor的实例类CompositeObjectPostProcessor调用postProcess方法，而该方法会遍历该类所维护的ObjectPostProcessor对象的postProcess方法，也就是该类的实现类AutowireBeanFactoryObjectPostProcessor的postProcess方法，这个对象会将对象注入到Bean容器中</p>
<blockquote>
<p>也可以自己定义ObjectPostProcessor然后注入到CompositeObjectPostProcessor的List列表中这样在注册到Bean中还能个性化配置例如动态权限配置</p>
</blockquote>
<p>我们可以使用如下方法来配置ObjectPostProcessor</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211013152326388.png" srcset="/img/loading.gif" lazyload alt="image-20211013152326388"></p>
<h5 id="多种定义"><a href="#多种定义" class="headerlink" title="多种定义"></a>多种定义</h5><ol>
<li><p>局部定义数据源</p>
<ul>
<li><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211013194636900.png" srcset="/img/loading.gif" lazyload alt="image-20211013194636900"></li>
</ul>
</li>
<li><p>全局定义</p>
<ul>
<li>&#96;&#96;&#96;java<br>@Configuration<br>   public class SecurityConfig extends WebSecurityConfigurerAdapter {<br>  @Bean<br>  UserDetailsService us() {<br>      InMemoryUserDetailsManager users &#x3D; new InMemoryUserDetailsManager();<br>      users.createUser(User.withUsername(“江南一点雨”)<br>              .password(“{noop}123”).roles(“admin”).build());<br>      return users;<br>  }<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><br>     <br><br><span class="hljs-number">3.</span> 全局定义<span class="hljs-number">2</span><br><br>   - ```java<br>         <span class="hljs-meta">@Override</span><br>          <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>              auth.inMemoryAuthentication().withUser(<span class="hljs-string">&quot;javagirl&quot;</span>)<br>                      .password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>)<br>                      .roles(<span class="hljs-string">&quot;admin&quot;</span>);<br>          &#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h5 id="配置多个过滤器"><a href="#配置多个过滤器" class="headerlink" title="配置多个过滤器"></a>配置多个过滤器</h5><p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211014102143194.png" srcset="/img/loading.gif" lazyload alt="image-20211014102143194"></p>
<p>注意了要配置多个相同的配置类要指定顺序,数字越大优先级越低。当请求到来时，会按照过滤器链的优先级从高往低，依次进行匹配。</p>
<h5 id="静态资源过滤"><a href="#静态资源过滤" class="headerlink" title="静态资源过滤"></a>静态资源过滤</h5><p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211014102537560.png" srcset="/img/loading.gif" lazyload alt="image-20211014102537560"></p>
<p>例如要过滤上面的资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;   <br>	<span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        web.ignoring().antMatchers(<span class="hljs-string">&quot;/login.html&quot;</span>, <span class="hljs-string">&quot;/css/**&quot;</span>, <span class="hljs-string">&quot;/js/**&quot;</span>,<span class="hljs-string">&quot;/images/**&quot;</span>);<br>        <span class="hljs-built_in">super</span>.configure(web);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="利用过滤器实现验证码认证-x3D-x3D-没理解-x3D-x3D"><a href="#利用过滤器实现验证码认证-x3D-x3D-没理解-x3D-x3D" class="headerlink" title="利用过滤器实现验证码认证&#x3D;&#x3D;没理解&#x3D;&#x3D;"></a>利用过滤器实现验证码认证&#x3D;&#x3D;没理解&#x3D;&#x3D;</h5><p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211014152500985.png" srcset="/img/loading.gif" lazyload alt="image-20211014152500985"></p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211014152627110.png" srcset="/img/loading.gif" lazyload alt="image-20211014152627110"></p>
<h3 id="密码加密"><a href="#密码加密" class="headerlink" title="密码加密"></a>密码加密</h3><p>PasswordEncoder加密接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PasswordEncoder</span> &#123;<br>    String <span class="hljs-title function_">encode</span><span class="hljs-params">(CharSequence rawPassword)</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(CharSequence rawPassword, String encodedPassword)</span>;<br>    <span class="hljs-keyword">default</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">upgradeEncoding</span><span class="hljs-params">(String encodedPassword)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>encode:进行加密</li>
<li>matches:密码比对</li>
<li>upgradeEncoding:加密升级</li>
</ul>
<h5 id="常见加密类"><a href="#常见加密类" class="headerlink" title="常见加密类"></a>常见加密类</h5><ul>
<li><p>BCryptPasswordEncoder自带盐降低运行速度</p>
</li>
<li><p>Argon2PasswordEncoder为了解决在定制硬件上密码容易被破解的问题</p>
</li>
<li><p>Pbkdf2PasswordEncoder:和前面几种类似，PBKDF2算法也是一种故意降低运算速度的算法，当需要FIPS（Federal Information Processing Standard，美国联邦信息处理标准）认证时，PBKDF2算法是一个很好的选择。</p>
</li>
<li><p>SCryptPasswordEncoder:也是一种故意降低运算速度的算法，而且需要大量内存</p>
</li>
</ul>
<p>这四种就是我们前面所说的自适应单向函数加密。除了这几种，还有一些基于消息摘要算法的加密方案，这些方案都已经不再安全，但是出于兼容性考虑，Spring Security并未移除相关类，主要有LdapShaPasswordEncoder、MessageDigestPasswordEncoder、Md4Password Encoder、StandardPasswordEncoder以及NoOpPasswordEncoder（密码明文存储），这五种皆已废弃，这里对这些类也不做过多介绍。</p>
<h5 id="DelegatingPasswordEncoder-现在系统默认的"><a href="#DelegatingPasswordEncoder-现在系统默认的" class="headerlink" title="DelegatingPasswordEncoder(现在系统默认的)"></a>DelegatingPasswordEncoder(现在系统默认的)</h5><p>该类是一个代理类使用代理类的好处有:</p>
<ul>
<li>兼容性:可以帮助很多旧密码加密的系统顺利迁移到spring security,允许同一系统出现多种加密方式</li>
<li>便捷性:由于加密方式肯能会改变使用代理类直接修改加密方案而不用大量修改</li>
<li>稳定性:作为一个框架，Spring Security不能经常进行重大更改，而使用Delegating PasswordEncoder可以方便地对密码进行升级(自动从一个加密方案升级到另外一个加密方案)。</li>
</ul>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211015151833725.png" srcset="/img/loading.gif" lazyload alt="image-20211015151833725"></p>
<p>查看源码即可看出PREFIX为包含加密类型的前缀SUFFIX为包含加密类型的后缀</p>
<p>idForEncode为加密类型</p>
<p>passwordEncoderForEncode为当前加密类型</p>
<p>idToPasswordEncoder里面存放着字符串和加密类的映射</p>
<p>defaultPasswordEncoderForMatches存放着默认的密码匹配类,(默认调用该类会直接报错)</p>
<p>而&#x3D;&#x3D;DelegatingPasswordEncoder&#x3D;&#x3D;是由&#x3D;&#x3D;PasswordEncoderFactories&#x3D;&#x3D;类的静态方法&#x3D;&#x3D;createDelegatingPasswordEncoder&#x3D;&#x3D;提供的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PasswordEncoderFactories</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">PasswordEncoderFactories</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PasswordEncoder <span class="hljs-title function_">createDelegatingPasswordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">encodingId</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;bcrypt&quot;</span>;<br>        Map&lt;String, PasswordEncoder&gt; encoders = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        encoders.put(encodingId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>());<br>        encoders.put(<span class="hljs-string">&quot;ldap&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LdapShaPasswordEncoder</span>());<br>        encoders.put(<span class="hljs-string">&quot;MD4&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Md4PasswordEncoder</span>());<br>        encoders.put(<span class="hljs-string">&quot;MD5&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageDigestPasswordEncoder</span>(<span class="hljs-string">&quot;MD5&quot;</span>));<br>        encoders.put(<span class="hljs-string">&quot;noop&quot;</span>, NoOpPasswordEncoder.getInstance());<br>        encoders.put(<span class="hljs-string">&quot;pbkdf2&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pbkdf2PasswordEncoder</span>());<br>        encoders.put(<span class="hljs-string">&quot;scrypt&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SCryptPasswordEncoder</span>());<br>        encoders.put(<span class="hljs-string">&quot;SHA-1&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageDigestPasswordEncoder</span>(<span class="hljs-string">&quot;SHA-1&quot;</span>));<br>        encoders.put(<span class="hljs-string">&quot;SHA-256&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageDigestPasswordEncoder</span>(<span class="hljs-string">&quot;SHA-256&quot;</span>));<br>        encoders.put(<span class="hljs-string">&quot;sha256&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardPasswordEncoder</span>());<br>        encoders.put(<span class="hljs-string">&quot;argon2&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Argon2PasswordEncoder</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelegatingPasswordEncoder</span>(encodingId, encoders);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>通过上面这个类可以看出我们可以自己定义类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    UserService userService;<br>    <span class="hljs-meta">@Bean</span><br>    PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">encodingId</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;bcrypt&quot;</span>;<br>        Map&lt;String, PasswordEncoder&gt; encoders = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        encoders.put(encodingId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>(<span class="hljs-number">31</span>));<br>        encoders.put(<span class="hljs-string">&quot;ldap&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LdapShaPasswordEncoder</span>());<br>       encoders.put(<span class="hljs-string">&quot;MD4&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Md4PasswordEncoder</span>());<br>        encoders.put(<span class="hljs-string">&quot;MD5&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageDigestPasswordEncoder</span>(<span class="hljs-string">&quot;MD5&quot;</span>));<br>        encoders.put(<span class="hljs-string">&quot;noop&quot;</span>, NoOpPasswordEncoder.getInstance());<br>        encoders.put(<span class="hljs-string">&quot;pbkdf2&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pbkdf2PasswordEncoder</span>());<br>        encoders.put(<span class="hljs-string">&quot;scrypt&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SCryptPasswordEncoder</span>());<br>        encoders.put(<span class="hljs-string">&quot;SHA-1&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageDigestPasswordEncoder</span>(<span class="hljs-string">&quot;SHA-1&quot;</span>));<br>        encoders.put(<span class="hljs-string">&quot;SHA-256&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageDigestPasswordEncoder</span>(<span class="hljs-string">&quot;SHA-256&quot;</span>));<br>        encoders.put(<span class="hljs-string">&quot;sha256&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardPasswordEncoder</span>());<br>        encoders.put(<span class="hljs-string">&quot;argon2&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Argon2PasswordEncoder</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelegatingPasswordEncoder</span>(encodingId, encoders);<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure>

<p>这样就可以自己定义升级BCryptPasswordEncoder(从10升级到31)</p>
<h5 id="实践一下"><a href="#实践一下" class="headerlink" title="实践一下"></a>实践一下</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EncodeConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    BCryptPasswordEncoder <span class="hljs-title function_">bCryptPasswordEncoder</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.inMemoryAuthentication()<br>                .withUser(<span class="hljs-string">&quot;YH&quot;</span>)<br>                .password(<span class="hljs-string">&quot;$2a$10$697P6xxcoe904JkL8dT//OZCX9t1ZC9DzItog8NpnAVPXNdoEblHC&quot;</span>)<br>                .roles(<span class="hljs-string">&quot;admin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests()<br>                .anyRequest()<br>                .authenticated()<br>                .and()<br>                .formLogin()<br>                .and()<br>                .csrf().disable();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个配置类就可以实现加密,密码为123456的BCryptPasswordEncoder加密,这种方式是直接用bean替换掉系统默认的DelegatingPasswordEncoder</p>
<p>这样就可以直接传递一个123456的密文即可</p>
<p>或者不进行替换而是加上一个前缀如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EncodeConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.inMemoryAuthentication()<br>                .withUser(<span class="hljs-string">&quot;YH&quot;</span>)<br>                .password(<span class="hljs-string">&quot;&#123;bcrypt&#125;$2a$10$697P6xxcoe904JkL8dT//OZCX9t1ZC9DzItog8NpnAVPXNdoEblHC&quot;</span>)<br>                .roles(<span class="hljs-string">&quot;admin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests()<br>                .anyRequest()<br>                .authenticated()<br>                .and()<br>                .formLogin()<br>                .and()<br>                .csrf().disable();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="加密升级"><a href="#加密升级" class="headerlink" title="加密升级"></a>加密升级</h5><p>首先对MyUserDetailsService继续实现UserDetailsPasswordService实现后代码为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span>, UserDetailsPasswordService &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    UserMapper userMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.loadUserByUsername(username);<br>        <span class="hljs-keyword">if</span>(user==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(<span class="hljs-string">&quot;用户不存在&quot;</span>);<br>        &#125;<br>        user.setRoles(userMapper.getRolesByUid(user.getId()));<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>    <br>    <br>    <br>    <br>    <span class="hljs-comment">//新增</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">updatePassword</span><span class="hljs-params">(UserDetails user, String newPassword)</span> &#123;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> userMapper.updatePassword(user.getUsername(), newPassword);<br>        <span class="hljs-keyword">if</span>(i==<span class="hljs-number">1</span>)&#123;<br>            ((User) user).setPassword(newPassword);<br>        &#125;<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>mapper中新增后结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> &#123;<br><br>    List&lt;Role&gt; <span class="hljs-title function_">getRolesByUid</span><span class="hljs-params">(Integer id)</span>;<br><br>    User <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span>;<br>    <br>    <br>	<span class="hljs-comment">//新增</span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">updatePassword</span><span class="hljs-params">(String username,String password)</span>;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>



<p>下面仅有部分代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <br>	<span class="hljs-meta">@Autowired</span><br>    MyUserDetailsService service;<br>    <br>     <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.userDetailsService(service);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>再mapper.xml文件中新增</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;updatePassword&quot;</span>&gt;</span><br>    update user set password=#&#123;password&#125; where username=#&#123;username&#125;;<br><span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>新增完成后查看数据库</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211015162454709.png" srcset="/img/loading.gif" lazyload alt="image-20211015162454709"></p>
<p>刚刚使用admin登录了发现系统对其进行升级了</p>
<h3 id="RememberMe"><a href="#RememberMe" class="headerlink" title="RememberMe"></a>RememberMe</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RememberMeConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> NoOpPasswordEncoder.getInstance();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.inMemoryAuthentication()<br>                .withUser(<span class="hljs-string">&quot;YH&quot;</span>)<br>                .password(<span class="hljs-string">&quot;123456&quot;</span>)<br>                .roles(<span class="hljs-string">&quot;admin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        http.authorizeRequests()<br>                .anyRequest()<br>                .authenticated()<br>                .and()<br>                .formLogin()<br>                .and()<br>                .rememberMe()<br>                .key(<span class="hljs-string">&quot;YH&quot;</span>)<br>                .and()<br>                .logout()<br>                .logoutUrl(<span class="hljs-string">&quot;/logout&quot;</span>)<br>                .clearAuthentication(<span class="hljs-literal">true</span>)<br>                .permitAll()<br>                .invalidateHttpSession(<span class="hljs-literal">true</span>)<br>                .and()<br>                .csrf()<br>                .disable();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>配置文件&#x3D;&#x3D;.rememberMe.key(String)&#x3D;&#x3D;这两个就可以进行</p>
<p>然后我们再浏览器中登录并勾选rememberMe就可以再cookie中发现</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211018095056097.png" srcset="/img/loading.gif" lazyload alt="image-20211018095056097">一个是JSESSIONID的95549F19FC543F06965A04397B83FC85,即真正的认证cookie</p>
<p>这种方法如果获取了rememberMe后可以无记录的登录该账号并获取该账号的权限，所以我们可以添加一个&lt;异地登陆&gt;来记录不同的会话</p>
<p>重写配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RememberMeConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    DataSource dataSource;<br><br>    <span class="hljs-meta">@Bean</span><br>    PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> NoOpPasswordEncoder.getInstance();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    JdbcTokenRepositoryImpl <span class="hljs-title function_">jdbcTokenRepository</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">JdbcTokenRepositoryImpl</span> <span class="hljs-variable">repository</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcTokenRepositoryImpl</span>();<br>        repository.setDataSource(dataSource);<br>        <span class="hljs-keyword">return</span> repository;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.inMemoryAuthentication()<br>                .withUser(<span class="hljs-string">&quot;YH&quot;</span>)<br>                .password(<span class="hljs-string">&quot;123456&quot;</span>)<br>                .roles(<span class="hljs-string">&quot;admin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests()<br>                .anyRequest()<br>                .authenticated()<br>                .and()<br>                .formLogin()<br>                .and()<br>                .rememberMe()<br>                .tokenRepository(jdbcTokenRepository())<br>                .key(<span class="hljs-string">&quot;YH&quot;</span>)<br>                .and()<br>                .logout()<br>                .logoutUrl(<span class="hljs-string">&quot;/logout&quot;</span>)<br>                .clearAuthentication(<span class="hljs-literal">true</span>)<br>                .permitAll()<br>                .invalidateHttpSession(<span class="hljs-literal">true</span>)<br>                .and()<br>                .csrf()<br>                .disable();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<p>使用JdbcTokenRepositoryImpl类的CREATE_TABLE_SQL常量来创建数据库</p>
<p>运行并登录勾选rememberMe后到数据库中查看</p>
<p>可以看到一个为series一个为token(具体细节是在下一节讲到PersistentTokenBasedRememberMeServices的processAutoLoginCookie方法)</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211018113008540.png" srcset="/img/loading.gif" lazyload alt="image-20211018113008540"></p>
<p>有新的会话就会覆盖token,登出就会清空</p>
<p>由于rememberMe可能会带来不安全所以要启用二次认证来对敏感信息进行验证</p>
<p>例如使用rememberMe的方式登录后要访问一些敏感信息就需要转到登录页面</p>
<p>例子如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-meta">@RequestMapping(&quot;/index&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">index</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success Login&quot;</span>;<br>&#125;<br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-meta">@RequestMapping(&quot;/hello&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后针对不同的请求设置不同的敏感信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>       http.authorizeRequests()<br>               .antMatchers(<span class="hljs-string">&quot;/hello&quot;</span>).fullyAuthenticated()<br>               .antMatchers(<span class="hljs-string">&quot;/index&quot;</span>).rememberMe()<br>               .anyRequest()<br>               .authenticated()<br>               .and();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这样登录成功后无法访问&#x2F;index,关闭浏览器再重新打开可以发现能访问&#x2F;index但不能访问&#x2F;hello(需要重新登录)</p>
<h4 id="关于RememberMe的接口"><a href="#关于RememberMe的接口" class="headerlink" title="关于RememberMe的接口"></a>关于RememberMe的接口</h4><p>RememberMeServices一共有三个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RememberMeServices</span> &#123;<br> 	<span class="hljs-comment">//用于提取需要的参数进行验证</span><br>    Authentication <span class="hljs-title function_">autoLogin</span><span class="hljs-params">(HttpServletRequest var1, HttpServletResponse var2)</span>;<br>	<span class="hljs-comment">//登录失败的操作</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">loginFail</span><span class="hljs-params">(HttpServletRequest var1, HttpServletResponse var2)</span>;<br>	<span class="hljs-comment">//登录成功的操作</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">loginSuccess</span><span class="hljs-params">(HttpServletRequest var1, HttpServletResponse var2, Authentication var3)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>主要有三个实现</p>
<ul>
<li>AbstractRememberMeServices:用来实现RememberMeServices的三个接口<ul>
<li>PersistentTokenBasedRememberMeServices</li>
<li>TokenBasedRememberMeServices</li>
</ul>
</li>
</ul>
<p>AbstractRememberMeServices:部分源代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Authentication <span class="hljs-title function_">autoLogin</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">rememberMeCookie</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.extractRememberMeCookie(request);<br>    <span class="hljs-keyword">if</span> (rememberMeCookie == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Remember-me cookie detected&quot;</span>);<br>        <span class="hljs-keyword">if</span> (rememberMeCookie.length() == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Cookie was empty&quot;</span>);<br>            <span class="hljs-built_in">this</span>.cancelCookie(request, response);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                String[] cookieTokens = <span class="hljs-built_in">this</span>.decodeCookie(rememberMeCookie);<br>                <span class="hljs-type">UserDetails</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.processAutoLoginCookie(cookieTokens, request, response);<br>                <span class="hljs-built_in">this</span>.userDetailsChecker.check(user);<br>                <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Remember-me cookie accepted&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.createSuccessfulAuthentication(request, user);<br>            &#125; <span class="hljs-keyword">catch</span> (CookieTheftException var6) &#123;<br>                <span class="hljs-built_in">this</span>.cancelCookie(request, response);<br>                <span class="hljs-keyword">throw</span> var6;<br>            &#125; <span class="hljs-keyword">catch</span> (UsernameNotFoundException var7) &#123;<br>                <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Remember-me login was valid but corresponding user not found.&quot;</span>, var7);<br>            &#125; <span class="hljs-keyword">catch</span> (InvalidCookieException var8) &#123;<br>                <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Invalid remember-me cookie: &quot;</span> + var8.getMessage());<br>            &#125; <span class="hljs-keyword">catch</span> (AccountStatusException var9) &#123;<br>                <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Invalid UserDetails: &quot;</span> + var9.getMessage());<br>            &#125; <span class="hljs-keyword">catch</span> (RememberMeAuthenticationException var10) &#123;<br>                <span class="hljs-built_in">this</span>.logger.debug(var10.getMessage());<br>            &#125;<br><br>            <span class="hljs-built_in">this</span>.cancelCookie(request, response);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">protected</span> String <span class="hljs-title function_">extractRememberMeCookie</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>    Cookie[] cookies = request.getCookies();<br>    <span class="hljs-keyword">if</span> (cookies != <span class="hljs-literal">null</span> &amp;&amp; cookies.length != <span class="hljs-number">0</span>) &#123;<br>        Cookie[] var3 = cookies;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> cookies.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var5 &lt; var4; ++var5) &#123;<br>            <span class="hljs-type">Cookie</span> <span class="hljs-variable">cookie</span> <span class="hljs-operator">=</span> var3[var5];<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.cookieName.equals(cookie.getName())) &#123;<br>                <span class="hljs-keyword">return</span> cookie.getValue();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">protected</span> String[] decodeCookie(String cookieValue) <span class="hljs-keyword">throws</span> InvalidCookieException &#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; cookieValue.length() % <span class="hljs-number">4</span>; ++j) &#123;<br>        cookieValue = cookieValue + <span class="hljs-string">&quot;=&quot;</span>;<br>    &#125;<br><br>    String cookieAsPlainText;<br>    <span class="hljs-keyword">try</span> &#123;<br>        cookieAsPlainText = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Base64.getDecoder().decode(cookieValue.getBytes()));<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException var7) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidCookieException</span>(<span class="hljs-string">&quot;Cookie token was not Base64 encoded; value was &#x27;&quot;</span> + cookieValue + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>    &#125;<br><br>    String[] tokens = StringUtils.delimitedListToStringArray(cookieAsPlainText, <span class="hljs-string">&quot;:&quot;</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; tokens.length; ++i) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            tokens[i] = URLDecoder.decode(tokens[i], StandardCharsets.UTF_8.toString());<br>        &#125; <span class="hljs-keyword">catch</span> (UnsupportedEncodingException var6) &#123;<br>            <span class="hljs-built_in">this</span>.logger.error(var6.getMessage(), var6);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> tokens;<br>&#125;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loginFail</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>    <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Interactive login attempt was unsuccessful.&quot;</span>);<br>    <span class="hljs-built_in">this</span>.cancelCookie(request, response);<br>    <span class="hljs-built_in">this</span>.onLoginFail(request, response);<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLoginFail</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loginSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication successfulAuthentication)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.rememberMeRequested(request, <span class="hljs-built_in">this</span>.parameter)) &#123;<br>        <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Remember-me login not requested.&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">this</span>.onLoginSuccess(request, response, successfulAuthentication);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> UserDetails <span class="hljs-title function_">processAutoLoginCookie</span><span class="hljs-params">(String[] var1, HttpServletRequest var2, HttpServletResponse var3)</span> <span class="hljs-keyword">throws</span> RememberMeAuthenticationException, UsernameNotFoundException;<br><br></code></pre></td></tr></table></figure>

<p>主要执行方法autoLogin</p>
<blockquote>
<p>首先使用extractRememberMeCookie()方法来获取request中的cookie,如果cookie符合条件则先用decodeCookie进行</p>
<p>base64解码(如果令牌字符串长度不是4的倍数，则在令牌末尾补上一个或者多个“&#x3D;”，以使其长度变为4的倍数)</p>
<p>之后执行processAutoLoginCookie()方法这个方法是个抽象方法,在他的子类(PersistentTokenBasedRememberMeServices)里面实现,该方法作用是验证cookie如果符合条件则将用户信息放进去.</p>
<p>最后调用createSuccessfulAuthentication方法创建token</p>
</blockquote>
<p>接下来让我们看看认证失败调用的方法吧~</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loginFail</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>    <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Interactive login attempt was unsuccessful.&quot;</span>);<br>    <span class="hljs-built_in">this</span>.cancelCookie(request, response);<br>    <span class="hljs-built_in">this</span>.onLoginFail(request, response);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>首先取消cookie然后再跳转到onLoginFail()方法&#x3D;&#x3D;默认是个空方法&#x3D;&#x3D;</p>
<p>如果登录成功则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loginSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication successfulAuthentication)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.rememberMeRequested(request, <span class="hljs-built_in">this</span>.parameter)) &#123;<br>        <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Remember-me login not requested.&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">this</span>.onLoginSuccess(request, response, successfulAuthentication);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLoginSuccess</span><span class="hljs-params">(HttpServletRequest var1, HttpServletResponse var2, Authentication var3)</span>;<br></code></pre></td></tr></table></figure>

<p>登录成功时，会首先调用rememberMeRequested方法，判断当前请求是否开启了自动登录。开发者可以在服务端配置alwaysRemember，这样无论前端参数是什么，都会开启自动登录，如果开发者没有配置alwaysRemember，则根据前端传来的remember-me参数进行判断，remember-me参数的值如果是true、on（默认）、yes或者1，表示开启自动登录。如果开启了自动登录，则调用onLoginSuccess方法进行登录成功的处理。onLoginSuccess是一个抽象方法，具体实现在AbstractRememberMeServices的子类中。</p>
<p>&#x3D;&#x3D;最后再来看AbstractRememberMeServices中一个比较重要的方法setCookie，在自动登录成功后，将调用该方法把令牌信息放入响应头中并最终返回到前端&#x3D;&#x3D;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCookie</span><span class="hljs-params">(String[] tokens, <span class="hljs-type">int</span> maxAge, HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cookieValue</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.encodeCookie(tokens);<br>    <span class="hljs-type">Cookie</span> <span class="hljs-variable">cookie</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cookie</span>(<span class="hljs-built_in">this</span>.cookieName, cookieValue);<br>    cookie.setMaxAge(maxAge);<br>    cookie.setPath(<span class="hljs-built_in">this</span>.getCookiePath(request));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.cookieDomain != <span class="hljs-literal">null</span>) &#123;<br>        cookie.setDomain(<span class="hljs-built_in">this</span>.cookieDomain);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (maxAge &lt; <span class="hljs-number">1</span>) &#123;<br>        cookie.setVersion(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    cookie.setSecure(<span class="hljs-built_in">this</span>.useSecureCookie != <span class="hljs-literal">null</span> ? <span class="hljs-built_in">this</span>.useSecureCookie : request.isSecure());<br>    cookie.setHttpOnly(<span class="hljs-literal">true</span>);<br>    response.addCookie(cookie);<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h4 id="TokenBasedRememberMeServices"><a href="#TokenBasedRememberMeServices" class="headerlink" title="TokenBasedRememberMeServices"></a>TokenBasedRememberMeServices</h4><p>实现了processAutoLoginCookie方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> UserDetails <span class="hljs-title function_">processAutoLoginCookie</span><span class="hljs-params">(String[] cookieTokens, HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>    <span class="hljs-keyword">if</span> (cookieTokens.length != <span class="hljs-number">3</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidCookieException</span>(<span class="hljs-string">&quot;Cookie token did not contain 3 tokens, but contained &#x27;&quot;</span> + Arrays.asList(cookieTokens) + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">tokenExpiryTime</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getTokenExpiryTime(cookieTokens);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isTokenExpired(tokenExpiryTime)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidCookieException</span>(<span class="hljs-string">&quot;Cookie token[1] has expired (expired on &#x27;&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(tokenExpiryTime) + <span class="hljs-string">&quot;&#x27;; current time is &#x27;&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() + <span class="hljs-string">&quot;&#x27;)&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getUserDetailsService().loadUserByUsername(cookieTokens[<span class="hljs-number">0</span>]);<br>            Assert.notNull(userDetails, () -&gt; &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;UserDetailsService &quot;</span> + <span class="hljs-built_in">this</span>.getUserDetailsService() + <span class="hljs-string">&quot; returned null for username &quot;</span> + cookieTokens[<span class="hljs-number">0</span>] + <span class="hljs-string">&quot;. This is an interface contract violation&quot;</span>;<br>            &#125;);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">expectedTokenSignature</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.makeTokenSignature(tokenExpiryTime, userDetails.getUsername(), userDetails.getPassword());<br>            <span class="hljs-keyword">if</span> (!equals(expectedTokenSignature, cookieTokens[<span class="hljs-number">2</span>])) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidCookieException</span>(<span class="hljs-string">&quot;Cookie token[2] contained signature &#x27;&quot;</span> + cookieTokens[<span class="hljs-number">2</span>] + <span class="hljs-string">&quot;&#x27; but expected &#x27;&quot;</span> + expectedTokenSignature + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> userDetails;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>判断cookie长度为3否则报错</p>
<p>获取cookie中的时间戳查看如果超时则报错</p>
<p>获取用户名并去数据库查找如果为空则报错</p>
<p>首先将用户名、令牌过期时间、用户密码以及key组成一个字符串，中间用“:”隔开，然后通过MD5消息摘要算法对该字符串进行加密，并将加密结果转为一个字符串返回。</p>
<p>然后判断加密的字符串与cookie[2]是否相等不相等报错相等则返回用户对象</p>
<p>实现方法二:</p>
<p>onLoginSuccess</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLoginSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication successfulAuthentication)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.retrieveUserName(successfulAuthentication);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.retrievePassword(successfulAuthentication);<br>    <span class="hljs-keyword">if</span> (!StringUtils.hasLength(username)) &#123;<br>        <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Unable to retrieve username&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (!StringUtils.hasLength(password)) &#123;<br>            <span class="hljs-type">UserDetails</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getUserDetailsService().loadUserByUsername(username);<br>            password = user.getPassword();<br>            <span class="hljs-keyword">if</span> (!StringUtils.hasLength(password)) &#123;<br>                <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Unable to obtain password for user: &quot;</span> + username);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">tokenLifetime</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.calculateLoginLifetime(request, successfulAuthentication);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">expiryTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        expiryTime += <span class="hljs-number">1000L</span> * (<span class="hljs-type">long</span>)(tokenLifetime &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">1209600</span> : tokenLifetime);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">signatureValue</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.makeTokenSignature(expiryTime, username, password);<br>        <span class="hljs-built_in">this</span>.setCookie(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;username, Long.toString(expiryTime), signatureValue&#125;, tokenLifetime, request, response);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isDebugEnabled()) &#123;<br>            <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Added remember-me cookie for user &#x27;&quot;</span> + username + <span class="hljs-string">&quot;&#x27;, expiry: &#x27;&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(expiryTime) + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>首先获取用户名和密码,判断用户名和密码是否为空,如果密码为空则用用户名去数据库中获取</p>
<p>然后生成一个默认两周时间的令牌,然后根据过期时间、用户名、密码和key来生成一个字符串并将所有信息转换为字符串进行加密并使用base64进行编码加密后发送给前端</p>
<h4 id="PersistentTokenBasedRememberMeServices"><a href="#PersistentTokenBasedRememberMeServices" class="headerlink" title="PersistentTokenBasedRememberMeServices"></a>PersistentTokenBasedRememberMeServices</h4><p>持久化！令牌认证:smirk:</p>
<p>在持久化令牌中，存储在数据库中的数据被封装成了一个对象PersistentRememberMeToken</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PersistentRememberMeToken</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String username;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String series;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String tokenValue;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Date date;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>他和TokenBasedRememberMeServices一样重写了processAutoLoginCookie和onLoginSuccess方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> UserDetails <span class="hljs-title function_">processAutoLoginCookie</span><span class="hljs-params">(String[] cookieTokens, HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>    <span class="hljs-keyword">if</span> (cookieTokens.length != <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidCookieException</span>(<span class="hljs-string">&quot;Cookie token did not contain 2 tokens, but contained &#x27;&quot;</span> + Arrays.asList(cookieTokens) + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">presentedSeries</span> <span class="hljs-operator">=</span> cookieTokens[<span class="hljs-number">0</span>];<br>        <span class="hljs-type">String</span> <span class="hljs-variable">presentedToken</span> <span class="hljs-operator">=</span> cookieTokens[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">PersistentRememberMeToken</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.tokenRepository.getTokenForSeries(presentedSeries);<br>        <span class="hljs-keyword">if</span> (token == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RememberMeAuthenticationException</span>(<span class="hljs-string">&quot;No persistent token found for series id: &quot;</span> + presentedSeries);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!presentedToken.equals(token.getTokenValue())) &#123;<br>            <span class="hljs-built_in">this</span>.tokenRepository.removeUserTokens(token.getUsername());<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CookieTheftException</span>(<span class="hljs-built_in">this</span>.messages.getMessage(<span class="hljs-string">&quot;PersistentTokenBasedRememberMeServices.cookieStolen&quot;</span>, <span class="hljs-string">&quot;Invalid remember-me token (Series/token) mismatch. Implies previous cookie theft attack.&quot;</span>));<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token.getDate().getTime() + (<span class="hljs-type">long</span>)<span class="hljs-built_in">this</span>.getTokenValiditySeconds() * <span class="hljs-number">1000L</span> &lt; System.currentTimeMillis()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RememberMeAuthenticationException</span>(<span class="hljs-string">&quot;Remember-me login has expired&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">this</span>.logger.debug(LogMessage.format(<span class="hljs-string">&quot;Refreshing persistent login token for user &#x27;%s&#x27;, series &#x27;%s&#x27;&quot;</span>, token.getUsername(), token.getSeries()));<br>            <span class="hljs-type">PersistentRememberMeToken</span> <span class="hljs-variable">newToken</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PersistentRememberMeToken</span>(token.getUsername(), token.getSeries(), <span class="hljs-built_in">this</span>.generateTokenData(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-built_in">this</span>.tokenRepository.updateToken(newToken.getSeries(), newToken.getTokenValue(), newToken.getDate());<br>                <span class="hljs-built_in">this</span>.addCookie(newToken, request, response);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception var9) &#123;<br>                <span class="hljs-built_in">this</span>.logger.error(<span class="hljs-string">&quot;Failed to update token: &quot;</span>, var9);<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RememberMeAuthenticationException</span>(<span class="hljs-string">&quot;Autologin failed due to data access problem&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getUserDetailsService().loadUserByUsername(token.getUsername());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>与TokenBasedRememberMeServices不一样的是该方法从cookie中获取两个值,一个是series另一个为tokene.</p>
<p>首先从tokenRepository中根据series查找是否存在token如果不存在则报错</p>
<p>然后进行验证,验证失败则报错</p>
<p>再然后进行验证是否过期</p>
<p>都通过后则创建一个newtoken(series和用户名不变,日期为当前日期token重新生成)</p>
<p>然后更新数据库的series,token,date</p>
<p>然后将刚刚创建的newtoken放入cookie中</p>
<p>最后根据用户名查找用户信息并返回</p>
<p>再来看onLoginSuccess</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLoginSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication successfulAuthentication)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> successfulAuthentication.getName();<br>    <span class="hljs-built_in">this</span>.logger.debug(LogMessage.format(<span class="hljs-string">&quot;Creating new persistent login for user %s&quot;</span>, username));<br>    <span class="hljs-type">PersistentRememberMeToken</span> <span class="hljs-variable">persistentToken</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PersistentRememberMeToken</span>(username, <span class="hljs-built_in">this</span>.generateSeriesData(), <span class="hljs-built_in">this</span>.generateTokenData(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">this</span>.tokenRepository.createNewToken(persistentToken);<br>        <span class="hljs-built_in">this</span>.addCookie(persistentToken, request, response);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception var7) &#123;<br>        <span class="hljs-built_in">this</span>.logger.error(<span class="hljs-string">&quot;Failed to save persistent token &quot;</span>, var7);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>登录成功后，构建一个PersistentRememberMeToken对象，对象中的series和token参数都是随机生成的，然后将生成的对象存入数据库中，再调用addCookie方法添加相关的Cookie信息。</p>
<p>PersistentTokenBasedRememberMeServices和TokenBasedRememberMeServices还是有一些明显的区别的：前者返回给前端的令牌是将series和token组成的字符串进行Base64编码后返回给前端；后者返回给前端的令牌则是将用户名、过期时间以及签名组成的字符串进行Base64编码后返回给前端。</p>
<blockquote>
<p>如果开发者配置了tokenRepository，则获取到的RememberMeServices实例是&#x3D;&#x3D;PersistentTokenBasedRememberMe Services&#x3D;&#x3D;，否则获取到TokenBasedRememberMeServices，即系统通过有没有配置tokenRepository来确定使用哪种类型的RememberMeServices。</p>
</blockquote>
<h4 id="从配置文件中来看"><a href="#从配置文件中来看" class="headerlink" title="从配置文件中来看"></a>从配置文件中来看</h4><p>解释不清了上图!!!!!!</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211019145309554.png" srcset="/img/loading.gif" lazyload alt="image-20211019145309554"></p>
<p>看见吗返回的时RememberMeConfigurer</p>
<p>而这个类的爹是AbstractHttpConfigurer它实现的又是SecurityConfigurer</p>
<p>在源码中得知该类重写了init方法和config方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(H http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-built_in">this</span>.validateInput();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getKey();<br>    <span class="hljs-type">RememberMeServices</span> <span class="hljs-variable">rememberMeServices</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getRememberMeServices(http, key);<br>    http.setSharedObject(RememberMeServices.class, rememberMeServices);<br>    LogoutConfigurer&lt;H&gt; logoutConfigurer = (LogoutConfigurer)http.getConfigurer(LogoutConfigurer.class);<br>    <span class="hljs-keyword">if</span> (logoutConfigurer != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-built_in">this</span>.logoutHandler != <span class="hljs-literal">null</span>) &#123;<br>        logoutConfigurer.addLogoutHandler(<span class="hljs-built_in">this</span>.logoutHandler);<br>    &#125;<br><br>    <span class="hljs-type">RememberMeAuthenticationProvider</span> <span class="hljs-variable">authenticationProvider</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RememberMeAuthenticationProvider</span>(key);<br>    authenticationProvider = (RememberMeAuthenticationProvider)<span class="hljs-built_in">this</span>.postProcess(authenticationProvider);<br>    http.authenticationProvider(authenticationProvider);<br>    <span class="hljs-built_in">this</span>.initDefaultLoginFilter(http);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>validateInput方法是用来判断rememberMeServices是否为空和cookie中是否有remember-me字段</p>
<p>之后会获取key如果没有设置key则会使用UUID</p>
<blockquote>
<p>如果开发者使用普通的RememberMe，即没有使用持久化令牌，则建议开发者自行配置该key，因为使用默认的UUID字符串，系统每次重启都会生成新的key，会导致之前下发的remember-me失效。</p>
</blockquote>
<p>有了key之后，接下来再去获取RememberMeServices实例，如果开发者配置了tokenRepository，则获取到的RememberMeServices实例是PersistentTokenBasedRememberMe Services，否则获取到TokenBasedRememberMeServices，即系统通过有没有配置tokenRepository来确定使用哪种类型的RememberMeServices。</p>
<p>之后就会调用RememberMeAuthenticationProvider(key);方法来创建一个认证类主要用来校验key</p>
<p>再来看config方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(H http)</span> &#123;<br>    <span class="hljs-type">RememberMeAuthenticationFilter</span> <span class="hljs-variable">rememberMeFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RememberMeAuthenticationFilter</span>((AuthenticationManager)http.getSharedObject(AuthenticationManager.class), <span class="hljs-built_in">this</span>.rememberMeServices);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.authenticationSuccessHandler != <span class="hljs-literal">null</span>) &#123;<br>        rememberMeFilter.setAuthenticationSuccessHandler(<span class="hljs-built_in">this</span>.authenticationSuccessHandler);<br>    &#125;<br><br>    rememberMeFilter = (RememberMeAuthenticationFilter)<span class="hljs-built_in">this</span>.postProcess(rememberMeFilter);<br>    http.addFilter(rememberMeFilter);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>configure方法中主要创建了一个RememberMeAuthenticationFilter，创建时传入Remember MeServices实例，最后将创建好的RememberMeAuthenticationFilter加入到过滤器链中。</p>
<p>然后看看RememberMeAuthenticationFilter的doFilter方法是怎么运行的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>    <span class="hljs-keyword">if</span> (SecurityContextHolder.getContext().getAuthentication() != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-built_in">this</span>.logger.debug(LogMessage.of(() -&gt; &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SecurityContextHolder not populated with remember-me token, as it already contained: &#x27;&quot;</span> + SecurityContextHolder.getContext().getAuthentication() + <span class="hljs-string">&quot;&#x27;&quot;</span>;<br>        &#125;));<br>        chain.doFilter(request, response);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">Authentication</span> <span class="hljs-variable">rememberMeAuth</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.rememberMeServices.autoLogin(request, response);<br>        <span class="hljs-keyword">if</span> (rememberMeAuth != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                rememberMeAuth = <span class="hljs-built_in">this</span>.authenticationManager.authenticate(rememberMeAuth);<br>                SecurityContextHolder.getContext().setAuthentication(rememberMeAuth);<br>                <span class="hljs-built_in">this</span>.onSuccessfulAuthentication(request, response, rememberMeAuth);<br>                <span class="hljs-built_in">this</span>.logger.debug(LogMessage.of(() -&gt; &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SecurityContextHolder populated with remember-me token: &#x27;&quot;</span> + SecurityContextHolder.getContext().getAuthentication() + <span class="hljs-string">&quot;&#x27;&quot;</span>;<br>                &#125;));<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.eventPublisher != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-built_in">this</span>.eventPublisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InteractiveAuthenticationSuccessEvent</span>(SecurityContextHolder.getContext().getAuthentication(), <span class="hljs-built_in">this</span>.getClass()));<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.successHandler != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-built_in">this</span>.successHandler.onAuthenticationSuccess(request, response, rememberMeAuth);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (AuthenticationException var6) &#123;<br>                <span class="hljs-built_in">this</span>.logger.debug(LogMessage.format(<span class="hljs-string">&quot;SecurityContextHolder not populated with remember-me token, as AuthenticationManager rejected Authentication returned by RememberMeServices: &#x27;%s&#x27;; invalidating remember-me token&quot;</span>, rememberMeAuth), var6);<br>                <span class="hljs-built_in">this</span>.rememberMeServices.loginFail(request, response);<br>                <span class="hljs-built_in">this</span>.onUnsuccessfulAuthentication(request, response, var6);<br>            &#125;<br>        &#125;<br><br>        chain.doFilter(request, response);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>首先判断是否登陆过,没有登陆过则进行自动登录(就是前两节说的实现了autoLogin方法),如果自动登录后返回null,则登录失败.</p>
<p>当登录成功后则调用authenticate方法对key进行校验成功后会将用户数据放入SecurityContextHolder中,并报告登录成功(但不调用loginSuccess方法)</p>
<blockquote>
<p>最后再额外说一下RememberMeServices#loginSuccess方法的调用位置。该方法是在AbstractAuthenticationProcessingFilter#successfulAuthentication中触发的，也就是说，无论你是否开启了RememberMe功能，该方法都会被调用。只不过在RememberMeServices#loginSuccess方法的具体实现中，会去判断是否开启了RememberMe，进而决定是否在响应中添加对应的Cookie。</p>
</blockquote>
<p>如果自动登录失败，则调用rememberMeServices.loginFail方法处理登录失败回调。onUnsuccessfulAuthentication和onSuccessfulAuthentication都是该过滤器中定义的空方法，并没有任何实现。</p>
<h3 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h3><p>HttpSession相关的功能由SessionManagementFilter和SessionAuthenticationStrategy接口来处理，SessionManagementFilter过滤器将Session相关操作委托给SessionAuthenticationStrategy接口去完成。</p>
<h4 id="并发管理"><a href="#并发管理" class="headerlink" title="并发管理"></a>并发管理</h4><p>就是同一时间允许几个用户同时登录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SessionConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.inMemoryAuthentication().withUser(<span class="hljs-string">&quot;YH&quot;</span>).password(<span class="hljs-string">&quot;&#123;noop&#125;123456&quot;</span>).roles(<span class="hljs-string">&quot;admin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests()<br>                .anyRequest()<br>                .authenticated()<br>                .and()<br>                .formLogin()<br>                .and()<br>                .csrf()<br>                .disable()<br>                .sessionManagement()<br>                .maximumSessions(<span class="hljs-number">1</span>);<span class="hljs-comment">//只允许一个用户</span><br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    HttpSessionEventPublisher <span class="hljs-title function_">httpSessionEventPublisher</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpSessionEventPublisher</span>();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>例如这种定义方式只允许一个用户登陆</p>
<p>而HttpSessionEventPublisher则是用来监听HttpSession的创建和销毁(当用户登录则会创建,当用户注销则会销毁)</p>
<p>使用上面这种方式后登录的用户会&#x3D;&#x3D;顶掉&#x3D;&#x3D;前面的登录用户</p>
<p>例如我在chrome使用YH来登录再用星愿使用YH登录,则chrome用户则会被&#x3D;&#x3D;顶掉&#x3D;&#x3D;</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211020102553565.png" srcset="/img/loading.gif" lazyload alt="image-20211020102553565"></p>
<p>如果是前后端分离的项目则需要返回一个json,将config中的内容修改为下面这种</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">http.authorizeRequests()<br>           .anyRequest().authenticated()<br>           .and()<br>           .formLogin()<br>           .and()<br>           .csrf()<br>           .disable()<br>           .sessionManagement()<br>           .maximumSessions(<span class="hljs-number">1</span>)<br>           .expiredSessionStrategy(event -&gt; &#123;<br>               <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> event.getResponse();<br>               response.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);<br>               Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>               result.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">500</span>);<br>               result.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;当前会话已经失效，请重新登录&quot;</span>);<br>               <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(result);<br>               response.getWriter().print(s);<br>               response.flushBuffer();<br>           &#125;);<br></code></pre></td></tr></table></figure>



<p>如果想要阻止后来的用户登录则设置maxSessionsPreventsLogin(true)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">http.authorizeRequests()<br>        .anyRequest()<br>        .authenticated()<br>        .and()<br>        .formLogin()<br>        .and()<br>        .csrf()<br>        .disable()<br>        .sessionManagement()<br>        .maximumSessions(<span class="hljs-number">1</span>)<br>        .maxSessionsPreventsLogin(<span class="hljs-literal">true</span>);<span class="hljs-comment">//这里</span><br></code></pre></td></tr></table></figure>





<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>首先是会话记录使用的类</p>
<h5 id="SessionInformation"><a href="#SessionInformation" class="headerlink" title="SessionInformation"></a>SessionInformation</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SessionInformation</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> SpringSecurityCoreVersion.SERIAL_VERSION_UID;<br>	<span class="hljs-comment">//最后一次登录时间</span><br>	<span class="hljs-keyword">private</span> Date lastRequest;<br>	<span class="hljs-comment">//用户实体对象</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object principal;<br>	<span class="hljs-comment">//会话Id</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String sessionId;<br>	<span class="hljs-comment">//会话是否过期</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">expired</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="SessionRegistry"><a href="#SessionRegistry" class="headerlink" title="SessionRegistry"></a>SessionRegistry</h5><p>是用来维护SessionInformation的信息,而它只有一个实现类SessionRegistryImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SessionRegistryImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SessionRegistry</span>, ApplicationListener&lt;AbstractSessionEvent&gt; &#123;<br><br>	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogFactory.getLog(SessionRegistryImpl.class);<br><br>	<span class="hljs-comment">// &lt;principal:Object,SessionIdSet&gt;</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;Object, Set&lt;String&gt;&gt; principals;<br><br>	<span class="hljs-comment">// &lt;sessionId:Object,SessionInformation&gt;</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, SessionInformation&gt; sessionIds;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-title function_">SessionRegistryImpl</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-built_in">this</span>.principals = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>		<span class="hljs-built_in">this</span>.sessionIds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-title function_">SessionRegistryImpl</span><span class="hljs-params">(ConcurrentMap&lt;Object, Set&lt;String&gt;&gt; principals,</span><br><span class="hljs-params">			Map&lt;String, SessionInformation&gt; sessionIds)</span> &#123;<br>		<span class="hljs-built_in">this</span>.principals = principals;<br>		<span class="hljs-built_in">this</span>.sessionIds = sessionIds;<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> List&lt;Object&gt; <span class="hljs-title function_">getAllPrincipals</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-built_in">this</span>.principals.keySet());<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> List&lt;SessionInformation&gt; <span class="hljs-title function_">getAllSessions</span><span class="hljs-params">(Object principal, <span class="hljs-type">boolean</span> includeExpiredSessions)</span> &#123;<br>		Set&lt;String&gt; sessionsUsedByPrincipal = <span class="hljs-built_in">this</span>.principals.get(principal);<br>		<span class="hljs-keyword">if</span> (sessionsUsedByPrincipal == <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-keyword">return</span> Collections.emptyList();<br>		&#125;<br>		List&lt;SessionInformation&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(sessionsUsedByPrincipal.size());<br>		<span class="hljs-keyword">for</span> (String sessionId : sessionsUsedByPrincipal) &#123;<br>			<span class="hljs-type">SessionInformation</span> <span class="hljs-variable">sessionInformation</span> <span class="hljs-operator">=</span> getSessionInformation(sessionId);<br>			<span class="hljs-keyword">if</span> (sessionInformation == <span class="hljs-literal">null</span>) &#123;<br>				<span class="hljs-keyword">continue</span>;<br>			&#125;<br>			<span class="hljs-keyword">if</span> (includeExpiredSessions || !sessionInformation.isExpired()) &#123;<br>				list.add(sessionInformation);<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">return</span> list;<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> SessionInformation <span class="hljs-title function_">getSessionInformation</span><span class="hljs-params">(String sessionId)</span> &#123;<br>		Assert.hasText(sessionId, <span class="hljs-string">&quot;SessionId required as per interface contract&quot;</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.sessionIds.get(sessionId);<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onApplicationEvent</span><span class="hljs-params">(AbstractSessionEvent event)</span> &#123;<br>		<span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> SessionDestroyedEvent) &#123;<br>			<span class="hljs-type">SessionDestroyedEvent</span> <span class="hljs-variable">sessionDestroyedEvent</span> <span class="hljs-operator">=</span> (SessionDestroyedEvent) event;<br>			<span class="hljs-type">String</span> <span class="hljs-variable">sessionId</span> <span class="hljs-operator">=</span> sessionDestroyedEvent.getId();<br>			removeSessionInformation(sessionId);<br>		&#125;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> SessionIdChangedEvent) &#123;<br>			<span class="hljs-type">SessionIdChangedEvent</span> <span class="hljs-variable">sessionIdChangedEvent</span> <span class="hljs-operator">=</span> (SessionIdChangedEvent) event;<br>			<span class="hljs-type">String</span> <span class="hljs-variable">oldSessionId</span> <span class="hljs-operator">=</span> sessionIdChangedEvent.getOldSessionId();<br>			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sessionIds.containsKey(oldSessionId)) &#123;<br>				<span class="hljs-type">Object</span> <span class="hljs-variable">principal</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.sessionIds.get(oldSessionId).getPrincipal();<br>				removeSessionInformation(oldSessionId);<br>				registerNewSession(sessionIdChangedEvent.getNewSessionId(), principal);<br>			&#125;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refreshLastRequest</span><span class="hljs-params">(String sessionId)</span> &#123;<br>		Assert.hasText(sessionId, <span class="hljs-string">&quot;SessionId required as per interface contract&quot;</span>);<br>		<span class="hljs-type">SessionInformation</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> getSessionInformation(sessionId);<br>		<span class="hljs-keyword">if</span> (info != <span class="hljs-literal">null</span>) &#123;<br>			info.refreshLastRequest();<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerNewSession</span><span class="hljs-params">(String sessionId, Object principal)</span> &#123;<br>		Assert.hasText(sessionId, <span class="hljs-string">&quot;SessionId required as per interface contract&quot;</span>);<br>		Assert.notNull(principal, <span class="hljs-string">&quot;Principal required as per interface contract&quot;</span>);<br>		<span class="hljs-keyword">if</span> (getSessionInformation(sessionId) != <span class="hljs-literal">null</span>) &#123;<br>			removeSessionInformation(sessionId);<br>		&#125;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isDebugEnabled()) &#123;<br>			<span class="hljs-built_in">this</span>.logger.debug(LogMessage.format(<span class="hljs-string">&quot;Registering session %s, for principal %s&quot;</span>, sessionId, principal));<br>		&#125;<br>		<span class="hljs-built_in">this</span>.sessionIds.put(sessionId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SessionInformation</span>(principal, sessionId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));<br>		<span class="hljs-built_in">this</span>.principals.compute(principal, (key, sessionsUsedByPrincipal) -&gt; &#123;<br>			<span class="hljs-keyword">if</span> (sessionsUsedByPrincipal == <span class="hljs-literal">null</span>) &#123;<br>				sessionsUsedByPrincipal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArraySet</span>&lt;&gt;();<br>			&#125;<br>			sessionsUsedByPrincipal.add(sessionId);<br>			<span class="hljs-built_in">this</span>.logger.trace(LogMessage.format(<span class="hljs-string">&quot;Sessions used by &#x27;%s&#x27; : %s&quot;</span>, principal, sessionsUsedByPrincipal));<br>			<span class="hljs-keyword">return</span> sessionsUsedByPrincipal;<br>		&#125;);<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeSessionInformation</span><span class="hljs-params">(String sessionId)</span> &#123;<br>		Assert.hasText(sessionId, <span class="hljs-string">&quot;SessionId required as per interface contract&quot;</span>);<br>		<span class="hljs-type">SessionInformation</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> getSessionInformation(sessionId);<br>		<span class="hljs-keyword">if</span> (info == <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isTraceEnabled()) &#123;<br>			<span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">&quot;Removing session &quot;</span> + sessionId + <span class="hljs-string">&quot; from set of registered sessions&quot;</span>);<br>		&#125;<br>		<span class="hljs-built_in">this</span>.sessionIds.remove(sessionId);<br>		<span class="hljs-built_in">this</span>.principals.computeIfPresent(info.getPrincipal(), (key, sessionsUsedByPrincipal) -&gt; &#123;<br>			<span class="hljs-built_in">this</span>.logger.debug(<br>					LogMessage.format(<span class="hljs-string">&quot;Removing session %s from principal&#x27;s set of registered sessions&quot;</span>, sessionId));<br>			sessionsUsedByPrincipal.remove(sessionId);<br>			<span class="hljs-keyword">if</span> (sessionsUsedByPrincipal.isEmpty()) &#123;<br>				<span class="hljs-comment">// No need to keep object in principals Map anymore</span><br>				<span class="hljs-built_in">this</span>.logger.debug(LogMessage.format(<span class="hljs-string">&quot;Removing principal %s from registry&quot;</span>, info.getPrincipal()));<br>				sessionsUsedByPrincipal = <span class="hljs-literal">null</span>;<br>			&#125;<br>			<span class="hljs-built_in">this</span>.logger.trace(<br>					LogMessage.format(<span class="hljs-string">&quot;Sessions used by &#x27;%s&#x27; : %s&quot;</span>, info.getPrincipal(), sessionsUsedByPrincipal));<br>			<span class="hljs-keyword">return</span> sessionsUsedByPrincipal;<br>		&#125;);<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>首先是两个变量</li>
</ul>
<p>sessionIds:用来根据sessionId来获取session</p>
<p>principals:用来存储用户与sessionId之间的映射关系</p>
<blockquote>
<p>由于principals集合中采用当前登录用户对象做key，将对象作为集合中的key，需要重写其equals方法和hashCode方法。在前面的案例中，由于我们使用了系统默认定义的User类，该类已经重写了equals方法和hashCode方法。&#x3D;&#x3D;如果开发者自定义用户类，记得重写其equals方法和hashCode方法&#x3D;&#x3D;，否则会话并发管理会失效。</p>
</blockquote>
<ul>
<li>其次是方法</li>
</ul>
<p>getAllPrincipals:用来获取所有用户对象</p>
<p>getAllSessions:根据用户名来获取SessionInformation,可以指定是否过去过期的session</p>
<p>onApplicationEvent:根据事件来决定是更新session还是销毁session</p>
<p>registerNewSession:当用户登录成功后，会执行会话保存操作，传入当前请求的sessionId和当前登录主体principal对象。如果sessionId已经存在，则先将其移除，然后先往sessionIds中保存，key是sessionId，value则是一个新创建的SessionInformation对象。在向principals集合中保存时使用了compute方法（如果读者对Java8中的compute方法还不太熟悉，可以自行学习，这里不做过多介绍），第一个参数就是当前登录主体，第二个参数则进行了计算。如果当前登录主体在principals中已经有对应的value，则在value的基础上继续添加一个sessionId。如果当前登录主体在principals中没有对应的value，则新建一个sessionsUsedByPrincipal对象，然后再将sessionId添加进去。</p>
<p>removeSessionInformation:移除session,移除也是两方面的工作，一方面就是从sessionIds变量中移除，这个直接调用remove方法即可；另一方面就是从principals变量中移除，principals中key是当前登录的用户对象，value则是一个集合，里边保存着当前用户对应的所有sessionId，这里主要是移除value中对应的sessionId。</p>
<h5 id="SessionAuthenticationStrategy"><a href="#SessionAuthenticationStrategy" class="headerlink" title="SessionAuthenticationStrategy"></a>SessionAuthenticationStrategy</h5><p>主要用于登录成功后对httpSession的操作</p>
<p>实现类有以下几种</p>
<ul>
<li>CsrfAuthenticationStrategy：CsrfAuthenticationStrategy和CSRF攻击有关，该类主要负责在身份验证后删除旧的CsrfToken并生成一个新的CsrfToken。</li>
<li>ConcurrentSessionControlAuthenticationStrategy：该类主要用来处理Session并发问题。前面案例中Session并发的控制，实际上就是通过该类来完成的。</li>
<li>RegisterSessionAuthenticationStrategy：该类用于在认证成功后将HttpSession信息记录到SessionRegistry中。</li>
<li>CompositeSessionAuthenticationStrategy：这是一个复合策略，它里边维护了一个集合，集合中保存了多个不同的SessionAuthenticationStrategy对象，相当于该类代理了多个SessionAuthenticationStrategy对象，大部分情况下，在Spring Security框架中直接使用的也是该类的实例。</li>
<li>NullAuthenticatedSessionStrategy：这是一个空的实现，未做任何处理。</li>
<li>AbstractSessionFixationProtectionStrategy：处理会话固定攻击的基类。</li>
<li>ChangeSessionIdAuthenticationStrategy：通过修改sessionId来防止会话固定攻击。</li>
<li>SessionFixationProtectionStrategy：通过创建一个新的会话来防止会话固定攻击。</li>
</ul>
<p>主要起作用的是:ConcurrentSessionControlAuthenticationStrategy</p>
<p>重点来看onAuthentication方法(实现方法)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthentication</span><span class="hljs-params">(Authentication authentication, HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">allowedSessions</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getMaximumSessionsForThisUser(authentication);<br>    <span class="hljs-keyword">if</span> (allowedSessions != -<span class="hljs-number">1</span>) &#123;<br>        List&lt;SessionInformation&gt; sessions = <span class="hljs-built_in">this</span>.sessionRegistry.getAllSessions(authentication.getPrincipal(), <span class="hljs-literal">false</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">sessionCount</span> <span class="hljs-operator">=</span> sessions.size();<br>        <span class="hljs-keyword">if</span> (sessionCount &gt;= allowedSessions) &#123;<br>            <span class="hljs-keyword">if</span> (sessionCount == allowedSessions) &#123;<br>                <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> request.getSession(<span class="hljs-literal">false</span>);<br>                <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-type">Iterator</span> <span class="hljs-variable">var8</span> <span class="hljs-operator">=</span> sessions.iterator();<br><br>                    <span class="hljs-keyword">while</span>(var8.hasNext()) &#123;<br>                        <span class="hljs-type">SessionInformation</span> <span class="hljs-variable">si</span> <span class="hljs-operator">=</span> (SessionInformation)var8.next();<br>                        <span class="hljs-keyword">if</span> (si.getSessionId().equals(session.getId())) &#123;<br>                            <span class="hljs-keyword">return</span>;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-built_in">this</span>.allowableSessionsExceeded(sessions, allowedSessions, <span class="hljs-built_in">this</span>.sessionRegistry);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果为-1则代表不限制最大登录数则之间返回.</p>
<p>如果小于最大链接数则直接返回</p>
<p>如果等于最大连接数则在session中查找是否存在该session如果存在则直接返回</p>
<p>以上都不满足则进入以下代码</p>
<p>allowableSessionsExceeded</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">allowableSessionsExceeded</span><span class="hljs-params">(List&lt;SessionInformation&gt; sessions, <span class="hljs-type">int</span> allowableSessions, SessionRegistry registry)</span> <span class="hljs-keyword">throws</span> SessionAuthenticationException &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.exceptionIfMaximumExceeded &amp;&amp; sessions != <span class="hljs-literal">null</span>) &#123;<br>        sessions.sort(Comparator.comparing(SessionInformation::getLastRequest));<br>        <span class="hljs-type">int</span> <span class="hljs-variable">maximumSessionsExceededBy</span> <span class="hljs-operator">=</span> sessions.size() - allowableSessions + <span class="hljs-number">1</span>;<br>        List&lt;SessionInformation&gt; sessionsToBeExpired = sessions.subList(<span class="hljs-number">0</span>, maximumSessionsExceededBy);<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> sessionsToBeExpired.iterator();<br><br>        <span class="hljs-keyword">while</span>(var6.hasNext()) &#123;<br>            <span class="hljs-type">SessionInformation</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> (SessionInformation)var6.next();<br>            session.expireNow();<br>        &#125;<br><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SessionAuthenticationException</span>(<span class="hljs-built_in">this</span>.messages.getMessage(<span class="hljs-string">&quot;ConcurrentSessionControlAuthenticationStrategy.exceededAllowed&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;allowableSessions&#125;, <span class="hljs-string">&quot;Maximum sessions of &#123;0&#125; for this principal exceeded&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果exceptionIfMaximumExceeded属性为true，则直接抛出异常，该属性的值也就是我们在SecurityConfig中通过maxSessionsPreventsLogin方法配置的值，即禁止后来者登录，抛出异常后，本次登录失败。否则说明不禁止后来者登录，此时对查询出来的当前用户所有登录会话按照最后一次请求时间进行排序，然后计算出需要过期的session数量，从sessions集合中取出来进行遍历，依次调用其expireNow方法使之过期。<br>这便是ConcurrentSessionControlAuthenticationStrategy类的实现逻辑。</p>
<h6 id="RegisterSessionAuthenticationStrategy"><a href="#RegisterSessionAuthenticationStrategy" class="headerlink" title="RegisterSessionAuthenticationStrategy"></a>RegisterSessionAuthenticationStrategy</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegisterSessionAuthenticationStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SessionAuthenticationStrategy</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SessionRegistry sessionRegistry;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RegisterSessionAuthenticationStrategy</span><span class="hljs-params">(SessionRegistry sessionRegistry)</span> &#123;<br>        Assert.notNull(sessionRegistry, <span class="hljs-string">&quot;The sessionRegistry cannot be null&quot;</span>);<br>        <span class="hljs-built_in">this</span>.sessionRegistry = sessionRegistry;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthentication</span><span class="hljs-params">(Authentication authentication, HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-built_in">this</span>.sessionRegistry.registerNewSession(request.getSession().getId(), authentication.getPrincipal());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看出该类就是调用了上面的SessionRegistry的registerNewSession方法来传入sessionid和用户对象</p>
<h6 id="CompositeSessionAuthenticationStrategy"><a href="#CompositeSessionAuthenticationStrategy" class="headerlink" title="CompositeSessionAuthenticationStrategy"></a>CompositeSessionAuthenticationStrategy</h6><p>查看该类的onAuthentication</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthentication</span><span class="hljs-params">(Authentication authentication, HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> SessionAuthenticationException &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">currentPosition</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.delegateStrategies.size();<br><br>    SessionAuthenticationStrategy delegate;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">Iterator</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.delegateStrategies.iterator(); var6.hasNext(); delegate.onAuthentication(authentication, request, response)) &#123;<br>        delegate = (SessionAuthenticationStrategy)var6.next();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isTraceEnabled()) &#123;<br>            <span class="hljs-type">Log</span> <span class="hljs-variable">var10000</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.logger;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">var10002</span> <span class="hljs-operator">=</span> delegate.getClass().getSimpleName();<br>            ++currentPosition;<br>            var10000.trace(LogMessage.format(<span class="hljs-string">&quot;Preparing session with %s (%d/%d)&quot;</span>, var10002, currentPosition, size));<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看出该方法就是调用各个SessionAuthenticationStrategy的onAuthentication</p>
<p>所以!!!他是一个代理类~~~</p>
<h5 id="SessionManagementFilter"><a href="#SessionManagementFilter" class="headerlink" title="SessionManagementFilter"></a>SessionManagementFilter</h5><p>主要用来处理RememberMe登录时的会话管理：即如果用户使用了RememberMe的方式进行认证，则认证成功后需要进行会话管理，相关的管理操作通过SessionManagementFilter过滤器触发。</p>
<p>通过containsContext方法去判断当前会话中是否存在SPRING_SECURITY_CONTEXT变量,emmm啥时候不存在呢:</p>
<p>（1）用户使用了RememberMe方式进行认证。<br>（2）用户匿名访问某一个接口。</p>
<p>然后根据这两种不同的认证则token也不一样第一种为RememberMeAuthenticationToken会对其进行</p>
<h5 id="ConcurrentSessionFilter"><a href="#ConcurrentSessionFilter" class="headerlink" title="ConcurrentSessionFilter"></a>ConcurrentSessionFilter</h5><p>在doFilter方法中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>    <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> request.getSession(<span class="hljs-literal">false</span>);<br>    <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">SessionInformation</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.sessionRegistry.getSessionInformation(session.getId());<br>        <span class="hljs-keyword">if</span> (info != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (info.isExpired()) &#123;<br>                <span class="hljs-built_in">this</span>.logger.debug(LogMessage.of(() -&gt; &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Requested session ID &quot;</span> + request.getRequestedSessionId() + <span class="hljs-string">&quot; has expired.&quot;</span>;<br>                &#125;));<br>                <span class="hljs-built_in">this</span>.doLogout(request, response);<br>                <span class="hljs-built_in">this</span>.sessionInformationExpiredStrategy.onExpiredSessionDetected(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SessionInformationExpiredEvent</span>(info, request, response));<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-built_in">this</span>.sessionRegistry.refreshLastRequest(info.getSessionId());<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>首先获取session如果不是空则,根据sessionId获取session信息并检测是否为空是否过期,如果都满足则刷新最后一次的请求时间,</p>
<p>如果过期了则进行登出</p>
<p>HttpSession的四种创建策略</p>
<ul>
<li>ALWAYS:HttpSession不存在就创建</li>
<li>NEVER:不存在也不创建,如果有就直接使用</li>
<li>IF_REQUIRED:如果需要才创建(默认)</li>
<li>STATELESS:从不创建HttpSession,也不使用HttpSession(无状态认证)</li>
</ul>
<p>如果用户想要指定用什么类型则：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    http.sessionManagement()<br>        .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED);<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="SessionManagementConfigurer"><a href="#SessionManagementConfigurer" class="headerlink" title="SessionManagementConfigurer"></a>SessionManagementConfigurer</h5><p>该configurer用来配置上面两个过滤器的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(H http)</span> &#123;<br>    <span class="hljs-type">SecurityContextRepository</span> <span class="hljs-variable">securityContextRepository</span> <span class="hljs-operator">=</span> (SecurityContextRepository)http.getSharedObject(SecurityContextRepository.class);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">stateless</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.isStateless();<br>    <span class="hljs-keyword">if</span> (securityContextRepository == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (stateless) &#123;<br>            http.setSharedObject(SecurityContextRepository.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullSecurityContextRepository</span>());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">HttpSessionSecurityContextRepository</span> <span class="hljs-variable">httpSecurityRepository</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpSessionSecurityContextRepository</span>();<br>            httpSecurityRepository.setDisableUrlRewriting(!<span class="hljs-built_in">this</span>.enableSessionUrlRewriting);<br>            httpSecurityRepository.setAllowSessionCreation(<span class="hljs-built_in">this</span>.isAllowSessionCreation());<br>            <span class="hljs-type">AuthenticationTrustResolver</span> <span class="hljs-variable">trustResolver</span> <span class="hljs-operator">=</span> (AuthenticationTrustResolver)http.getSharedObject(AuthenticationTrustResolver.class);<br>            <span class="hljs-keyword">if</span> (trustResolver != <span class="hljs-literal">null</span>) &#123;<br>                httpSecurityRepository.setTrustResolver(trustResolver);<br>            &#125;<br><br>            http.setSharedObject(SecurityContextRepository.class, httpSecurityRepository);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">RequestCache</span> <span class="hljs-variable">requestCache</span> <span class="hljs-operator">=</span> (RequestCache)http.getSharedObject(RequestCache.class);<br>    <span class="hljs-keyword">if</span> (requestCache == <span class="hljs-literal">null</span> &amp;&amp; stateless) &#123;<br>        http.setSharedObject(RequestCache.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullRequestCache</span>());<br>    &#125;<br><br>    http.setSharedObject(SessionAuthenticationStrategy.class, <span class="hljs-built_in">this</span>.getSessionAuthenticationStrategy(http));<br>    http.setSharedObject(InvalidSessionStrategy.class, <span class="hljs-built_in">this</span>.getInvalidSessionStrategy());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>首先从http中获取SecurityContextRepository，如果不为空则判断是否采用STATELESS策略</p>
<p>如果采用则设置一个NullSecurityContextRepository(空的),如果不是空则保存HttpSessionSecurityContextRepository对象</p>
<p>最后将SessionAuthenticationStrategy和InvalidSessionStrategy放入共享对象中</p>
<blockquote>
<p>其中SessionAuthenticationStrategy实例是通过getSession AuthenticationStrategy方法来获取的，在该方法中，一共构建了三个SessionAuthentication Strategy实例，分别是ConcurrentSessionControlAuthenticationStrategy、ChangeSessionId AuthenticationStrategy以及RegisterSessionAuthenticationStrategy，并将这三个实例由Composite SessionAuthenticationStrategy进行代理，所以getSessionAuthenticationStrategy方法最终返回的是CompositeSessionAuthenticationStrategy类的实例。</p>
</blockquote>
<p>防御固定会话攻击,在配置文件中做如下配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">http.sessionManagement().sessionFixation().changeSessionId();<br></code></pre></td></tr></table></figure>

<p>这个.changeSessionId();可以换成下面这些</p>
<blockquote>
<p>（1）changeSessionId()：用户登录成功后，直接修改HttpSession的SessionId即可，默认方案即此，对应的处理类是ChangeSessionIdAuthenticationStrategy。</p>
</blockquote>
<blockquote>
<p>（2）none()：用户登录成功后，HttpSession不做任何变化，对应的处理类是NullAuthenticatedSessionStrategy。</p>
</blockquote>
<blockquote>
<p>（3）migrateSession()：用户登录成功后，创建一个新的HttpSession对象，并将旧的HttpSession中的数据拷贝到新的HttpSession中，对应的处理类是SessionFixationProtection Strategy。</p>
</blockquote>
<blockquote>
<p>（4）newSession()：用户登录成功后，创建一个新的HttpSession对象，对应的处理类也是SessionFixationProtectionStrategy，只不过将其里边的migrateSessionAttributes属性设置为false。需要注意的是，该方法并非所有的属性都不拷贝，一些Spring Security使用的属性，如请求缓存，还是会从旧的HttpSession上复制到新的HttpSession。</p>
</blockquote>
<h3 id="HttpFirewall"><a href="#HttpFirewall" class="headerlink" title="HttpFirewall"></a>HttpFirewall</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HttpFirewall</span> &#123;<br>    FirewalledRequest <span class="hljs-title function_">getFirewalledRequest</span><span class="hljs-params">(HttpServletRequest var1)</span> <span class="hljs-keyword">throws</span> RequestRejectedException;<br><br>    HttpServletResponse <span class="hljs-title function_">getFirewalledResponse</span><span class="hljs-params">(HttpServletResponse var1)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看出只有两个接口函数</p>
<ul>
<li>getFirewalledRequest：用来对request进行封装并且在HttpServletRequestWrapper的基础上增加了reset方法。当过滤链完毕时，由FilterChainProxy来调用reset方法来重置属性</li>
<li>getFirewalledResponse：重写了sendRedirect、setHeader、addHeader以及addCookie四个方法，在每个方法中都添加一种过滤来过滤\n和\r</li>
</ul>
<p>他有两个实现类</p>
<p><img src="/.com//Users\lll\AppData\Roaming\Typora\typora-user-images\image-20211026151827472.png" srcset="/img/loading.gif" lazyload alt="image-20211026151827472"></p>
<ul>
<li>DefaultHttpFirewall:是一种宽松的防火墙</li>
<li>StrictHttpFirewall:默认的,是一种严格的防火墙</li>
</ul>
<p>由于FilterChainProxy是通过WebSecurity来构建的,而FilterChainProxy是默认使用StrictHttpFirewall来填充的.所以我们注册一个自己的HttpFirewallBean就会自动填充为自己的Bean</p>
<h4 id="HttpFirewall严格模式"><a href="#HttpFirewall严格模式" class="headerlink" title="HttpFirewall严格模式"></a>HttpFirewall严格模式</h4><p>由于在FilterChainProxy#doFilterInternal中触发请求校验的方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(ServletRequest request,ServletResponse response,FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>      <span class="hljs-type">FirewalledRequest</span> <span class="hljs-variable">fwRequest</span> <span class="hljs-operator">=</span> firewall<br>              .getFirewalledRequest((HttpServletRequest) request);<br>      <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">fwResponse</span> <span class="hljs-operator">=</span> firewall<br>              .getFirewalledResponse((HttpServletResponse) response);<br>      <span class="hljs-comment">//省略其他</span><br>      vfc.doFilter(fwRequest, fwResponse);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看出主要调用了getFirewalledRequest和getFirewalledResponse</p>
<p>通过源码可以看到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> FirewalledRequest <span class="hljs-title function_">getFirewalledRequest</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> RequestRejectedException &#123;<br>    <span class="hljs-built_in">this</span>.rejectForbiddenHttpMethod(request);<br>    <span class="hljs-built_in">this</span>.rejectedBlocklistedUrls(request);<br>    <span class="hljs-built_in">this</span>.rejectedUntrustedHosts(request);<br>    <span class="hljs-keyword">if</span> (!isNormalized(request)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestRejectedException</span>(<span class="hljs-string">&quot;The request was rejected because the URL was not normalized.&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">requestUri</span> <span class="hljs-operator">=</span> request.getRequestURI();<br>        <span class="hljs-keyword">if</span> (!containsOnlyPrintableAsciiCharacters(requestUri)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestRejectedException</span>(<span class="hljs-string">&quot;The requestURI was rejected because it can only contain printable ASCII characters.&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictHttpFirewall</span>.StrictFirewalledRequest(request);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>一共有五个校验:</p>
<ul>
<li><p>rejectForbiddenHttpMethod：校验请求方法是否合法。</p>
<ul>
<li><blockquote>
<pre><code class="java">private void rejectForbiddenHttpMethod(HttpServletRequest request) &#123;
if (this.allowedHttpMethods != ALLOW_ANY_HTTP_METHOD) &#123;
  if (!this.allowedHttpMethods.contains(request.getMethod())) &#123;
      throw new RequestRejectedException(&quot;The request was rejected because the HTTP method \&quot;&quot; + request.getMethod() + &quot;\&quot; was not included within the list of allowed HTTP methods &quot; + this.allowedHttpMethods);
  &#125;
&#125;
&#125;
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs scala"><br>- allowedHttpMethods是一个set集合默认情况下设置了<span class="hljs-type">DELETE</span>、<span class="hljs-type">GET</span>、<span class="hljs-type">HEAD</span>、<span class="hljs-type">OPTIONS</span>、<span class="hljs-type">PATCH</span>、<span class="hljs-type">POST</span>、<span class="hljs-type">PUT</span>只要满足了这些都不会进行拦截<br><br>- 修改方法一<br><br>- &gt;```java<br>  &gt;<span class="hljs-meta">@Configuration</span><br>  &gt;public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;<br>  &gt;<span class="hljs-meta">@Bean</span><br>  &gt;<span class="hljs-type">HttpFirewall</span> httpFirewall() &#123;<br><span class="hljs-type">StrictHttpFirewall</span> strictHttpFirewall = <span class="hljs-keyword">new</span> <span class="hljs-type">StrictHttpFirewall</span>();<br><span class="hljs-type">Set</span>&lt;<span class="hljs-type">String</span>&gt; allowedHttpMethods = <span class="hljs-keyword">new</span> <span class="hljs-type">HashSet</span>&lt;&gt;();<br>allowedHttpMethods.add(<span class="hljs-type">HttpMethod</span>.<span class="hljs-type">POST</span>.name());<br>strictHttpFirewall.setAllowedHttpMethods(allowedHttpMethods);<br><span class="hljs-keyword">return</span> strictHttpFirewall;<br>  &gt;&#125;<br>  &gt;<span class="hljs-comment">//省略其他</span><br>  &gt;&#125;<br></code></pre></td></tr></table></figure>
</code></pre>
</blockquote>
</li>
<li><p>重启项目后只能使用post进行提交了</p>
</li>
<li><blockquote>
<pre><code class="java">@Bean
HttpFirewall httpFirewall() &#123;
StrictHttpFirewall strictHttpFirewall = new StrictHttpFirewall();
strictHttpFirewall.setUnsafeAllowAnyHttpMethod(true);
return strictHttpFirewall;
&#125;
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><br> - 这种方式设置为<span class="hljs-keyword">true</span>就代表上面源代码中if分支内的this.allowedHttpMethods为ALLOW_ANY_HTTP_METHOD所以直接不进行过滤<br><br>- rejectedBlacklistedUrls：校验请求中的非法字符。<br><br> - &gt; 包含了分号，即 <span class="hljs-comment">; 、%3b、%3B，则该请求会被拒绝。可以通过setAllowSemicolon方法开启或者关闭这一规则。</span><br>包含了斜杠，即<span class="hljs-variable">%2</span>f、<span class="hljs-variable">%2</span>F，则该请求会被拒绝。可以通过setAllowUrlEncodedSlash方法开启或者关闭这一规则。<br>包含了反斜杠，即\\、<span class="hljs-variable">%5</span><span class="hljs-keyword">c</span>、<span class="hljs-variable">%5</span>C，则该请求会被拒绝。可以通过setAllowBackSlash方法开启或者关闭这一规则。<br>如果请求URL在编码之后包含了<span class="hljs-variable">%25</span>，亦或者在编码之前包含了%，则该请求会被拒绝。可以通过setAllowUrlEncodedPercent方法开启或者关闭这一规则。<br>如果请求URL在URL编码后包含了英文句号<span class="hljs-variable">%2</span>e或者<span class="hljs-variable">%2</span>E，则该请求会被拒绝。可以通过setAllowUrlEncodedPeriod方法开启或者关闭这一规则。<br><br> - 在源代码中有两个层嵌套循环<span class="hljs-punctuation">,</span>第一层遍历所有字符另一层从List中获取相同字符的不同编码<br><br>- rejectedUntrustedHosts：检验主机信息。<br><br> - 用来检验host是否可信<br><br> - &gt;```java<br>   &gt;<span class="hljs-keyword">private</span> void rejectedUntrustedHosts(HttpServletRequest request) &#123;<br>   &gt;String serverName <span class="hljs-operator">=</span> request.getServerName()<span class="hljs-comment">;</span><br>   &gt;if (serverName !<span class="hljs-operator">=</span> <span class="hljs-keyword">null</span> &amp;&amp; <span class="hljs-title">!this.allowedHostnames.test</span>(serverName)) &#123;<br>  throw new RequestRejectedException(<span class="hljs-string">&quot;The request was rejected because the domain &quot;</span> + serverName + <span class="hljs-string">&quot; is untrusted.&quot;</span>)<span class="hljs-comment">;</span><br>   &gt;&#125;<br>   &gt;&#125;<br></code></pre></td></tr></table></figure>

可以看出是验证serverName而后面的test方法默认总是返回true
</code></pre>
</blockquote>
</li>
<li><p>可以使用下面这种方式进行配置</p>
</li>
<li><blockquote>
<p>@Bean<br>HttpFirewall httpFirewall() {<br>   StrictHttpFirewall strictHttpFirewall &#x3D; new StrictHttpFirewall();<br>   strictHttpFirewall.setAllowedHostnames(<br>        (hostname) -&gt; hostname.equalsIgnoreCase(“local.javaboy.org”));<br>   return strictHttpFirewall;<br>}</p>
</blockquote>
</li>
<li><p>这样除了local.javaboy.org以外的host都不会匹配成功</p>
</li>
</ul>
</li>
<li><p>isNormalized：判断参数格式是否合法。</p>
<ul>
<li><p>isNormalized方法主要用来检查请求地址是否规范，什么样的地址就算规范呢？即不包含”.&#x2F;“、”&#x2F;..&#x2F;“以及”&#x2F;.”三种字符。</p>
</li>
<li><blockquote>
<pre><code class="java">private static boolean isNormalized(HttpServletRequest request) &#123;
 if (!isNormalized(request.getRequestURI())) &#123;
     return false;
 &#125; else if (!isNormalized(request.getContextPath())) &#123;
     return false;
 &#125; else if (!isNormalized(request.getServletPath())) &#123;
     return false;
 &#125; else &#123;
     return isNormalized(request.getPathInfo());
 &#125;
&#125;
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><br>通过源码可知分别对URL,ContextPath,ServletPath,PathInfo进行校验<br><br>- containsOnlyPrintableAsciiCharacters：判断请求字符是否合法。<br><br> - ```<span class="hljs-function">java</span><br><span class="hljs-function">   <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title">containsOnlyPrintableAsciiCharacters</span><span class="hljs-params">(<span class="hljs-type">String</span> uri)</span> </span>&#123;<br>       <span class="hljs-type">int</span> length = uri.<span class="hljs-built_in">length</span>();<br>       <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) &#123;<br>           <span class="hljs-type">char</span> c = uri.<span class="hljs-built_in">charAt</span>(i);<br>           <span class="hljs-keyword">if</span> (c &lt; <span class="hljs-string">&#x27;\u0020&#x27;</span> || c &gt; <span class="hljs-string">&#x27;\u007e&#x27;</span>) &#123;<br>               <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>           &#125;<br>       &#125;<br>       <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>   &#125;<br></code></pre></td></tr></table></figure>
</code></pre>
</blockquote>
</li>
<li><p>用于检测是否包含不可打印字符</p>
</li>
</ul>
</li>
</ul>
<p>这就是StrictHttpFirewall中的所有校验规则了。其中前三种，开发者可以通过相关方法调整参数进而调整校验行为，后面两种则不可调整。</p>
<h3 id="漏洞防护"><a href="#漏洞防护" class="headerlink" title="漏洞防护"></a>漏洞防护</h3><h5 id="csrf"><a href="#csrf" class="headerlink" title="csrf"></a>csrf</h5><p>具体演示的介绍csrf就不在这里说了</p>
<p>重点介绍csrf防御和csrf的原理</p>
<p>分为两种：</p>
<h6 id="一个是令牌同步模式："><a href="#一个是令牌同步模式：" class="headerlink" title="一个是令牌同步模式："></a>一个是令牌同步模式：</h6><p>其中GET、HEAD、OPTIONS、TRACE方法不应该改变应用的状态。</p>
<p>该方法时在每次提交时都会带上一个CSRF令牌</p>
<p><strong>创建如下html页面</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;/hello&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">th:value</span>=<span class="hljs-string">&quot;$&#123;_csrf.token&#125;&quot;</span></span><br><span class="hljs-tag">                   <span class="hljs-attr">th:name</span>=<span class="hljs-string">&quot;$&#123;_csrf.parameterName&#125;&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;hello&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>其中引入了thymeleaf,使用${_csrf.parameterName}来从服务端来获取一个csrf令牌</p>
<p>&#x3D;&#x3D;并且配置文件中不能设置csrf().disable()的&#x3D;&#x3D;,前面我们都设置为disable记得要开启,security默认是开启状态的</p>
<p>如果是前后端分离项目,使用的Ajax,可以将令牌存到cookie中</p>
<p>配置文件:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span><br>                                                                <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.inMemoryAuthentication()<br>                .withUser(<span class="hljs-string">&quot;javaboy&quot;</span>)<br>                .password(<span class="hljs-string">&quot;&#123;noop&#125;123&quot;</span>)<br>                .roles(<span class="hljs-string">&quot;admin&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests()<br>                .anyRequest().authenticated()<br>                .and()<br>                .formLogin()<br>                .loginProcessingUrl(<span class="hljs-string">&quot;/login.html&quot;</span>)<br>                .successHandler((req,resp,auth)-&gt;&#123;<br>                    resp.getWriter().write(<span class="hljs-string">&quot;login success&quot;</span>);<br>                &#125;)<br>                .permitAll()<br>                .and()<br>                .csrf()<br>                .csrfTokenRepository(CookieCsrfTokenRepository<br>                                                          .withHttpOnlyFalse());<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>需要注意的是，这里将csrfTokenRepository配置为CookieCsrfTokenRepository，并设置httpOnly属性为false，否则前端将无法读取到Cookie中的CSRF令牌。</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">script</span></span><br><span class="hljs-tag">          <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js&quot;</span>&gt;</span><br>         <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">script</span>     <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/</span></span><br><span class="hljs-string"><span class="hljs-tag">  jquery.cookie.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;username&quot;</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;登录&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;loginBtn&quot;</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">         $(<span class="hljs-string">&quot;#loginBtn&quot;</span>).<span class="hljs-title function_">click</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">             <span class="hljs-keyword">let</span> _csrf = $.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">&#x27;XSRF-TOKEN&#x27;</span>);</span><br><span class="language-javascript">             $.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/login.html&#x27;</span>, &#123;</span><br><span class="language-javascript">                 <span class="hljs-attr">username</span>: $(<span class="hljs-string">&quot;#username&quot;</span>).<span class="hljs-title function_">val</span>(),</span><br><span class="language-javascript">                 <span class="hljs-attr">password</span>: $(<span class="hljs-string">&quot;#password&quot;</span>).<span class="hljs-title function_">val</span>(),</span><br><span class="language-javascript">                 <span class="hljs-attr">_csrf</span>: _csrf</span><br><span class="language-javascript">             &#125;, <span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) &#123;</span><br><span class="language-javascript">                 <span class="hljs-title function_">alert</span>(data);</span><br><span class="language-javascript">             &#125;)</span><br><span class="language-javascript">         &#125;)</span><br><span class="language-javascript">     </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>HTML文件修改结果如上</p>
<h6 id="SameSite"><a href="#SameSite" class="headerlink" title="SameSite"></a>SameSite</h6><p>有三种属性值:</p>
<ul>
<li>Strict:同一站发送的请求才会包含Cookie,不同站发送不会包含Cookie</li>
<li>Lax:同一站点发送的请求或者导航到目标地址的GET请求会自动包含Cookie信息，否则不包含Cookie信息。</li>
<li>None:Cookie将在所有上下文中发送，即允许跨域发送</li>
</ul>
<blockquote>
<p>Strict是一种非常严格的模式，可能会带来不好的用户体验。举一个简单例子：假设用户登录了<a target="_blank" rel="noopener" href="http://www.javaboy.org网站,并保持了登录状态,现在用户在email.qq.com上收到一封电子邮件,电子邮件中有一个超链接指向www.javaboy.org,当用户单击这个超链接,理所应当地携带cookie并自动进行www.javaboy.org站点的身份认证,然而strict会阻止单击超链接时携带cookie,进而造成用户身份认证失败.而lax则稍微友好一些,允许get请求携带cookie./">www.javaboy.org网站，并保持了登录状态，现在用户在email.qq.com上收到一封电子邮件，电子邮件中有一个超链接指向www.javaboy.org，当用户单击这个超链接，理所应当地携带Cookie并自动进行www.javaboy.org站点的身份认证，然而Strict会阻止单击超链接时携带Cookie，进而造成用户身份认证失败。而Lax则稍微友好一些，允许GET请求携带Cookie。</a><br>使用SameSite还有一个需要考虑的因素就是浏览器的兼容性。虽然大部分现代浏览器都支持SameSite属性，但是可能还是存在一些古董级浏览器不支持该属性。所以，如果使用SameSite来处理CSRF攻击，建议作为一个备选方案，而不是主要方案。</p>
</blockquote>
<p>Spring Security对于SameSite并未直接提供支持，但是Spring Session提供了，因此，在使用时，需要首先引入Spring Session和Redis依赖</p>
<p>提供一个CookieSerializer实例即可，并配置SameSite属性值为strict：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> CookieSerializer <span class="hljs-title function_">httpSessionIdResolver</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">DefaultCookieSerializer</span> <span class="hljs-variable">cookieSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultCookieSerializer</span>();<br>    cookieSerializer.setSameSite(<span class="hljs-string">&quot;strict&quot;</span>);<br>    <span class="hljs-keyword">return</span> cookieSerializer;<br>&#125;<br></code></pre></td></tr></table></figure>



<h6 id="可能会出现的问题"><a href="#可能会出现的问题" class="headerlink" title="可能会出现的问题"></a>可能会出现的问题</h6><p>超时问题:</p>
<ul>
<li>如果HttpSession过期会导致csrf令牌无法认证<ul>
<li>可以给httpSession续命</li>
<li>通过js来获取csrf来和表单一起提交</li>
<li>令牌存储在Cookie中而不是HttpSession中</li>
</ul>
</li>
<li>为了保护用户的敏感信息登录和注销最好也采用csrf攻击防护</li>
<li>文件上传<ul>
<li>&#x3D;&#x3D;没看明白啊&#x3D;&#x3D;</li>
</ul>
</li>
</ul>
<p>CsrfToken</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CsrfToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> &#123;<br>	<span class="hljs-comment">//如果在请求体内则获取参数名</span><br>    String <span class="hljs-title function_">getHeaderName</span><span class="hljs-params">()</span>;<br>	<span class="hljs-comment">//当csrf被当作参数传递令牌获取参数名</span><br>    String <span class="hljs-title function_">getParameterName</span><span class="hljs-params">()</span>;<br>	<span class="hljs-comment">//获取token</span><br>    String <span class="hljs-title function_">getToken</span><span class="hljs-params">()</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>有两个实现类</p>
<ul>
<li><p>DefaultCsrfToken:默认的直接创建并实现了三个方法，太帅了这实现😓</p>
<ul>
<li>&#96;&#96;&#96;java<br>public final class DefaultCsrfToken implements CsrfToken {<br>private final String token;<br>private final String parameterName;<br>private final String headerName;<br><br>public DefaultCsrfToken(String headerName, String parameterName, String token) {<br>    Assert.hasLength(headerName, “headerName cannot be null or empty”);<br>    Assert.hasLength(parameterName, “parameterName cannot be null or empty”);<br>    Assert.hasLength(token, “token cannot be null or empty”);<br>    this.headerName &#x3D; headerName;<br>    this.parameterName &#x3D; parameterName;<br>    this.token &#x3D; token;<br>}<br><br>public String getHeaderName() {<br>    return this.headerName;<br>}<br><br>public String getParameterName() {<br>    return this.parameterName;<br>}<br><br>public String getToken() {<br>    return this.token;<br>}<br>}<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><br>- SaveOnAccessCsrfToken:是一个代理类<br><br>  - 只有两个类这个又是代理类...懂得都懂<br><br>  - ```java<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-keyword">class</span> <span class="hljs-title">SaveOnAccessCsrfToken</span> <span class="hljs-title">implements</span> <span class="hljs-title">CsrfToken</span> &#123;<br>        <span class="hljs-keyword">private</span> transient CsrfTokenRepository tokenRepository;<br>        <span class="hljs-keyword">private</span> transient HttpServletRequest request;<br>        <span class="hljs-keyword">private</span> transient HttpServletResponse response;<br>        <span class="hljs-keyword">private</span> final CsrfToken <span class="hljs-built_in">delegate</span>;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getHeaderName</span>()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-built_in">delegate</span>.getHeaderName();<br>        &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getParameterName</span>()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-built_in">delegate</span>.getParameterName();<br>        &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getToken</span>()</span> &#123;<br>            <span class="hljs-keyword">this</span>.saveTokenIfNecessary();<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-built_in">delegate</span>.getToken();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>上面的SaveOnAccessCsrfToken是在LazyCsrfTokenRepository中实现的而他实现的是CsrfTokenRepository接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CsrfTokenRepository</span> &#123;<br>    CsrfToken <span class="hljs-title function_">generateToken</span><span class="hljs-params">(HttpServletRequest var1)</span>;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveToken</span><span class="hljs-params">(CsrfToken var1, HttpServletRequest var2, HttpServletResponse var3)</span>;<br><br>    CsrfToken <span class="hljs-title function_">loadToken</span><span class="hljs-params">(HttpServletRequest var1)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到有三个方法都是操纵令牌的:</p>
<ul>
<li>generateTokensh:生成一个令牌</li>
<li>saveToken:存储一个令牌</li>
<li>loadToken:读取一个令牌</li>
</ul>
<p>它共有三个实现类:</p>
<ul>
<li><p>LazyCsrfTokenRepository:</p>
<ul>
<li><blockquote>
<p>（1）generateToken：在生成CsrfToken时，代理类生成的CsrfToken类型是DefaultCsrfToken，这里将DefaultCsrfToken装饰为SaveOnAccessCsrfToken，当调用SaveOnAccessCsrfToken中的getToken方法时，才会去保存CsrfToken。<br>（2）saveToken：只有当token为null时，才会去执行代理类的saveToken方法（相当于只执行移除CsrfToken操作）。</p>
</blockquote>
</li>
<li><p>用来代理下面的两个类</p>
</li>
</ul>
</li>
<li><p>HttpSessionCsrfTokenRepository:将令牌存到HttpSession中.</p>
<ul>
<li><p>主要看三个实现方法都很简单</p>
</li>
<li><pre><code class="java">public void saveToken(CsrfToken token, HttpServletRequest request, HttpServletResponse response) &#123;
    HttpSession session;
    if (token == null) &#123;
        session = request.getSession(false);
        if (session != null) &#123;
            session.removeAttribute(this.sessionAttributeName);
        &#125;
    &#125; else &#123;
        session = request.getSession();
        session.setAttribute(this.sessionAttributeName, token);
    &#125;

&#125;

public CsrfToken loadToken(HttpServletRequest request) &#123;
    HttpSession session = request.getSession(false);
    return session == null ? null : (CsrfToken)session.getAttribute(this.sessionAttributeName);
&#125;

public CsrfToken generateToken(HttpServletRequest request) &#123;
    return new DefaultCsrfToken(this.headerName, this.parameterName, this.createNewToken());
&#125;
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><br>  - saveToken是判断是否存在session和是否传入token如果不存在token并且session存在则从HttpSession中将token删除,如果token不为空则将token放入HttpSession中<br><br>  - loadToken,查看HttpSession是否存在,存在则取出CsrfToken<br><br>  - generateToken:创建一个DefaultCsrfToken,headerName和parameterName都是默认的,而具体的令牌则是一个UUID字符串。<br><br>- CookieCsrfTokenRepository:将csrf放到Cookie中<br><br>  - ```java<br>    public CsrfToken generate<span class="hljs-constructor">Token(HttpServletRequest <span class="hljs-params">request</span>)</span> &#123;<br>        return <span class="hljs-keyword">new</span> <span class="hljs-constructor">DefaultCsrfToken(<span class="hljs-params">this</span>.<span class="hljs-params">headerName</span>, <span class="hljs-params">this</span>.<span class="hljs-params">parameterName</span>, <span class="hljs-params">this</span>.<span class="hljs-params">createNewToken</span>()</span>);<br>    &#125;<br>    <br>    public void save<span class="hljs-constructor">Token(CsrfToken <span class="hljs-params">token</span>, HttpServletRequest <span class="hljs-params">request</span>, HttpServletResponse <span class="hljs-params">response</span>)</span> &#123;<br>        String tokenValue = token != null ? token.get<span class="hljs-constructor">Token()</span> : <span class="hljs-string">&quot;&quot;</span>;<br>        Cookie cookie = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Cookie(<span class="hljs-params">this</span>.<span class="hljs-params">cookieName</span>, <span class="hljs-params">tokenValue</span>)</span>;<br>        cookie.set<span class="hljs-constructor">Secure(<span class="hljs-params">this</span>.<span class="hljs-params">secure</span> != <span class="hljs-params">null</span> ? <span class="hljs-params">this</span>.<span class="hljs-params">secure</span> : <span class="hljs-params">request</span>.<span class="hljs-params">isSecure</span>()</span>);<br>        cookie.set<span class="hljs-constructor">Path(StringUtils.<span class="hljs-params">hasLength</span>(<span class="hljs-params">this</span>.<span class="hljs-params">cookiePath</span>)</span> ? this.cookiePath : this.get<span class="hljs-constructor">RequestContext(<span class="hljs-params">request</span>)</span>);<br>        cookie.set<span class="hljs-constructor">MaxAge(<span class="hljs-params">token</span> != <span class="hljs-params">null</span> ? <span class="hljs-params">this</span>.<span class="hljs-params">cookieMaxAge</span> : 0)</span>;<br>        cookie.set<span class="hljs-constructor">HttpOnly(<span class="hljs-params">this</span>.<span class="hljs-params">cookieHttpOnly</span>)</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">StringUtils</span>.</span></span>has<span class="hljs-constructor">Length(<span class="hljs-params">this</span>.<span class="hljs-params">cookieDomain</span>)</span>) &#123;<br>            cookie.set<span class="hljs-constructor">Domain(<span class="hljs-params">this</span>.<span class="hljs-params">cookieDomain</span>)</span>;<br>        &#125;<br>    <br>        response.add<span class="hljs-constructor">Cookie(<span class="hljs-params">cookie</span>)</span>;<br>    &#125;<br>    <br>    public CsrfToken load<span class="hljs-constructor">Token(HttpServletRequest <span class="hljs-params">request</span>)</span> &#123;<br>        Cookie cookie = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">WebUtils</span>.</span></span>get<span class="hljs-constructor">Cookie(<span class="hljs-params">request</span>, <span class="hljs-params">this</span>.<span class="hljs-params">cookieName</span>)</span>;<br>        <span class="hljs-keyword">if</span> (cookie<span class="hljs-operator"> == </span>null) &#123;<br>            return null;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            String token = cookie.get<span class="hljs-constructor">Value()</span>;<br>            return !<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">StringUtils</span>.</span></span>has<span class="hljs-constructor">Length(<span class="hljs-params">token</span>)</span> ? null : <span class="hljs-keyword">new</span> <span class="hljs-constructor">DefaultCsrfToken(<span class="hljs-params">this</span>.<span class="hljs-params">headerName</span>, <span class="hljs-params">this</span>.<span class="hljs-params">parameterName</span>, <span class="hljs-params">token</span>)</span>;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>generateToken和HttpSessionCsrfTokenRepository一样</p>
</li>
<li><p>saveToken新建一个Cookie并将token添加到里面</p>
</li>
<li><p>创建CookieCsrfTokenRepository有两种</p>
<ul>
<li>调用静态方法withHttpOnlyFalse,这样httpOnly会被设置为false,js可以获取cookie</li>
<li>调用构造方法来创建这样HttpOnly会被设置为true,js可以获取cookie</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>CsrfFilter</p>
<p>它继承OncePerRequestFilter,而OncePerRequestFilter又继承GenericFilterBean</p>
<p>所以他是SpringSecurity中重要的一环</p>
<p>csrfFilter的核心代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>    request.setAttribute(HttpServletResponse.class.getName(), response);<br>    <span class="hljs-type">CsrfToken</span> <span class="hljs-variable">csrfToken</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.tokenRepository.loadToken(request);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">missingToken</span> <span class="hljs-operator">=</span> csrfToken == <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (missingToken) &#123;<br>        csrfToken = <span class="hljs-built_in">this</span>.tokenRepository.generateToken(request);<br>        <span class="hljs-built_in">this</span>.tokenRepository.saveToken(csrfToken, request, response);<br>    &#125;<br><br>    request.setAttribute(CsrfToken.class.getName(), csrfToken);<br>    request.setAttribute(csrfToken.getParameterName(), csrfToken);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.requireCsrfProtectionMatcher.matches(request)) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isTraceEnabled()) &#123;<br>            <span class="hljs-built_in">this</span>.logger.trace(<span class="hljs-string">&quot;Did not protect against CSRF since request did not match &quot;</span> + <span class="hljs-built_in">this</span>.requireCsrfProtectionMatcher);<br>        &#125;<br><br>        filterChain.doFilter(request, response);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">actualToken</span> <span class="hljs-operator">=</span> request.getHeader(csrfToken.getHeaderName());<br>        <span class="hljs-keyword">if</span> (actualToken == <span class="hljs-literal">null</span>) &#123;<br>            actualToken = request.getParameter(csrfToken.getParameterName());<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!equalsConstantTime(csrfToken.getToken(), actualToken)) &#123;<br>            <span class="hljs-built_in">this</span>.logger.debug(LogMessage.of(() -&gt; &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Invalid CSRF token found for &quot;</span> + UrlUtils.buildFullRequestUrl(request);<br>            &#125;));<br>            <span class="hljs-type">AccessDeniedException</span> <span class="hljs-variable">exception</span> <span class="hljs-operator">=</span> !missingToken ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidCsrfTokenException</span>(csrfToken, actualToken) : <span class="hljs-keyword">new</span> <span class="hljs-title class_">MissingCsrfTokenException</span>(actualToken);<br>            <span class="hljs-built_in">this</span>.accessDeniedHandler.handle(request, response, (AccessDeniedException)exception);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            filterChain.doFilter(request, response);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>加载流程</p>
<blockquote>
<p>（1）首先调用tokenRepository.loadToken方法去加载出CsrfToken对象，默认使用的tokenRepository对象类型是LazyCsrfTokenRepository。<br>（2）如果CsrfToken对象不存在，则立马生成CsrfToken对象并保存起来。需要注意，如果tokenRepository类型是LazyCsrfTokenRepository，则这里并未真正将CsrfToken令牌保存起来。<br>（3）将生成的CsrfToken对象设置到request属性中，这样我们在前端页面中就可以渲染出生成的令牌信息了。<br>（4）调用requireCsrfProtectionMatcher.matches方法进行请求判断，该方法主要是判断当前请求方法是否是GET、HEAD、TRACE以及OPTIONS。我们前面讲过，如果当前请求方法是这四种之一，则请求直接过，不用进行接下来的CSRF令牌校验，这也意味着上一步没有必要进行CsrfToken保存操作。此时使用LazyCsrfTokenRepository的优势就体现出来了，在第2步中生成了CsrfToken令牌，但是没有立即保存，而是到后面调用时才保存。<br>（5）如果请求方法不是GET、HEAD、TRACE以及OPTIONS，则先从请求头中提取出CSRF令牌；请求头没有，则从请求参数中提取出CSRF令牌，将拿到的CSRF令牌和第1步中通过loadToken加载出来的令牌进行比对，判断请求传来的CSRF令牌是否合法。</p>
</blockquote>
<h4 id="请求头"><a href="#请求头" class="headerlink" title="请求头"></a>请求头</h4><p>springsecurity默认的请求头包含：(前三个是缓存有关)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Cache-Control:</span> <span class="hljs-literal">no</span><span class="hljs-string">-cache,</span> <span class="hljs-literal">no</span><span class="hljs-string">-store,</span> <span class="hljs-string">max-age=0,</span> <span class="hljs-string">must-revalidate</span><br><span class="hljs-attr">Pragma:</span> <span class="hljs-literal">no</span><span class="hljs-string">-cache</span><br><span class="hljs-attr">Expires:</span> <span class="hljs-number">0</span><br><span class="hljs-attr">X-Content-Type-Options:</span> <span class="hljs-string">nosniff</span><br><span class="hljs-attr">Strict-Transport-Security:</span> <span class="hljs-string">max-age=31536000</span> <span class="hljs-string">;</span> <span class="hljs-string">includeSubDomains</span><br><span class="hljs-attr">X-Frame-Options:</span> <span class="hljs-string">DENY</span><br><span class="hljs-attr">X-XSS-Protection:</span> <span class="hljs-number">1</span><span class="hljs-string">;</span> <span class="hljs-string">mode=b</span><br></code></pre></td></tr></table></figure>

<p>请求头都是在HeaderWriterFilter中添加的,而它自身又是通过HeadersConfigurer来配置的</p>
<p>重点来看configure方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeadersConfigurer</span>&lt;H <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpSecurityBuilder</span>&lt;H&gt;&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractHttpConfigurer</span>&lt;HeadersConfigurer&lt;H&gt;, H&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(H http)</span> &#123;<br>        <span class="hljs-type">HeaderWriterFilter</span> <span class="hljs-variable">headersFilter</span> <span class="hljs-operator">=</span> createHeaderWriterFilter();<br>        http.addFilter(headersFilter);<br>    &#125;<br>    <span class="hljs-keyword">private</span> HeaderWriterFilter <span class="hljs-title function_">createHeaderWriterFilter</span><span class="hljs-params">()</span> &#123;<br>        List&lt;HeaderWriter&gt; writers = getHeaderWriters();<br>        <span class="hljs-type">HeaderWriterFilter</span> <span class="hljs-variable">headersFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HeaderWriterFilter</span>(writers);<br>        headersFilter = postProcess(headersFilter);<br>        <span class="hljs-keyword">return</span> headersFilter;<br>    &#125;<br>    <span class="hljs-keyword">private</span> List&lt;HeaderWriter&gt; <span class="hljs-title function_">getHeaderWriters</span><span class="hljs-params">()</span> &#123;<br>        List&lt;HeaderWriter&gt; writers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        addIfNotNull(writers, contentTypeOptions.writer);<br>        addIfNotNull(writers, xssProtection.writer);<br>        addIfNotNull(writers, cacheControl.writer);<br>        addIfNotNull(writers, hsts.writer);<br>        addIfNotNull(writers, frameOptions.writer);<br>        addIfNotNull(writers, hpkp.writer);<br>        addIfNotNull(writers, contentSecurityPolicy.writer);<br>        addIfNotNull(writers, referrerPolicy.writer);<br>        addIfNotNull(writers, featurePolicy.writer);<br>        writers.addAll(headerWriters);<br>        <span class="hljs-keyword">return</span> writers;<br>    &#125;<br>    <span class="hljs-keyword">private</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">addIfNotNull</span><span class="hljs-params">(List&lt;T&gt; values, T value)</span> &#123;<br>        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>            values.add(value);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看出configure调用了createHeaderWriterFilter,而他又调用了getHeaderWriters来写入请求头信息,而addIfNotNull判断只要不为空就会将值加入.</p>
<p>默认情况下只有以下不为空</p>
<blockquote>
<p>contentTypeOptions.writer：负责处理X-Content-Type-Options响应头。<br>xssProtection.writer：负责处理X-XSS-Protection响应头。<br>cacheControl.writer：负责处理Cache-Control、Pragma以及Expires响应头。<br>hsts.writer：负责处理Strict-Transport-Security响应头。<br>frameOptions.writer：负责处理X-Frame-Options响应头。</p>
</blockquote>
<h5 id="与缓存相关"><a href="#与缓存相关" class="headerlink" title="与缓存相关"></a>与缓存相关</h5><blockquote>
<p>Cache-Control: no-cache, no-store, max-age&#x3D;0, must-revalidate<br>Pragma: no-cache<br>Expires: 0</p>
</blockquote>
<p>Cache-Control:http1.1中引入的缓存字段</p>
<p>第一个no-cache代表缓存需要认证如果用户需要数据就算有缓存也要发送认证请求,而服务器回去判断是否过期如果没有过期则返回304.第二个代表不进行缓存.第三个代表缓存的有效期,这个有效期并非时间戳而是一个秒数.第四个表示缓存在使用一个陈旧的资源时必须先认证,过期则不再进行使用</p>
<p>Pragma:</p>
<p>和no-cache作用差不多,但是不能完全代替,作用是用来进行兼容http1.0的</p>
<p>Expires:</p>
<p>指定一个日期在指定的日期过期如果为0则代表过期</p>
<p>可以看出上面代表springsecurity默认不开启缓存</p>
<p>如果想让资源进行缓存有两种方式:</p>
<p>不让springsecurity进行过滤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        web.ignoring().antMatchers(<span class="hljs-string">&quot;/hello.html&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>第二种方法</p>
<p>开启缓存功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">http.authorizeRequests()<br>                   .anyRequest().authenticated()<br>                   .and()<br>                   .headers()<br>                   .cacheControl()<br>                   .disable()<br>                   .and()<br>                   .formLogin()<br>                   .and()<br>                   .csrf().disable();<br></code></pre></td></tr></table></figure>



<h5 id="X-Content-Type-Options"><a href="#X-Content-Type-Options" class="headerlink" title="X-Content-Type-Options"></a>X-Content-Type-Options</h5><p>这个代表禁止MIME嗅探,因为以前不会严格检测Content-Type如果缺失或者类型有问题客户端回自动检测,这就可能触发xss攻击</p>
<p>而这个标志就是让客户端直接遵循Content-Type不进行认证</p>
<p>如果想要关闭只需要</p>
<p>.headers().contentTypeOptions().disable()</p>
<h5 id="Strict-Transport-Security"><a href="#Strict-Transport-Security" class="headerlink" title="Strict-Transport-Security"></a>Strict-Transport-Security</h5><p>用来指定客户端只能通过HTTPS来访问不能通过HTTP来访问</p>
<p>Strict-Transport-Security: max-age&#x3D;31536000 ; includeSubDomains</p>
<p>max-age:在多少秒之内只能使用HTTPS来访问</p>
<p>includeSubDomains:这个参数是可选的,表示第一条指令也适用于这个域名</p>
<blockquote>
<p>只在HTTPS中会添加</p>
</blockquote>
<h5 id="X-Frame-Options"><a href="#X-Frame-Options" class="headerlink" title="X-Frame-Options"></a>X-Frame-Options</h5><p>代表是否能够允许在页面中使用<frame>,<iframe>,<embed>,<object>中展示通过请求头保证网站没有嵌入其他网站的节点防止被劫持攻击</object></iframe></p>
<p>X-Frame-Options的取值:</p>
<ul>
<li>deny:不允许frame嵌套,就算相同域名也不可以,默认</li>
<li>sameorigin:相同域名可以在frame中展示</li>
<li>allow-from url:可以获取指定url的frame</li>
</ul>
<p>.headers().frameOptions().sameOrigin();使用这种方式修改,也可以使用disable()来关闭</p>
<h5 id="X-XSS-Protection"><a href="#X-XSS-Protection" class="headerlink" title="X-XSS-Protection"></a>X-XSS-Protection</h5><p>当遇到XSS攻击时停止浏览器的加载一共有四种不同的取值方式:</p>
<p>0代表禁止XSS过滤</p>
<p>1代表启用XSS(浏览器默认的),如果检测到跨站攻击则清除页面缓存</p>
<p>1;mode&#x3D;block遇到XSS攻击浏览器则不会清除而是停止加载</p>
<p>1;report&#x3D;<reporting-URI>表示启用XSS过滤。如果检测到跨站脚本攻击，浏览器将清除页面，并使用CSP report-uri指令的功能发送违规报告（Chrome支持）。</reporting-URI></p>
<h5 id="Content-Security-Policy"><a href="#Content-Security-Policy" class="headerlink" title="Content-Security-Policy"></a>Content-Security-Policy</h5><p>内容安全策略，用于检测和削弱特定的攻击</p>
<p>参数一共有以下几种：</p>
<ul>
<li>default-src ‘self’：默认情况下所有资源只能从当前域中加载。接下来细化的配置会覆盖default-src，没有细化的选项则使用default-src。</li>
<li>script-src ‘self’：表示脚本文件只能从当前域名加载。</li>
<li>object-src ‘none’：表示object标签不加载任何资源。</li>
<li>style-src cdn.javaboy.org：表示只加载来自cdn.javaboy.org的样式表。</li>
<li>img-src *：表示可以从任意地址加载图片。</li>
<li>child-src https：表示必须使用HTTPS来加载frame。</li>
</ul>
<p>想要了解更多可以查看<a target="_blank" rel="noopener" href="https://www.w3.org/TR/CSP2/">https://www.w3.org/TR/CSP2/</a></p>
<p>实现方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">.headers()<br>   .contentSecurityPolicy(<span class="hljs-string">&quot;default-src &#x27;self&#x27;; script-src &#x27;self&#x27;;object-src &#x27;none&#x27;;style-src cdn.javaboy.org; img-src *; child-src https:&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>或者使用报告模式—report-only,如果出现违规行为也不会拦截而是将违规发送给另一个URL</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">.headers()<br>.contentSecurityPolicy(contentSecurityPolicyConfig -&gt; &#123;<br>        contentSecurityPolicyConfig.policyDirectives(<span class="hljs-string">&quot;default-src</span><br><span class="hljs-string">&#x27;self&#x27;; script-src &#x27;self&#x27;; object-src &#x27;none&#x27;;style-src cdn.javaboy.org; img-src *;child-src https:;report-uri http://localhost:8081/report&quot;</span>);<br>contentSecurityPolicyConfig.reportOnly();<br></code></pre></td></tr></table></figure>



<h5 id="Referrer-Policy"><a href="#Referrer-Policy" class="headerlink" title="Referrer-Policy"></a>Referrer-Policy</h5><p>代表从哪里进入到当前页面</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Referrer Policy:</span> <span class="hljs-literal">no</span><span class="hljs-string">-referrer-when-downgrade</span><br></code></pre></td></tr></table></figure>

<p>默认除了从HTTPS发送到HTTP以外都会带上这个</p>
<p>配置方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">.headers()<br>.referrerPolicy()<br>.policy(ReferrerPolicyHeaderWriter.ReferrerPolicy.ORIGIN);<br></code></pre></td></tr></table></figure>

<p>ReferrerPolicy是个枚举类,内的枚举变量有下面这些:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ReferrerPolicy</span> &#123;<br>    NO_REFERRER(<span class="hljs-string">&quot;no-referrer&quot;</span>),<br>    NO_REFERRER_WHEN_DOWNGRADE(<span class="hljs-string">&quot;no-referrer-when-downgrade&quot;</span>),<br>    SAME_ORIGIN(<span class="hljs-string">&quot;same-origin&quot;</span>),<br>    ORIGIN(<span class="hljs-string">&quot;origin&quot;</span>),<br>    STRICT_ORIGIN(<span class="hljs-string">&quot;strict-origin&quot;</span>),<br>    ORIGIN_WHEN_CROSS_ORIGIN(<span class="hljs-string">&quot;origin-when-cross-origin&quot;</span>),<br>    STRICT_ORIGIN_WHEN_CROSS_ORIGIN(<span class="hljs-string">&quot;strict-origin-when-cross-origin&quot;</span>),<br>    UNSAFE_URL(<span class="hljs-string">&quot;unsafe-url&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>origin:总是发送源站信息(源信息仅包含请求协议和域名，不包含其他路径信息，与之相对的是完整的URL)</li>
<li>no-referrer:表示从请求头中移除Referer字段</li>
<li>same-origin:表示链接到同源地址时，发送文件源信息作为引用地址</li>
<li>strict-origin:表示从HTTPS链接到HTTP时不发送源信息，否则发送。</li>
<li>origin-when-cross-origin:表示对于同源请求会发送完整的URL作为引用地址，但是对于非同源请求，则只发送源信息</li>
<li>strict-origin-when-cross-origin:表示对于同源的请求，会发送完整的URL作为引用地址；跨域时，如果是从HTTPS链接到HTTP，则不发送Referer字段，否则发送文件的源信息</li>
<li>unsafe-url:表示无论是同源请求还是非同源请求，都发送完整的URL（移除参数信息之后）作为引用地址</li>
</ul>
<h5 id="Feature-Policy"><a href="#Feature-Policy" class="headerlink" title="Feature-Policy"></a>Feature-Policy</h5><p>提供一种禁用浏览器特性机制</p>
<p>例如想要禁止震动和定位API:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">eature-Policy:</span> <span class="hljs-string">vibrate</span> <span class="hljs-string">&#x27;none&#x27;</span><span class="hljs-string">;</span> <span class="hljs-string">geolocation</span> <span class="hljs-string">&#x27;none&#x27;</span><br></code></pre></td></tr></table></figure>

<p>配置如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">.headers()<br>.featurePolicy(<span class="hljs-string">&quot;vibrate &#x27;none&#x27;; geolocation &#x27;none&#x27;&quot;</span>);<br></code></pre></td></tr></table></figure>



<h5 id="Clear-Site-Data"><a href="#Clear-Site-Data" class="headerlink" title="Clear-Site-Data"></a>Clear-Site-Data</h5><p>多用于退出登录,会将用户的Cookie,cache,storage都注销也可以通过*来清除所有的数据</p>
<p>配置如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">.logout()<br>    .addLogoutHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HeaderWriterLogoutHandler</span>(<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClearSiteDataHeaderWriter</span>(ClearSiteDataHeaderWriter.Directive.ALL)))<br>    .and()<br>    .csrf().disable();<br></code></pre></td></tr></table></figure>



<h3 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h3><p>新建一个项目导入web和security依赖</p>
<p>生成一个HTTPS安全证书</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.security.user.name</span>=<span class="hljs-string">javaboy</span><br><span class="hljs-attr">spring.security.user.password</span>=<span class="hljs-string">123</span><br><span class="hljs-attr">server.port</span>=<span class="hljs-string">8333</span><br></code></pre></td></tr></table></figure>

<p>配置文件如上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TomcatConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    TomcatServletWebServerFactory <span class="hljs-title function_">tomcatServletWebServerFactory</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">TomcatServletWebServerFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span><br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">TomcatServletWebServerFactory</span>();<br>        factory.addAdditionalTomcatConnectors(createTomcatConnector());<br>        <span class="hljs-keyword">return</span> factory;<br>    &#125;<br>    <span class="hljs-keyword">private</span> Connector <span class="hljs-title function_">createTomcatConnector</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Connector</span> <span class="hljs-variable">connector</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span><br>            <span class="hljs-title class_">Connector</span>(<span class="hljs-string">&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</span>);<br>        connector.setScheme(<span class="hljs-string">&quot;http&quot;</span>);<br>        connector.setPort(<span class="hljs-number">8080</span>);<br>        <span class="hljs-keyword">return</span> connector;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>创建一个Connector,让tomcat监听8080端口(因为上面配置完后使用的是HTTPS去监听8333端口并没有HTTP的)</p>
<blockquote>
<p>运行日志显示如下</p>
<p>Tomcat initialized with port(s): 8333 (https) 8080 (http)</p>
</blockquote>
<p>创建&#x2F;http和&#x2F;https请求</p>
<p>设置配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests()<br>            .anyRequest().authenticated()<br>            .and()<br>            .formLogin()<br>            .and()<br>            .requiresChannel()<br>            .antMatchers(<span class="hljs-string">&quot;/https&quot;</span>).requiresSecure()<br>            .antMatchers(<span class="hljs-string">&quot;/http&quot;</span>).requiresInsecure()<br>            .and()<br>            .csrf().disable();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>很明显的能看出requiresSecure()是指明为https而requiresInsecure()是http</p>
<blockquote>
<p>在测试时有一个问题需要注意。如果一开始使用HTTP协议登录，则登录成功访问&#x2F;http、&#x2F;https都没有问题，都会自动进行重定向，但是如果一开始使用了HTTPS协议登录，则在登录成功后，从HTTPS协议重定向到HTTP协议时，会让用户重新登录。出现这一问题的原因在于，如果用户使用HTTPS协议登录，则返回的Cookie中包含了Secure标记（见图9-14），该属性表示该Cookie只可以在安全环境下传输（即HTTPS协议中传输），当从HTTPS重定向到HTTP时，HTTP请求并不会自动携带该Cookie，所以就会让用户重新登录。反之，如果一开始登录使用了HTTP协议，则返回的Cookie中没有Secure标记，该Cookie在HTTPS和HTTP环境下都可以传输，因此可以无缝重定向。同时，由于我们的两个测试地址域名都是localhost，而Cookie是不区分端口号的，如果Cookie名相同，会自动覆盖，并且读取的是相同的数据。所以，当从HTTPS协议重定向到HTTP协议时，浏览器上HTTPS的JSESSIONID还在，但是HTTP协议又用不了该Cookie，就会导致HTTP协议一直登录失败，此时只要清除浏览器缓存即可。</p>
</blockquote>
<h5 id="HTTP认证"><a href="#HTTP认证" class="headerlink" title="HTTP认证"></a>HTTP认证</h5><p>首先是基本认证</p>
<p>配置方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">.httpBasic()<br></code></pre></td></tr></table></figure>

<p>这样就可以对传输的数据进行base64()</p>
<p>这种认证不安全可以使用HTTP摘要</p>
<p>HTTP摘要提供了相应的AuthenticationEntryPoint和Filter但是没有自动化配置,需要手动配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http.authorizeRequests()<br>            .anyRequest().authenticated()<br>            .and()<br>            .csrf().disable()<br>            .exceptionHandling()<br>            .authenticationEntryPoint(digestAuthenticationEntryPoint())<br>            .and()<br>            .addFilter(digestAuthenticationFilter());<br>    &#125;<br>    DigestAuthenticationEntryPoint <span class="hljs-title function_">digestAuthenticationEntryPoint</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">DigestAuthenticationEntryPoint</span> <span class="hljs-variable">entryPoint</span> <span class="hljs-operator">=</span><br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">DigestAuthenticationEntryPoint</span>();<br>        entryPoint.setNonceValiditySeconds(<span class="hljs-number">3600</span>);<br>        entryPoint.setRealmName(<span class="hljs-string">&quot;myrealm&quot;</span>);<br>        entryPoint.setKey(<span class="hljs-string">&quot;javaboy&quot;</span>);<br>        <span class="hljs-keyword">return</span> entryPoint;<br>    &#125;<br>    DigestAuthenticationFilter <span class="hljs-title function_">digestAuthenticationFilter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">DigestAuthenticationFilter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DigestAuthenticationFilter</span>();<br>        filter.setAuthenticationEntryPoint(digestAuthenticationEntryPoint());<br>        filter.setUserDetailsService(userDetailsServiceBean());<br>        <span class="hljs-comment">//filter.setPasswordAlreadyEncoded(true);</span><br>        <span class="hljs-keyword">return</span> filter;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsServiceBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();<br>        manager.createUser(User.withUsername(<span class="hljs-string">&quot;javaboy&quot;</span>)<br>                           .password(<span class="hljs-string">&quot;123&quot;</span>)<br>                           <span class="hljs-comment">//.password(&quot;e7ecfd3f08e6960f154e1ff29079fbd3&quot;)</span><br>                           .roles(<span class="hljs-string">&quot;admin&quot;</span>).build());<br>        <span class="hljs-keyword">return</span> manager;<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> NoOpPasswordEncoder.getInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>由于默认加密编码是关闭的所以要注入NoOpPassword</p>
<p>如果要开启加密把上面的代码取消注释就可以了</p>
<h2 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a>跨域问题</h2><p>最常见的解决跨域问题的方案JSONP(但是只支持GET)</p>
<p>Spring中的三种跨域解决方案:</p>
<ul>
<li><p>@CrossOrigin:</p>
<ul>
<li><blockquote>
<p>具体配置如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br>    <span class="hljs-meta">@CrossOrigin(origins = &quot;http://localhost:8081&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/post&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">post</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello post&quot;</span>;<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure>

<p>参数解析如下:</p>
<p>allowCredentials：浏览器是否应当发送凭证信息，如Cookie。<br>allowedHeaders：请求被允许的请求头字段，<em>表示所有字段。<br>exposedHeaders：哪些响应头可以作为响应的一部分暴露出来。注意，这里只可以一一列举，通配符</em>在这里是无效的。<br>maxAge：预检请求的有效期，有效期内不必再次发送预检请求，默认是1800秒。<br>methods：允许的请求方法，<em>表示允许所有方法。<br>origins：允许的域，</em>表示允许所有域。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>重写WebMvcConfigurerComposite#addCorsMappings方法来实现:</p>
<ul>
<li>&#96;&#96;&#96;java<br>@Configuration<br>  public class WebMvcConfig implements WebMvcConfigurer {<br> @Override<br> public void addCorsMappings(CorsRegistry registry) {<br>     registry.addMapping(“&#x2F;**”)<br>             .allowedMethods(“<em>“)<br>             .allowedOrigins(“</em>“)<br>             .allowedHeaders(“*”)<br>             .allowCredentials(false)<br>             .exposedHeaders(“”)<br>             .maxAge(3600);<br> }<br>  }<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><br>- CorsFilter:<br><br>  - ```java<br>    @Configuration<br>    public <span class="hljs-keyword">class</span> WebMvcConfig &#123;<br>        @Bean<br>        FilterRegistrationBean&lt;CorsFilter&gt; cors<span class="hljs-constructor">Filter()</span> &#123;<br>            FilterRegistrationBean&lt;CorsFilter&gt; registrationBean =<br>                <span class="hljs-keyword">new</span> FilterRegistrationBean&lt;&gt;<span class="hljs-literal">()</span>;<br>            CorsConfiguration corsConfiguration = <span class="hljs-keyword">new</span> <span class="hljs-constructor">CorsConfiguration()</span>;<br>            corsConfiguration.set<span class="hljs-constructor">AllowedHeaders(Arrays.<span class="hljs-params">asList</span>(<span class="hljs-string">&quot;*&quot;</span>)</span>);<br>            corsConfiguration.set<span class="hljs-constructor">AllowedMethods(Arrays.<span class="hljs-params">asList</span>(<span class="hljs-string">&quot;*&quot;</span>)</span>);<br>            corsConfiguration.<br>                set<span class="hljs-constructor">AllowedOrigins(Arrays.<span class="hljs-params">asList</span>(<span class="hljs-string">&quot;http://localhost:8081&quot;</span>)</span>);<br>            corsConfiguration.set<span class="hljs-constructor">MaxAge(3600L)</span>;<br>            UrlBasedCorsConfigurationSource source =<br>                <span class="hljs-keyword">new</span> <span class="hljs-constructor">UrlBasedCorsConfigurationSource()</span>;<br>            source.register<span class="hljs-constructor">CorsConfiguration(<span class="hljs-string">&quot;/**&quot;</span>, <span class="hljs-params">corsConfiguration</span>)</span>;<br>            registrationBean.set<span class="hljs-constructor">Filter(<span class="hljs-params">new</span> CorsFilter(<span class="hljs-params">source</span>)</span>);<br>            registrationBean.set<span class="hljs-constructor">Order(-1)</span>;<br>            return registrationBean;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6/" class="category-chain-item">安全框架</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Java/">#Java</a>
      
        <a href="/tags/SpringSecurity/">#SpringSecurity</a>
      
        <a href="/tags/%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6/">#安全框架</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>SpringSecurity</div>
      <div>http://example.com/2022/01/10/SpringSecurity/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年1月10日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/01/13/Flask%E6%90%AD%E5%BB%BA%E7%BD%91%E7%AB%99/" title="Flask搭建网站">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Flask搭建网站</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/01/10/Vue/" title="Vue">
                        <span class="hidden-mobile">Vue</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.0/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"mPhovhHHyKg2LpAcQhS6tjAw-gzGzoHsz","appKey":"6W2dsSWjVfMOOkXrNbFWOSDN","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"https://mphovhhh.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":true},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
